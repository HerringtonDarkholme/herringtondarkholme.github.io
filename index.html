<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Abitrarily Idiosyncratic Randomness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta name="description" content="„ÅÇ„Åè„Åæ„Åß„ÇÇÁ¥≥Â£´„Åß„Åô">
<meta property="og:type" content="website">
<meta property="og:title" content="Abitrarily Idiosyncratic Randomness">
<meta property="og:url" content="https://herringtondarkholme.github.io/index.html">
<meta property="og:site_name" content="Abitrarily Idiosyncratic Randomness">
<meta property="og:description" content="„ÅÇ„Åè„Åæ„Åß„ÇÇÁ¥≥Â£´„Åß„Åô">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Herrington Darkholme">
<meta name="twitter:card" content="summary"><meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">Abitrarily Idiosyncratic Randomness</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">√ó</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
    
  </nav>
</header>

    <div id="content">
      
  
    <article id="post-benchmarking-napi-parser" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2023/11/25/benchmarking-napi-parser/">Benchmark TypeScript Parsers: Demystify Rust Tooling Performance</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2023-11-25T08:00:00.000Z" itemprop="datePublished">November 25, 2023, 12:00 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h1 id="Benchmark-TypeScript-Parsers-Demystify-Rust-Tooling-Performance"><a href="#Benchmark-TypeScript-Parsers-Demystify-Rust-Tooling-Performance" class="headerlink" title="Benchmark TypeScript Parsers: Demystify Rust Tooling Performance"></a>Benchmark TypeScript Parsers: Demystify Rust Tooling Performance</h1><blockquote>
<p>TL;DR: Native parsers used in JavaScript are not always faster due to extra work across languages. Avoiding these overhead and using multi-core are crucial for performance.</p>
</blockquote>
<p><strong>Rust</strong> is rapidly becoming a language of choice within the JavaScript ecosystem for its performance and safety features. However, integrating Rust into JavaScript tooling presents unique challenges, particularly when it comes to designing an efficient and portable plugin system.</p>
<blockquote>
<p>‚ÄúRewriting JavaScript tooling in Rust is advantageous for speed-focused projects that do not require extensive external contributions.‚Äù - <a target="_blank" rel="noopener" href="https://twitter.com/slicknet/status/1726663311541100626">Nicholas C. Zakas, creator of ESLint</a></p>
</blockquote>
<p>Learning Rust can be daunting due to its steep learning curve, and distributing compiled binaries across different platforms is not straightforward.<br>A Rust based plugins necessitates either static compilation of all plugins or a carefully designed application binary interface for dynamic loading.<br>These considerations, however, are beyond the scope of this article. Instead, we‚Äôll concentrate on how to provide robust tooling for writing plugins in JavaScript.</p>
<p>A critical component of JavaScript tooling is the parsing of source code into an Abstract Syntax Tree (AST). Plugins commonly inspect and manipulate the AST to transform the source code. Therefore, it‚Äôs not sufficient to parse in Rust alone; we must also make the AST accessible to JavaScript.</p>
<p>This post will benchmark several popular TypeScript parsers implemented in JavaScript, Rust, and C.</p>
<h2 id="Parser-Choices"><a href="#Parser-Choices" class="headerlink" title="Parser Choices"></a>Parser Choices</h2><p>While there are numerous JavaScript parsers available, we focus on TypeScript parsers for this benchmark. Modern bundlers must support TypeScript out-of-the-box, and TypeScript is a superset of JavaScript. Benchmarking TypeScript is a sensible choice to emulate the real-world bundler workload.</p>
<p>The parsers we‚Äôre evaluating include:</p>
<ul>
<li><strong><a target="_blank" rel="noopener" href="https://babeljs.io/">Babel</a></strong>: The Babel parser (previously Babylon) is a JavaScript parser used in Babel compiler.</li>
<li><strong><a target="_blank" rel="noopener" href="https://www.typescriptlang.org/">TypeScript</a></strong>: The official parser implementation from the TypeScript team.</li>
<li><strong><a target="_blank" rel="noopener" href="https://tree-sitter.github.io/">Tree-sitter</a></strong>: An incremental parsing library that can build and update concrete syntax trees for source files, aiming to parse any programming language quickly enough for <em>text editor use</em>.</li>
<li><strong><a target="_blank" rel="noopener" href="https://ast-grep.github.io/">ast-grep</a></strong>: A CLI tool for code structural search, lint, and rewriting based on abstract syntax trees. We are using its <a target="_blank" rel="noopener" href="https://github.com/ast-grep/ast-grep/tree/main/crates/napi">napi binding</a> here.</li>
<li><strong><a target="_blank" rel="noopener" href="https://swc.rs/">swc</a></strong>: A super-fast TypeScript&#x2F;JavaScript compiler written in Rust, with a focus on performance and being a library for both Rust and JavaScript users.</li>
<li><strong><a target="_blank" rel="noopener" href="https://oxc-project.github.io/">oxc</a></strong>: The Oxidation Compiler is a suite of high-performance tools for JS&#x2F;TS, claiming to have the fastest and most conformant parser written in Rust.</li>
</ul>
<h2 id="Native-Addon-Performance-Characteristics"><a href="#Native-Addon-Performance-Characteristics" class="headerlink" title="Native Addon Performance Characteristics"></a>Native Addon Performance Characteristics</h2><p>Before diving into the benchmarks, let‚Äôs first review the performance characteristics of Node-API based solutions.</p>
<p><strong>Node-API Pros:</strong></p>
<ul>
<li><strong>Better Compiler Optimization:</strong> Code in native languages have compact data layouts, leading to fewer CPU instructions.</li>
<li><strong>No Garbage Collector Runtime Overhead:</strong> This allows for more predictable performance.</li>
</ul>
<p>However, Node-API is not a silver bullet.</p>
<p><strong>Node-API Cons:</strong></p>
<ul>
<li><strong>FFI Overhead:</strong> The cost of interfacing between different programming languages.</li>
<li><strong>Serde Overhead:</strong> Serialization and deserialization of Rust data structures can be costly.</li>
<li><strong>Encoding Overhead:</strong> Converting JS string in utf-16 to Rust‚Äôs utf-8 string can introduce significant delays.</li>
</ul>
<p>We need to understand the pros and cons of using native node addons in order to design an insightful benchmark.</p>
<h2 id="Benchmark-Design"><a href="#Benchmark-Design" class="headerlink" title="Benchmark Design"></a>Benchmark Design</h2><p>We consider two main factors:</p>
<ol>
<li><p><strong>File Size:</strong> Different file sizes reveal distinct performance characteristics. The parsing time of an N-API based parser consists of actual parsing and cross-language overhead. While parsing time is proportional to file size, the growth of cross-language overhead depends on the parser‚Äôs implementation.</p>
</li>
<li><p><strong>Concurrency Level:</strong> Parallel parsing is not possible in JavaScript‚Äôs single main thread. However, N-API based parsers can run in separate threads, either using libuv‚Äôs thread pool or their own threading model. That said, thread spawning also incurs overhead.</p>
</li>
</ol>
<p>We are not considering these factors in this post.</p>
<ul>
<li><strong>Warmup and JIT:</strong> No significant difference observed between warmup and non-warmup runs.</li>
<li><strong>GC, Memory Usage:</strong> Not evaluated in this benchmark.</li>
<li><strong>Node.js CLI arguments:</strong> To make the benchmark representative, default Node.js arguments were used, although tuning could potentially improve performance.</li>
</ul>
<h2 id="Benchmark-Setup"><a href="#Benchmark-Setup" class="headerlink" title="Benchmark Setup"></a>Benchmark Setup</h2><p>The benchmark code is hosted in ast-grep‚Äôs repo <a target="_blank" rel="noopener" href="https://github.com/ast-grep/ast-grep/blob/main/benches/bench.ts">https://github.com/ast-grep/ast-grep/blob/main/benches/bench.ts</a>.</p>
<h3 id="Testing-Environment"><a href="#Testing-Environment" class="headerlink" title="Testing Environment"></a>Testing Environment</h3><p>The benchmarks were executed on a system equipped with the following specifications:</p>
<ul>
<li><strong>Operating System:</strong> macOS 12.6</li>
<li><strong>Processor:</strong> arm64 Apple M1</li>
<li><strong>Memory:</strong> 16.00 GB</li>
<li><strong>Benchmarking Tool:</strong> <a target="_blank" rel="noopener" href="https://caderek.github.io/benny/">Benny</a></li>
</ul>
<h3 id="File-Size-Categories"><a href="#File-Size-Categories" class="headerlink" title="File Size Categories"></a>File Size Categories</h3><p>To assess parser performance across a variety of codebases, we categorized file sizes as follows:</p>
<ul>
<li><strong>Single Line:</strong> A minimal TypeScript snippet, <code>let a = 123;</code>, to measure baseline overhead.</li>
<li><strong>Small File:</strong> A concise 24-line TypeScript module, representing a common utility file.</li>
<li><strong>Medium File:</strong> A typical 400-line TypeScript file, reflecting average development workloads.</li>
<li><strong>Large File:</strong> The extensive 2.79MB <code>checker.ts</code> from the TypeScript repository, challenging parsers with a complex and sizable codebase.</li>
</ul>
<h3 id="Concurrency-Level"><a href="#Concurrency-Level" class="headerlink" title="Concurrency Level"></a>Concurrency Level</h3><p>For this benchmark, we simulate a realistic workload by parsing five files concurrently. This number is an arbitrary but reasonable proxy to the actual JavaScript tooling.</p>
<p>It‚Äôs worth noting, to seasoned Node.js developers, that this setup may influence asynchronous parsing performance. However it does not disproportionately favor Rust-based parsers. The rationale behind this is left as an exercise for the reader. :)</p>
<hr>
<p>This post aims to provide a general overview of the benchmarking for TypeScript parsers, focusing on the performance characteristics of N-API based solutions and the trade-offs involved. Feel free to adjust the benchmark setup to better fit your workload.</p>
<p>Now, let‚Äôs delve into the results of TypeScript parser benchmarking!</p>
<h2 id="Results"><a href="#Results" class="headerlink" title="Results"></a>Results</h2><p>Raw data can be found in this <a target="_blank" rel="noopener" href="https://docs.google.com/spreadsheets/d/1oIRXDaJ-EnjKz8GKpmUjVwh_FNw4Nsf6mbA0QPCiTh0/edit#gid=0">Google Sheet</a>.</p>
<h3 id="Synchronous-Parsing"><a href="#Synchronous-Parsing" class="headerlink" title="Synchronous Parsing"></a>Synchronous Parsing</h3><p>The performance of each parser is quantified in operations per second‚Äîa metric provided by the Benny benchmarking framework. For ease of comparison, we‚Äôve normalized the results:</p>
<ul>
<li>The fastest parser is designated as the benchmark, set at 100% efficiency.</li>
<li>Other parsers are evaluated relative to this benchmark, with their performance expressed as a percentage of the benchmark‚Äôs speed.</li>
</ul>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/rghu4pqjmutcueudt81s.png" alt="Image description"></p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/qfwhfivek2p0rq3m3paf.png" alt="Image description"></p>
<p>TypeScript consistently outperforms the competition across all file sizes, being twice as fast as Babel.<br>Native language parsers show improved performance for larger files due to the reduced relative impact of FFI overhead.<br>Nevertheless, the performance gains are not as pronounced due to serialization and deserialization (serde) overhead, which is proportional to the input file size.</p>
<h3 id="Asynchronous-Parsing"><a href="#Asynchronous-Parsing" class="headerlink" title="Asynchronous Parsing"></a>Asynchronous Parsing</h3><p>In the asynchronous parsing scenario, we observe the following:</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/xs8ve7oelccjcrh1lbdj.png" alt="Image description"></p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/vnyust8234v4y1vtsm6q.png" alt="Image description"></p>
<p>ast-grep excels when handling multiple medium to large files simultaneously, effectively utilizing multi-core capabilities. TypeScript and Tree-sitter, however, experience a decline in performance with larger files. SWC and Oxc maintain consistent performance, indicating efficient use of multi-core processing.</p>
<h3 id="Parse-Time-Breakdown"><a href="#Parse-Time-Breakdown" class="headerlink" title="Parse Time Breakdown"></a>Parse Time Breakdown</h3><p>When benchmarking a Node-API based program, it‚Äôs crucial to understand the time spent not only executing Rust code but also the Node.js glue code that binds everything together. The parsing time can be dissected into three main components:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">time = ffi_time + parse_time + serde_time</span><br></pre></td></tr></table></figure>

<p>Here‚Äôs a closer look at each term:</p>
<ul>
<li><p><strong><code>ffi_time</code> (Foreign Function Interface Time):</strong> This represents the overhead associated with invoking functions across different programming languages. Typically, <code>ffi_time</code> is a fixed cost and remains constant regardless of the input file size.</p>
</li>
<li><p><strong><code>parse_time</code> (Parse Time):</strong> The core duration required for the parser to analyze the source code and generate an Abstract Syntax Tree (AST). <code>parse_time</code> scales with the size of the input, making it a variable cost in the parsing process.</p>
</li>
<li><p><strong><code>serde_time</code> (Serialization&#x2F;Deserialization Time):</strong> The time needed to serialize Rust data structures into a format compatible with JavaScript, and vice versa. As with <code>parse_time</code>, <code>serde_time</code> increases as the input file size grows.</p>
</li>
</ul>
<p>In essence, benchmarking a parser involves measuring the time for the actual parsing (<code>parse_time</code>) and accounting for the extra overhead from cross-language function calls (<code>ffi_time</code>) and data format conversion (<code>serde_time</code>). Understanding these elements helps us evaluate the efficiency and scalability of the parser in question.</p>
<h3 id="Result-Interpretation"><a href="#Result-Interpretation" class="headerlink" title="Result Interpretation"></a>Result Interpretation</h3><p>This section offers a detailed and technical analysis of the benchmark results based on the parse time framework above. Readers seeking a high-level overview may prefer to skip ahead to the summary.</p>
<p><strong>FFI Overhead</strong></p>
<p>In both sync parsing and async parsing scenario, the ‚Äúone line‚Äù test case, which is predominant FFI overhead with minimal parsing or serialization, shows TypeScript‚Äôs superior performance. Surprisingly, Babel, expected to excel in this one-line scenario, demonstrates its own peculiar overhead.</p>
<p>As file size increases, FFI overhead becomes less significant, as it‚Äôs largely size-independent. For instance, ast-grep‚Äôs relative speed is 78% for a large file compared to 72% for a single line, suggesting an approximate 6% FFI overhead in synchronous parsing.</p>
<p>FFI overhead is more pronounced in asynchronous parsing. ast-grep‚Äôs performance drops from 72% to 60% when comparing synchronous to asynchronous parsing of a single line. The absence of a notable difference in performance for swc&#x2F;oxc may be due to their <a target="_blank" rel="noopener" href="https://github.com/oxc-project/oxc/blob/2d5e0d5d0775300463f36b925e2f1ce71f119b90/napi/parser/src/lib.rs#L96">unique implementation details</a>.</p>
<p><strong>Serde Overhead</strong><br>Unfortunately, we failed to replicate swc&#x2F;oxc‚Äôs blazing performance we witnessed in other applications.<br>Despite minimal FFI impact in ‚ÄúLarge file‚Äù test cases, swc and oxc underperform compared to the TypeScript compiler. This can be attributed to their reliance on calling <a target="_blank" rel="noopener" href="https://github.com/swc-project/swc/blob/5d944185187402691292fdb73ea767bd580e2a52/node-swc/src/index.ts#L108"><code>JSON.parse</code> on strings</a> returned from Rust, which is, to our disappointment, still more efficient than direct data structure returns.</p>
<p>Tree-sitter and ast-grep avoid serde overhead by <a target="_blank" rel="noopener" href="https://github.com/ast-grep/ast-grep/blob/1c3accfd7dccef293c480951759b86c418cde977/crates/napi/src/sg_node.rs#L297">returning a tree object</a> rather than a full AST structure. Accessing tree nodes requires <a target="_blank" rel="noopener" href="https://github.com/ast-grep/ast-grep/blob/1c3accfd7dccef293c480951759b86c418cde977/crates/napi/src/sg_node.rs#L78">invoking Rust methods</a> from JavaScript, which distributes the cost over the reading process.</p>
<p><strong>Parallel</strong></p>
<p>Except tree-sitter, all native TS parsers have parallel support. Contrary to JS parsers, native parsers performance will not degrade when concurrently parsing larger files. This is thanks to the power of multiple cores. JS parsers suffer from CPU bound because they have to parse file one by one.</p>
<h3 id="Perf-summary-for-parsers"><a href="#Perf-summary-for-parsers" class="headerlink" title="Perf summary for parsers"></a>Perf summary for parsers</h3><p>The performance of each parser is summarized in the table below, which outlines the time complexity for different operations.</p>
<p><img src="https://dev-to-uploads.s3.amazonaws.com/uploads/articles/0rm26rv2o0jndzeubxib.png" alt="Image description"></p>
<p>In the table, <code>constant</code> denotes a constant time cost that does not change with input size, while <code>proportional</code> indicates a variable cost that grows proportionally with the input size. An <code>N/A</code> signifies that the cost is not applicable.</p>
<p>JS-based parsers operate entirely within the JavaScript environment, thus avoiding any FFI or serde overhead. Their performance is solely dependent on the parsing time, which scales with the size of the input file.</p>
<p>The performance of Rust-based parsers is influenced by a fixed FFI overhead and a parsing time that grows with input size. However, their serde overhead varies depending on the implementation:</p>
<p>For ast-grep and tree-sitter, they have a fixed serialization cost of one tree object, regardless of the input size.<br>For swc and oxc, the serialization and deserialization costs increase linearly with the input size, impacting overall performance.</p>
<h2 id="Discussion"><a href="#Discussion" class="headerlink" title="Discussion"></a>Discussion</h2><h3 id="Transform-vs-Parse"><a href="#Transform-vs-Parse" class="headerlink" title="Transform vs. Parse"></a>Transform vs. Parse</h3><p>While Rust-based tools are renowned for their speed in transpiling code, our benchmarks reveal a different narrative when it comes to converting code into an AST that‚Äôs usable in JavaScript.<br>This discrepancy highlights a critical consideration for Rust tooling authors: the process of passing Rust data structures to JavaScript is a complex task that can significantly affect performance.<br>It‚Äôs essential to optimize this data exchange to maintain the high efficiency expected from Rust tooling.</p>
<h3 id="Criteria-for-Parser-Inclusion"><a href="#Criteria-for-Parser-Inclusion" class="headerlink" title="Criteria for Parser Inclusion"></a>Criteria for Parser Inclusion</h3><p>In our benchmark, we focused on parsers that offer a JavaScript API, which influenced our selection:</p>
<ul>
<li><strong>Sucrase:</strong> Excluded due to its lack of a parsing API and <a target="_blank" rel="noopener" href="https://github.com/alangpierce/sucrase#motivation">inability to produce a complete AST</a>, which are crucial for our evaluation criteria.</li>
<li><strong>Esbuild&#x2F;Biome:</strong> Not included because esbuild functions primarily as a bundler, not a standalone parser. It offers transformation and build capabilities but <a target="_blank" rel="noopener" href="https://esbuild.github.io/api/#js-details">does not expose an AST</a> to JavaScript. Similarly, biome is a CLI application without a JavaScript API.</li>
<li><strong>Esprima:</strong> Not considered for this benchmark as it lacks TypeScript support, which is a key requirement for the modern JavaScript development ecosystem.</li>
</ul>
<h3 id="JS-Parser-Review"><a href="#JS-Parser-Review" class="headerlink" title="JS Parser Review"></a>JS Parser Review</h3><p><strong>Babel:</strong><br>Babel is divided into two main packages: <code>@babel/core</code> and <code>@babel/parser</code>. It‚Äôs noteworthy that <code>@babel/core</code> exhibits lower performance compared to <code>@babel/parser</code>. This is because the additional entry and hook code that surrounds the parser in the core package. Furthermore, the <code>parseAsync</code> function in Babel core is not genuinely asynchronous; it‚Äôs essentially a synchronous parser method wrapped in an asynchronous function. This wrapper provides extra hooks but does not enhance performance for CPU-intensive tasks due to JavaScript‚Äôs single-threaded nature. In fact, the overhead of managing asynchronous tasks can further burden the performance of <code>@babel/core</code>.</p>
<p><strong>TypeScript:</strong></p>
<p>The parsing capabilities of TypeScript defy the common perception of the TypeScript compiler (TSC) being slow. The benchmark results suggest that the primary bottleneck for TSC is not in parsing but in the subsequent type checking phase.</p>
<h3 id="Native-Parser-Review"><a href="#Native-Parser-Review" class="headerlink" title="Native Parser Review"></a>Native Parser Review</h3><p><strong>SWC:</strong><br>As the first Rust parser to make its mark, SWC adopts a direct approach by serializing the entire AST for use in JavaScript. It stands out for offering a broad range of APIs, making it a top choice for those seeking Rust-based tooling solutions. Despite some inherent overhead, SWC‚Äôs robustness and pioneering status continue to make it a preferred option.</p>
<p><strong>Oxc:</strong>:<br>Oxc is a contender for the title of the fastest parser available, but its performance is tempered by serialization and deserialization (serde) overhead. The inclusion of JSON parsing in our benchmarks reflects real-world usage, although omitting this step could significantly boost Oxc‚Äôs speed.</p>
<p><strong>Tree-sitter</strong><br>Tree-sitter serves as a versatile parser suitable for a variety of languages, not specifically optimized for TypeScript. Consequently, its performance aligns closely with that of Babel, a JavaScript-focused parser implemented in JavaScript. Alas, a Rust parser is not inherently faster by default, even without any N-API overhead.<br>A general purpose parser in Rust may not beat a carefully hand-crafted parser in JavaScript.</p>
<p><strong>ast-grep</strong></p>
<p>ast-grep is powered by tree-sitter. Its performance is marginally faster than tree-sitter, indicating napi.rs is a faster binding than manual using C++ nan.h.<br>I cannot tell whether the performance gain is from napi or napi.rs but<br>Leveraging the capabilities of tree-sitter, ast-grep achieves slightly better performance, suggesting that napi.rs offers a more efficient binding than traditional C++ <a target="_blank" rel="noopener" href="https://github.com/tree-sitter/node-tree-sitter/blob/master/src/parser.h">nan.h</a> methods. While the exact source of this performance gain‚Äîwhether from napi or napi.rs‚Äîis unclear, the results speak to the effectiveness of the implementation. Or put it in another way, <a target="_blank" rel="noopener" href="https://twitter.com/Brooooook_lyn">Broooooklyn</a> is üêê.</p>
<h3 id="Native-Parser-Performance-Tricks"><a href="#Native-Parser-Performance-Tricks" class="headerlink" title="Native Parser Performance Tricks"></a>Native Parser Performance Tricks</h3><p><strong>tree-sitter &amp; ast-grep‚Äô Edge</strong></p>
<p>These parsers manage to bypass serde costs post-parsing by returning a Rust object wrapper to Node.js. This strategy, while efficient, can lead to slower AST access in JavaScript as the cost is amortized over the reading phase.</p>
<p><strong>ast-grep‚Äôs async advantage:</strong></p>
<p>ast-grep‚Äôs performance in concurrent parsing scenarios is largely due to its utilization of multiple <a target="_blank" rel="noopener" href="http://docs.libuv.org/en/v1.x/threadpool.html">libuv threads</a>. By default, the libuv thread pool size is set to four, but there‚Äôs potential to enhance performance further by <a target="_blank" rel="noopener" href="https://dev.to/bleedingcode/increase-node-js-performance-with-libuv-thread-pool-5h10">expanding the thread pool size</a>, thus fully leveraging the available CPU cores.</p>
<h2 id="Future-Outlook"><a href="#Future-Outlook" class="headerlink" title="Future Outlook"></a>Future Outlook</h2><p>As we look to the future, several promising avenues could further refine TypeScript parser performance:</p>
<ul>
<li><p><strong>Minimizing Serde Overhead:</strong> By optimizing serialization and deserialization processes, such as employing Rust object wrappers, we can reduce the performance toll these operations take.</p>
</li>
<li><p><strong>Harnessing Multi-core Capabilities:</strong> Effective utilization of multi-core architectures can lead to substantial gains in parsing speeds, transforming the efficiency of our tooling.</p>
</li>
<li><p><strong>Promoting AST Reusability:</strong> Facilitating the reuse of Abstract Syntax Trees within JavaScript can diminish the frequency of costly parsing operations.</p>
</li>
<li><p><strong>Shifting Workloads to Rust:</strong> The creation of a domain-specific language (DSL) tailored for AST node querying could shift a greater portion of computational work to the Rust side, enhancing overall efficiency.</p>
</li>
</ul>
<p>These potential improvements represent exciting opportunities to push the boundaries of Rust tooling in parsing performance.</p>
<p>Hope this article helps you! We can continue to innovate and deliver even more powerful tools to the developer community!</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-migrate-bevy" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2023/05/17/migrate-bevy/">Migrating Bevy can be easier with (semi-)automation. Here is how.</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2023-05-17T18:45:14.000Z" itemprop="datePublished">May 17, 2023, 11:45 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>Using open source software can be a double-edged sword: We enjoy the latest features and innovations, but we hate frequent and sometimes tedious upgrades.</p>
<p>Bevy is a fast and flexible game engine written in Rust. It aims to provide a modern and modular architecture, notably <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/Entity_component_system">Entity Component System(ECS)</a>, that allows developers to craft rich and interactive experiences.<br>However, the shiny new engine is also an evolving project that periodically introduces breaking changes in its API.<br>Bevy‚Äôs migration guide is comprehensive, but daunting. It is sometimes overwhelmingly long because it covers many topics and scenarios.</p>
<p>In this article, we will show you how to make migration easier by using some command line tools such as <a target="_blank" rel="noopener" href="https://git-scm.com/"><code>git</code></a>, <a target="_blank" rel="noopener" href="https://doc.rust-lang.org/cargo/"><code>cargo</code></a> and <a target="_blank" rel="noopener" href="https://ast-grep.github.io/"><code>ast-grep</code></a>. These tools can help you track the changes, search for specific patterns in your code, and automate API migration. Hope you can migrate your Bevy projects with less hassle and more confidence by following our tips.</p>
<hr>
<p>We will use the utility AI library <a target="_blank" rel="noopener" href="https://github.com/zkat/big-brain">big-brain</a>, the second most starred Bevy project on GitHub, as an example to illustrate bumping Bevy version from 0.9 to 0.10.<br>Upgrading consists of four big steps: <strong>make a clean git branch</strong>, <strong>updating the dependencies</strong>, <strong>running fix commands</strong>, and <strong>fixing failing tests</strong>. And here is a list of commands used in the migration.</p>
<ul>
<li><code>git</code>: Manage code history, keep code snapshot, and help you revert changes if needed.</li>
<li><code>cargo check</code>: Quickly check code for errors and warnings without building it.</li>
<li><code>ast-grep</code>: Search for ASTs in source and automate code rewrite using patterns or expressions.</li>
<li><code>cargo fmt</code>: Format the rewritten code according to Rust style guidelines.</li>
<li><code>cargo test</code>: Run tests in the project and report the results to ensure the program still works.</li>
</ul>
<h1 id="Preparation"><a href="#Preparation" class="headerlink" title="Preparation"></a>Preparation</h1><p>Before we start, we need to make sure that we have the following tools installed: <a target="_blank" rel="noopener" href="https://rustup.rs/">Rust</a>, <a target="_blank" rel="noopener" href="https://git-scm.com/">git</a> and <a target="_blank" rel="noopener" href="https://ast-grep.github.io/">ast-grep</a>.</p>
<p>Compared to the other two tools, ast-grep is lesser-known. In short it can do search and replace based on <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/Abstract_syntax_tree">abstract syntax trees</a>. You can install it via <a target="_blank" rel="noopener" href="https://crates.io/crates/ast-grep"><code>cargo</code></a> or <a target="_blank" rel="noopener" href="https://formulae.brew.sh/formula/ast-grep"><code>brew</code></a>.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">install the binary `sg`/`ast-grep`</span></span><br><span class="line">cargo install ast-grep</span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">or use brew</span></span><br><span class="line">brew install ast-grep</span><br></pre></td></tr></table></figure>

<h3 id="Clone"><a href="#Clone" class="headerlink" title="Clone"></a>Clone</h3><p>The first step is to clone your repository to your local machine. You can use the following command to clone the big-brain project:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> git@github.com:HerringtonDarkholme/big-brain.git</span><br></pre></td></tr></table></figure>

<p>Note that the big-brain project is not the official repository of the game, but a fork that has not updated its dependencies yet. We use this fork for illustration purposes only.</p>
<h3 id="Check-out-a-new-branch"><a href="#Check-out-a-new-branch" class="headerlink" title="Check out a new branch"></a>Check out a new branch</h3><p>Next, you need to create a new branch for the migration. This will allow you to keep track of your changes and revert them if something goes wrong. You can use the following command to create and switch to a new branch called <code>upgrade-bevy</code>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b upgrade-bevy</span><br></pre></td></tr></table></figure>

<blockquote>
<p>Key take away: make sure you have a clean git history and create a new branch for upgrading.</p>
</blockquote>
<h1 id="Update-Dependency"><a href="#Update-Dependency" class="headerlink" title="Update Dependency"></a>Update Dependency</h1><p>Now it‚Äôs time for us to kick off the real migration! First big step is to update dependencies. It can be a little bit tricker than you think because of transitive dependencies.</p>
<h3 id="Update-dependencies"><a href="#Update-dependencies" class="headerlink" title="Update dependencies"></a>Update dependencies</h3><p>Let‚Äôs change the dependency file <code>Cargo.toml</code>. Luckily big-brain has clean dependencies.</p>
<p>Here is the diff:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">diff --git a/Cargo.toml b/Cargo.toml</span></span><br><span class="line"><span class="comment">index c495381..9e99a3b 100644</span></span><br><span class="line"><span class="comment">--- a/Cargo.toml</span></span><br><span class="line"><span class="comment">+++ b/Cargo.toml</span></span><br><span class="line"><span class="meta">@@ -14,11 +14,11 @@</span> homepage = &quot;https://github.com/zkat/big-brain&quot;</span><br><span class="line"> [workspace]</span><br><span class="line"></span><br><span class="line"> [dependencies]</span><br><span class="line"><span class="deletion">-bevy = &#123; version = &quot;0.9.0&quot;, default-features = false &#125;</span></span><br><span class="line"><span class="addition">+bevy = &#123; version = &quot;0.10.0&quot;, default-features = false &#125;</span></span><br><span class="line"> big-brain-derive = &#123; version = &quot;=0.16.0&quot;, path = &quot;./derive&quot; &#125;</span><br><span class="line"></span><br><span class="line"> [dev-dependencies]</span><br><span class="line"><span class="deletion">-bevy = &#123; version = &quot;0.9.0&quot;, default-features = true &#125;</span></span><br><span class="line"><span class="addition">+bevy = &#123; version = &quot;0.10.0&quot;, default-features = true &#125;</span></span><br><span class="line"> rand = &#123; version = &quot;0.8.5&quot;, features = [&quot;small_rng&quot;] &#125;</span><br><span class="line"></span><br><span class="line"> [features]</span><br></pre></td></tr></table></figure>

<h3 id="Update-lock-file"><a href="#Update-lock-file" class="headerlink" title="Update lock-file"></a>Update lock-file</h3><p>After you have updated your dependencies, you need to build a new lock-file that reflects the changes. You can do this by running the following command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo check</span><br></pre></td></tr></table></figure>

<p>This will check your code for errors and generate a new Cargo.lock file that contains the exact versions of your dependencies.</p>
<h3 id="Check-Cargo-lock-return-to-step-3-if-necessary"><a href="#Check-Cargo-lock-return-to-step-3-if-necessary" class="headerlink" title="Check Cargo.lock, return to step 3 if necessary"></a>Check Cargo.lock, return to step 3 if necessary</h3><p>You should inspect your Cargo.lock file to make sure that all your dependencies are compatible and use the same version of Bevy. Bevy is <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/The_Cathedral_and_the_Bazaar">more a bazaar than a cathedral</a>. You may install third-party plugins and extensions from the ecosystem besides the core library. This means that some of these crates may not be updated or compatible with the latest version of Bevy or may have different dependencies themselves, causing errors or unexpected behavior in your code.<br>If you find any inconsistencies, you can go back to step 3 and modify your dependencies accordingly. Repeat this process until your Cargo.lock file is clean and consistent.</p>
<p>A tip here is to search <code>bevy 0.9</code> in the lock file. <code>Cargo.lock</code> will list library with different version numbers.</p>
<p>Fortunately, Bevy is the only dependency in big-brain. So we are good to go now!</p>
<blockquote>
<p>Key take away: take advantage of Cargo.lock to find transitive dependencies that need updating.</p>
</blockquote>
<h1 id="Semi-Automate-Migration"><a href="#Semi-Automate-Migration" class="headerlink" title="(Semi-)Automate Migration"></a>(Semi-)Automate Migration</h1><h2 id="cargo-check-and-ast-grep-rewrite"><a href="#cargo-check-and-ast-grep-rewrite" class="headerlink" title="cargo check and ast-grep --rewrite"></a><code>cargo check</code> and <code>ast-grep --rewrite</code></h2><p>We will use compiler to spot breaking changes and use AST rewrite tool to repeatedly fix these issues.<br>This is a semi-automated process because we need to manually check the results and fix the remaining errors.</p>
<p>The mantra here is to use automation that maximize your productivity. Write codemod that is straightforward to you and fix remaining issues by hand.</p>
<ol>
<li><code>CoreSet</code></li>
</ol>
<p>The first error is quite easy. The compiler outputs the following error.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error[E0432]: unresolved import `CoreStage`</span><br><span class="line"><span class="meta prompt_">   --&gt; </span><span class="language-bash">src/lib.rs:226:13</span></span><br><span class="line">    |</span><br><span class="line">226 |         use CoreStage::*;</span><br><span class="line">    |             ^^^^^^^^^ use of undeclared type `CoreStage`</span><br></pre></td></tr></table></figure>
<p>From <a target="_blank" rel="noopener" href="https://bevyengine.org/learn/migration-guides/0.9-0.10/">migration guide</a>:</p>
<blockquote>
<p>The <code>CoreStage</code> (‚Ä¶ more omitted) enums have been replaced with <code>CoreSet</code> (‚Ä¶ more omitted). The same scheduling guarantees have been preserved.</p>
</blockquote>
<p>So we just need to change the import name. <a target="_blank" rel="noopener" href="https://ast-grep.github.io/guide/introduction.html#introduction">Using ast-grep is trivial here</a>.<br>We need to provide a pattern, <code>-p</code>, for it to search as well as a rewrite string, <code>-r</code> to replace the old API with the new one. The command should be quite self-explanatory.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sg -p &#x27;CoreStage&#x27; -r CoreSet -i</span><br></pre></td></tr></table></figure>

<p>We suggest to add <code>-i</code> flag for <code>--interactive</code> editing. ast-grep will display the changed code diff and ask your decision to accept or not.</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/src/lib.rs</span></span><br><span class="line"><span class="comment">+++ b/src/lib.rs</span></span><br><span class="line"><span class="meta">@@ -223,7 +223,7 @@</span> pub struct BigBrainPlugin;</span><br><span class="line"></span><br><span class="line"> impl Plugin for BigBrainPlugin &#123;</span><br><span class="line">     fn build(&amp;self, app: &amp;mut App) &#123;</span><br><span class="line"><span class="deletion">-        use CoreStage::*;</span></span><br><span class="line"><span class="addition">+        use CoreSet::*;</span></span><br></pre></td></tr></table></figure>


<ol start="2">
<li><code>StageLabel</code></li>
</ol>
<p>Our next error is also easy-peasy.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error: cannot find derive macro `StageLabel` in this scope</span><br><span class="line">   --&gt; src/lib.rs:269:45</span><br><span class="line">    |</span><br><span class="line">269 | #[derive(Clone, Debug, Hash, Eq, PartialEq, StageLabel, Reflect)]</span><br><span class="line">    |</span><br></pre></td></tr></table></figure>

<p>The <a target="_blank" rel="noopener" href="https://bevyengine.org/learn/migration-guides/0.9-0.10/#label-types">doc</a>:</p>
<blockquote>
<p>System labels have been renamed to systems sets and unified with stage labels. The <code>StageLabel</code> trait should be replaced by a system set, using the <code>SystemSet</code> trait as dicussed immediately below.</p>
</blockquote>
<p>The command:</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sg -p <span class="string">&#x27;StageLabel&#x27;</span> -r SystemSet -i</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><code>SystemStage</code></li>
</ol>
<p>The next error is much harder. First, the error complains two breaking changes.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">error[E0599]: no method named `add_stage_after` found for mutable reference `&amp;mut bevy::prelude::App` in the current scope</span><br><span class="line">   --&gt; src/lib.rs:228:13</span><br><span class="line">    |                                                            ‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì‚Üì use of undeclared type `SystemStage`</span><br><span class="line">228 |         app.add_stage_after(First, BigBrainStage::Scorers, SystemStage::parallel());</span><br><span class="line">    |             ^^^^^^^^^^^^^^^ help: there is a method with a similar name: `add_state`</span><br></pre></td></tr></table></figure>

<p>Let‚Äôs see what <a target="_blank" rel="noopener" href="https://bevyengine.org/learn/migration-guides/0.9-0.10/#stages">migration guide</a> said. This time we will give the code example.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// before</span><br><span class="line">app.add_stage_after(CoreStage::Update, AfterUpdate, SystemStage::parallel());</span><br><span class="line"></span><br><span class="line">// after</span><br><span class="line">app.configure_set(</span><br><span class="line">    AfterUpdate</span><br><span class="line">        .after(CoreSet::UpdateFlush)</span><br><span class="line">        .before(CoreSet::PostUpdate),</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p><code>add_stage_after</code> is removed and <code>SystemStage</code> is renamed. We should use <code>configure_set</code> and <code>before</code>&#x2F;<code>after</code> methods.</p>
<p>Let‚Äôs write a command for this code migration.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sg \</span><br><span class="line">  -p <span class="string">&#x27;$APP.add_stage_after($STAGE, $OWN_STAGE, SystemStage::parallel())&#x27;</span> \</span><br><span class="line">  -r <span class="string">&#x27;$APP.configure_set($OWN_STAGE.after($STAGE))&#x27;</span> -i</span><br></pre></td></tr></table></figure>

<p>This pattern deserves some explanation.</p>
<p><code>$STAGE</code> and <code>$OWN_STAGE</code> are <a target="_blank" rel="noopener" href="https://ast-grep.github.io/guide/pattern-syntax.html#meta-variable">meta-variables</a>.</p>
<p>meta-variable is a wildcard expression that can match any single AST node. So we effectively find all <code>add_stage_after</code> call. We can also use meta-variables in the rewrite string and ast-grep will replace them with the captured AST nodes. ast-grep‚Äôs meta-variables are very similar to regular expression‚Äôs dot <code>.</code>, except they are not textual.</p>
<p>However, I found some <code>add_stage_after</code>s are not replaced. Nah, ast-grep is <a target="_blank" rel="noopener" href="https://github.com/ast-grep/ast-grep/issues/374">quite dumb</a> that it cannot handle the optional comma after the last argument. So I used another query with a trailing comma.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sg \</span><br><span class="line">  -p &#x27;app.add_stage_after($STAGE, $OWN_STAGE, SystemStage::parallel(),)&#x27; \</span><br><span class="line">  -r &#x27;app.configure_set($OWN_STAGE.after($STAGE))&#x27; -i</span><br></pre></td></tr></table></figure>

<p>Cool! Now it replaced all <code>add_stage_after</code> calls!</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/src/lib.rs</span></span><br><span class="line"><span class="comment">+++ b/src/lib.rs</span></span><br><span class="line"><span class="meta">@@ -225,7 +225,7 @@</span> impl Plugin for BigBrainPlugin &#123;</span><br><span class="line"><span class="deletion">-        app.add_stage_after(First, BigBrainStage::Scorers, SystemStage::parallel());</span></span><br><span class="line"><span class="addition">+        app.configure_set(BigBrainStage::Scorers.after(First));</span></span><br><span class="line"><span class="meta">@@ -245,7 +245,7 @@</span> impl Plugin for BigBrainPlugin &#123;</span><br><span class="line"><span class="deletion">-        app.add_stage_after(PreUpdate, BigBrainStage::Actions, SystemStage::parallel());</span></span><br><span class="line"><span class="addition">+        app.configure_set(BigBrainStage::Actions.after(PreUpdate));</span></span><br><span class="line"><span class="meta">@@ -253,7 +253,7 @@</span> impl Plugin for BigBrainPlugin &#123;</span><br><span class="line"><span class="deletion">-        app.add_stage_after(Last, BigBrainStage::Cleanup, SystemStage::parallel());</span></span><br><span class="line"><span class="addition">+        app.configure_set(BigBrainStage::Cleanup.after(Last));</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li><code>Stage</code></li>
</ol>
<p>Our next error is about <a target="_blank" rel="noopener" href="https://bevyengine.org/learn/migration-guides/0.9-0.10/#stages"><code>add_system_to_stage</code></a>. The migration guide told us:</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Before:</span></span><br><span class="line">app.<span class="title function_ invoke__">add_system_to_stage</span>(CoreStage::PostUpdate, my_system)</span><br><span class="line"><span class="comment">// After:</span></span><br><span class="line">app.<span class="title function_ invoke__">add_system</span>(my_system.<span class="title function_ invoke__">in_base_set</span>(CoreSet::PostUpdate))</span><br></pre></td></tr></table></figure>

<p>Let‚Äôs also write a pattern for it.</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sg \</span><br><span class="line">  -p <span class="string">&#x27;$APP.add_system_to_stage($STAGE, $SYS)&#x27;</span> \</span><br><span class="line">  -r <span class="string">&#x27;$APP.add_system($SYS.in_base_set($STAGE))&#x27;</span> -i</span><br></pre></td></tr></table></figure>

<p>Example diff:</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/src/lib.rs</span></span><br><span class="line"><span class="comment">+++ b/src/lib.rs</span></span><br><span class="line"><span class="meta">@@ -243,7 +243,7 @@</span> impl Plugin for BigBrainPlugin &#123;</span><br><span class="line"><span class="deletion">-        app.add_system_to_stage(BigBrainStage::Thinkers, thinker::thinker_system);</span></span><br><span class="line"><span class="addition">+        app.add_system(thinker::thinker_system.in_base_set(BigBrainStage::Thinkers));</span></span><br></pre></td></tr></table></figure>



<ol start="5">
<li><code>system_sets</code></li>
</ol>
<p>The next error corresponds to the system_sets in <a target="_blank" rel="noopener" href="https://bevyengine.org/learn/migration-guides/0.9-0.10/#system-sets-bevy-0-9">migration guide</a>.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// Before:</span><br><span class="line">app.add_system_set(</span><br><span class="line">  SystemSet::new()</span><br><span class="line">    .with_system(a)</span><br><span class="line">    .with_system(b)</span><br><span class="line">    .with_run_criteria(my_run_criteria)</span><br><span class="line">);</span><br><span class="line">// After:</span><br><span class="line">app.add_systems((a, b).run_if(my_run_condition));</span><br></pre></td></tr></table></figure>

<p>We need to change <code>SystemSet::new().with_system(a).with_system(b)</code> to <code>(a, b)</code>.<br>Alas, I don‚Äôt know how to write a pattern to fix that. Maybe ast-grep is not strong enough to support this. I just change <code>with_system</code> manually.<br><em>It is still faster than me scratching my head about how to automate everything.</em></p>
<p>Another change is to use <code>add_systems</code> instead of <code>add_system_set</code>. This is a simple pattern!</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sg \</span><br><span class="line">  -p <span class="string">&#x27;$APP.add_system_set_to_stage($STAGE, $SYS,)&#x27;</span> \</span><br><span class="line">  -r <span class="string">&#x27;$APP.add_systems($SYS.in_set($STAGE))&#x27;</span> -i</span><br></pre></td></tr></table></figure>

<p>This should fix <code>system_sets</code>!</p>
<ol start="6">
<li>Last error</li>
</ol>
<p>Our last error is about <code>in_base_set</code>‚Äòs type.</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">error[E0277]: the trait bound `BigBrainStage: BaseSystemSet` is not satisfied</span><br><span class="line"><span class="meta prompt_">   --&gt; </span><span class="language-bash">src/lib.rs:238:60</span></span><br><span class="line">    |</span><br><span class="line">238 |         app.add_system(thinker::thinker_system.in_base_set(BigBrainStage::Thinkers));</span><br><span class="line">    |                                                ----------- ^^^^^^^^^^^^^^^^^^^^^^^ the trait `BaseSystemSet` is not implemented for `BigBrainStage`</span><br><span class="line">    |                                                |</span><br><span class="line">    |                                                required by a bound introduced by this call</span><br><span class="line">    |</span><br><span class="line">    = help: the following other types implement trait `BaseSystemSet`:</span><br><span class="line">              StartupSet</span><br><span class="line">              bevy::prelude::CoreSet</span><br><span class="line">note: required by a bound in `bevy::prelude::IntoSystemConfig::in_base_set`</span><br></pre></td></tr></table></figure>

<p>Okay, <code>BigBrainStage::Thinkers</code> is not a base set in Bevy, so we should change it to <code>in_set</code>.</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="deletion">-        .add_system(one_off_action_system.in_base_set(BigBrainStage::Actions))</span></span><br><span class="line"><span class="addition">+        .add_system(one_off_action_system.in_set(BigBrainStage::Actions))</span></span><br></pre></td></tr></table></figure>

<p><strong>Hoooray! Finally the program compiles! <del>ship it</del> Now let‚Äôs test it.</strong></p>
<blockquote>
<p>Key take away: Automation saves your time! But you don‚Äôt have to automate everything.</p>
</blockquote>
<hr>
<h2 id="cargo-fmt"><a href="#cargo-fmt" class="headerlink" title="cargo fmt"></a>cargo fmt</h2><p>Congrats! You have automated code refactoring! But ast-grep‚Äôs rewrite can be messy and hard to read. Most code-rewriting tool does not support pretty-print, sadly.<br>A simple solution is to run <code>cargo fmt</code> and make the repository neat and tidy.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo fmt</span><br></pre></td></tr></table></figure>

<p>A good practice is to run this command every time after a code rewrite.</p>
<blockquote>
<p>Key take away: Format code rewrite as much as you want.</p>
</blockquote>
<hr>
<h1 id="Test-Our-Refactor"><a href="#Test-Our-Refactor" class="headerlink" title="Test Our Refactor"></a>Test Our Refactor</h1><h2 id="cargo-test"><a href="#cargo-test" class="headerlink" title="cargo test"></a><code>cargo test</code></h2><p>Let‚Äôs use Rust‚Äôs standard test command to verify our changes: <code>cargo test</code>.</p>
<p>Oops. we have one test error, not too bad!</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">running 1 test</span><br><span class="line">test steps ... FAILED</span><br><span class="line"></span><br><span class="line">failures:</span><br><span class="line"></span><br><span class="line">---- steps stdout ----</span><br><span class="line">steps test</span><br><span class="line">thread &#x27;steps&#x27; panicked at &#x27;`&quot;Update&quot;` and `&quot;Cleanup&quot;` have a `before`-`after` relationship (which may be transitive) but share systems.&#x27;</span><br><span class="line">note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</span><br></pre></td></tr></table></figure>

<p>Okay, it complains that <code>Update</code> and <code>Cleanup</code> have a conflicting running order. This is probably caused by <code>configure_set</code>.</p>
<p>I should have caught the bug during diff review but I missed that. It is not too late to change it manually.</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--- a/src/lib.rs</span></span><br><span class="line"><span class="comment">+++ b/src/lib.rs</span></span><br><span class="line"><span class="meta">@@ -225,7 +225,7 @@</span> impl Plugin for BigBrainPlugin &#123;</span><br><span class="line"><span class="deletion">-        app.configure_set(BigBrainStage::Scorers.after(First));</span></span><br><span class="line"><span class="addition">+        app.configure_set(BigBrainStage::Scorers.in_base_set(First));</span></span><br><span class="line"><span class="meta">@@ -242,12 +242,12 @@</span> impl Plugin for BigBrainPlugin &#123;</span><br><span class="line"><span class="deletion">-        app.configure_set(BigBrainStage::Actions.after(PreUpdate));</span></span><br><span class="line"><span class="addition">+        app.configure_set(BigBrainStage::Actions.in_base_set(PreUpdate));</span></span><br></pre></td></tr></table></figure>

<p>Run <code>cargo test</code> again?</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">   Doc-tests big-brain</span><br><span class="line"></span><br><span class="line">failures:</span><br><span class="line"></span><br><span class="line">---- src/lib.rs - (line 127) stdout ----</span><br><span class="line">error[E0599]:</span><br><span class="line">  no method named `add_system_to_stage` found for mutable reference</span><br><span class="line">    `&amp;mut bevy::prelude::App`</span><br><span class="line">  in the current scope</span><br></pre></td></tr></table></figure>

<p>We failed doc-test!</p>
<p>Because our ast based tool does not process comments. Lame. :(<br>We need manually fix them.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">--- a/src/lib.rs</span><br><span class="line">+++ b/src/lib.rs</span><br><span class="line">@@ -137,8 +137,8 @@</span><br><span class="line">-//!         .add_system_to_stage(BigBrainStage::Actions, drink_action_system)</span><br><span class="line">-//!         .add_system_to_stage(BigBrainStage::Scorers, thirsty_scorer_system)</span><br><span class="line">+//!         .add_system(drink_action_system.in_set(BigBrainStage::Actions))</span><br><span class="line">+//!         .add_system(thirsty_scorer_system.in_set(BigBrainStage::Scorers))</span><br></pre></td></tr></table></figure>

<p><strong>Finally we passed all tests!</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">test result: ok. 21 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out; finished in 4.68s</span><br></pre></td></tr></table></figure>

<hr>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>Now we can commit and push our version upgrade to the upstream. It is not a too long battle, is it?</p>
<p>I have created a pull request for reference. <a target="_blank" rel="noopener" href="https://github.com/HerringtonDarkholme/big-brain/pull/1/files">https://github.com/HerringtonDarkholme/big-brain/pull/1/files</a></p>
<p>Reading a long migration guide is not easy, and fixing compiler errors is even harder.</p>
<p>It would be nice if the official guide can contain some automated command to ease the burden. For example, <a target="_blank" rel="noopener" href="https://yew.rs/docs/next/migration-guides/yew/from-0_20_0-to-next">yew.rs</a> did a great job by providing automation in every release note!</p>
<p>To recap our semi-automated refactoring, this is our four steps:</p>
<ul>
<li>Keep a clean git branch for upgrading</li>
<li>Update all dependencies in the project and check lock files.</li>
<li>Compile, Rewrite, Verify and Format. Repeat this process until the project compiles.</li>
<li>Run Test and fix the remaining bugs.</li>
</ul>
<p>I hope this workflow will help you and other programming language developers in the future!</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-server-component" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2023/05/07/server-component/">Grok React Server Component by Quizzes</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2023-05-08T05:26:14.000Z" itemprop="datePublished">May 7, 2023, 10:26 PM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>React Server Component is a new React architecture that the React team introduced at the end of 2020, which enables developers to render components on the server side, thereby boosting performance and streamlining code.</p>
<p>However, this innovation, though already more than two years old, still poses some novel challenges and issues, and many React experts are baffled or perplexed by it.<br>I believe it‚Äôs not only me how are confused by the heated discussion on Twitter and hours long video explaining the new paradigm.<br><a target="_blank" rel="noopener" href="https://twitter.com/dan_abramov">Dan Abramov</a> presented <a target="_blank" rel="noopener" href="https://twitter.com/dan_abramov/status/1648923232937058304">three quizzes</a> about React Server Component, arguably the hottest topic in the React community, to help the audience to understand the new technology better.</p>
<p>This article will analyze the three quizzes that half of the React experts on Twitter didn‚Äôt get it right. I hope this can help you understand the RSC better.</p>
<blockquote>
<p>TLDR: React will render Client Component as a reference to the script on the server side, and Server Component will be streamed and rendered as a JSON-like UI. The references and JSON will be passed to the browser for coordination and view updates.</p>
</blockquote>
<h1 id="The-Three-RSC-Quizzes"><a href="#The-Three-RSC-Quizzes" class="headerlink" title="The Three RSC Quizzes"></a>The Three RSC Quizzes</h1><h2 id="First-Quiz"><a href="#First-Quiz" class="headerlink" title="First Quiz"></a>First Quiz</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Note</span>(<span class="params">&#123; note &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Details</span> <span class="attr">note</span>=<span class="string">&#123;note&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>the <em>only</em> Client Component out of these is Toggle. It has state (<code>isOn</code>, initially false). It returns <code>&lt;&gt;&#123;isOn ? children : null&#125;&lt;/&gt;</code>.</p>
<p>what happens when you <code>setIsOn(true)</code>?</p>
<ul>
<li>Details gets fetched</li>
<li>Details appears instantly</li>
</ul>
<h2 id="Second-Quiz"><a href="#Second-Quiz" class="headerlink" title="Second Quiz"></a>Second Quiz</h2><p>Now say <code>isOn</code> is true. You‚Äôve edited the note and told the router to ‚Äúrefresh‚Äù the route. This refetches the RSC tree for this route, and your <code>Note</code> server component receives a note prop with latest DB content.</p>
<p>(1) does <code>Toggle</code> state get reset?<br>(2) does <code>Details</code> show fresh content?</p>
<ul>
<li>(1) yes and (2) yes</li>
<li>(1) yes and (2) no</li>
<li>(1) no and (2) yes</li>
<li>(1) no and (2) no</li>
</ul>
<h2 id="Third-Quiz"><a href="#Third-Quiz" class="headerlink" title="Third Quiz"></a>Third Quiz</h2><p>Here‚Äôs a little twist.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;<span class="title class_">Layout</span></span><br><span class="line">  left=&#123;<span class="language-xml"><span class="tag">&lt;<span class="name">Sidebar</span> /&gt;</span></span>&#125;</span><br><span class="line">  right=&#123;<span class="language-xml"><span class="tag">&lt;<span class="name">Content</span> /&gt;</span></span>&#125;</span><br><span class="line">/&gt;</span><br></pre></td></tr></table></figure>

<p>All are Server components. But now your want to add a bit of state to <code>Layout</code>, like column width, that changes on mouse drag.</p>
<p>Can you make <code>Layout</code> a Client component? If yes, what happens on drag?</p>
<hr>
<p>I believe some readers who don‚Äôt know RSC may be completely confused after reading these three questions and don‚Äôt understand what they are asking. So at first, we will briefly introduce what is RSC for those who are new here. If you already know the purpose of RSC, you can skip the section safely.</p>
<h1 id="What-is-React-Server-Component"><a href="#What-is-React-Server-Component" class="headerlink" title="What is React Server Component?"></a>What is React Server Component?</h1><p>React Server Component is a special React component that does not run on the browser side, but instead on the server side. So that it can directly access the server‚Äôs data and resources, without obtain them through indirection APIs like REST or GraphQL, etc.</p>
<p>React Server Component is a pattern that can help us reduce the number of network requests and the size of data, thereby improving the page loading speed and user experience. React Server Component can also serve dynamic content to users according to different requests and parameters, without having to recompile or deploy.</p>
<p>The purpose of React Server Component is to let developers build applications that span the server and client, combining the rich interactivity of client-side applications and the optimized performance of traditional server rendering.<br>React Server Component can solve some problems that existing technologies cannot solve or solve well, such as:</p>
<ul>
<li><p>Zero package size: React Server Component‚Äôs code only runs on the server side and will never be downloaded to the client side, so it does not affect the client‚Äôs package size and startup time. The client only receives the rendered results of RSC.</p>
</li>
<li><p>Full access to backend: React Server Component can directly access backend data sources, such as databases, file systems or microservices without additional API endpoints.</p>
</li>
<li><p>Automatic code splitting: React Server Component can dynamically choose which client components to render, so that the client only downloads the necessary code.</p>
</li>
<li><p>No client-server waterfall: React Server Component can load data on the server and pass it as props to client components, thus avoiding the client-server waterfall problem.</p>
</li>
<li><p>Avoid abstraction tax: React Server Component can use native JavaScript syntax and features, such as <code>async</code> and <code>await</code>, without having to use specific libraries or frameworks to implement data fetching or rendering logic.</p>
</li>
</ul>
<h1 id="Server-Component-and-Client-Component"><a href="#Server-Component-and-Client-Component" class="headerlink" title="Server Component and Client Component"></a>Server Component and Client Component</h1><p>Before understanding how RSC works, we must first understand two big concepts in RSC, server-side components (Server Component) and client-side components (Client Component).</p>
<h2 id="Server-Component"><a href="#Server-Component" class="headerlink" title="Server Component"></a>Server Component</h2><p>As the name suggests, server components run only once per request on the server, so they have no state and cannot use features that only exist on the client. Specifically:</p>
<ul>
<li>‚ùå You cannot use state and side effects, because they (conceptually) run only once per request on the server. So <code>useState</code>(), <code>useReducer</code>(), <code>useEffect</code>() and <code>useLayoutEffect</code>() are not supported. You also cannot use custom hooks that depend on state or side effects.</li>
<li>‚ùå You cannot use browser-specific APIs, such as DOM (unless you polyfill them on the server).</li>
<li>‚úÖ You can use <code>async</code>&#x2F;<code>await</code> to access server data sources, such as databases, internal (micro) services, file systems, etc.</li>
<li>‚úÖ You can render other server components, native elements (<code>div</code>, <code>span</code>, etc.) or client components.</li>
</ul>
<p>Developers can also create some custom hooks or libraries designed for the server. All rules for server components apply. For example, a use case for a server hook is to provide some helper functions for accessing server data sources.</p>
<h2 id="Client-Component"><a href="#Client-Component" class="headerlink" title="Client Component"></a>Client Component</h2><p>Client Component is a standard React component. It obeys all the rules we learnt about React before. The new rules to consider are mainly what they can‚Äôt import server components.</p>
<ul>
<li>‚ùå Cannot not import server components or call server hooks&#x2F;libraries, because they only work on the server. However, server components can pass another server component as children to a client component.</li>
<li>‚ùå Cannot not use server-only data sources.</li>
<li>‚úÖ You can use state and side effects, as well as custom React hooks.</li>
<li>‚úÖ You can use browser APIs.</li>
</ul>
<p>Here we need to emphasize the nesting of server components and client components. Although client components cannot directly import server components, they can use server components as children. For example, you can write code like <code>&lt;ClientTabBar&gt;&lt;ServerTabContent/&gt;&lt;/ClientTabBar&gt;</code>. From the perspective of the client component, its child component will be a rendered tree, such as the output of <code>ServerTabContent</code>. This means that server and client components can be nested and interleaved at any level. We will explain this design in later quizzes.</p>
<h1 id="How-RSC-works"><a href="#How-RSC-works" class="headerlink" title="How RSC works?"></a>How RSC works?</h1><p>After understanding server components and client components, we can now start to learn how RSC works. RSC rendering is divided into two major phases: initial loading and view updating. There are also two environments for RSC: server and browser. Note that although server components only <em>run</em> on the server, the browser also needs to be aware of them for actual view creation or updating. Client components are similar.</p>
<h2 id="Initial-loading"><a href="#Initial-loading" class="headerlink" title="Initial loading"></a>Initial loading</h2><h3 id="Server"><a href="#Server" class="headerlink" title="Server"></a>Server</h3><ul>
<li>[Framework] The framework‚Äôs routing matches the requested URL with a server component, passing route parameters as props to the component. Then it calls React to render the component and its props.</li>
<li>[React] React renders the root server component, and recursively renders any child components that are also server components.</li>
<li>[React] Rendering stops at native components (div, span, etc.) and client components. Native components are streamed in a JSON description of the UI, and client components are streamed in a serialized props plus a reference to the component code.</li>
<li>[Framework] The framework is responsible for streaming the rendered output to the client as React renders each UI unit.</li>
</ul>
<p>By default React returns a description of the rendered UI, which is a JSON-like data structure, rather than HTML. Using JSON data will allow new data to be more easily reconciled with existing client components. Of course, frameworks can choose to combine server components with ‚Äúserver-side rendering‚Äù (SSR) so that the initial render is also streamed as HTML, which will speed up the initial non-interactive display of the page.</p>
<p>On the server, if any server component suspends, React will pause rendering that subtree and send client a placeholder value. When the component is able to continue (un<code>suspend</code>), React will re-render the component and stream the actual result of the component to the client. You can think of the data being streamed to the browser as JSON, but with slots for suspended components, where the values for those slots are provided as additional items in the response stream later.</p>
<p>Let‚Äôs dive into the RSC protocol a little bit by looking at an example of rendering a UI description to help us understand this paragraph. Note this paragraph might not be precise and RSC implementation might change in the future.</p>
<p>Suppose we want to render a div.</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">  Hello World</span><br><span class="line">  <span class="tag">&lt;<span class="name">ClientComponent</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>After calling <code>React.createElement</code>, a data structure similar to the following is generated.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$$typeof</span>: <span class="title class_">Symbol</span>(react.<span class="property">element</span>),</span><br><span class="line">  <span class="comment">// element tag</span></span><br><span class="line">  <span class="attr">type</span>: <span class="string">&quot;div&quot;</span>,</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">children</span>: [</span><br><span class="line">      <span class="comment">// static text</span></span><br><span class="line">      <span class="string">&quot;Hello World&quot;</span>,</span><br><span class="line">      <span class="comment">// client compoennt</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">$$typeof</span>: <span class="title class_">Symbol</span>(react.<span class="property">module</span>.<span class="property">reference</span>),</span><br><span class="line">        <span class="attr">type</span>: &#123;</span><br><span class="line">          <span class="attr">name</span>: <span class="string">&quot;ClientComponent&quot;</span>,</span><br><span class="line">          <span class="attr">filename</span>: <span class="string">&quot;./src/ClientComponent.js&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This data structure will be streamed to browser, in format like this:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sever Component Ouptut</span></span><br><span class="line">[<span class="string">&quot;$&quot;</span>,<span class="string">&quot;div&quot;</span>,<span class="literal">null</span>,&#123;<span class="string">&quot;children&quot;</span>:[<span class="string">&quot;Hello World&quot;</span>, [<span class="string">&quot;$&quot;</span>,<span class="string">&quot;$L1&quot;</span>,<span class="literal">null</span>,&#123;&#125;]]&#125;]</span><br><span class="line"><span class="comment">// Client Component Reference</span></span><br><span class="line"><span class="number">1</span>:I&#123;<span class="string">&quot;id&quot;</span>:<span class="string">&quot;./src/ClientComponent.js&quot;</span>,<span class="string">&quot;chunks&quot;</span>:[<span class="string">&quot;client1&quot;</span>],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;ClientComponent&quot;</span>,<span class="string">&quot;async&quot;</span>:<span class="literal">false</span>&#125;</span><br></pre></td></tr></table></figure>

<p>The first array represents the output of a Server Component, and you can see that its output is similar to React‚Äôs data structure, except that the structure is not an object but an array.<br>The array element <code>$</code> represents <code>createElement</code>, and the following element <code>&#123;children: xxx&#125;</code> represents props. In children, the first child is directly transmitted with a string. <code>L1</code> is a placeholder, and the <code>1</code> in <code>1:I</code> below corresponds to it, and <code>1:I</code>‚Äôs data will be filled into <code>L1</code>‚Äòs position.</p>
<p>You might be curious about what does the <code>I</code> mean. In <a target="_blank" rel="noopener" href="https://github.com/facebook/react/blob/main/packages/react-server-dom-relay/src/ReactFlightDOMRelayProtocol.js#L21-L36">react server component‚Äôs protocol</a>, <code>I</code> represents <code>ClientReferenceMetadata</code>, a data structure helping browser to find the correct script entry to the client component.<br><code>1:I</code>‚Äôs output is a reference to a client component, which contains the script name, chunk name and export name, for the browser runtime (such as webpack) to dynamically import client component code. This structure is the streaming structure mentioned above.</p>
<p>In summary, a Server Component will be rendered into a JSON-like data that represents UI, while client components will be converted into a JSON data that expresses script references.</p>
<h2 id="Browser"><a href="#Browser" class="headerlink" title="Browser"></a>Browser</h2><ul>
<li>[Framework] On the client side, the framework receives the streaming React response and uses React to render it on the page</li>
<li>[React] React deserializes the response and renders native elements and client components.</li>
<li>[React] Once all client components and all server component outputs have been loaded, the final UI state will be displayed to the user. By then all Suspense boundaries have been revealed.</li>
</ul>
<p>Note that browser rendering is gradual. React does not need to wait for the entire stream to complete before displaying some content. Suspense allows developers to display meaningful loading states while loading client component code and server components are fetching remaining data.</p>
<h2 id="View-Updating"><a href="#View-Updating" class="headerlink" title="View Updating"></a>View Updating</h2><p>Server components also support reloading to see the latest data. Note that developers do not fetch server components individually: one component by one request.<br>The idea is that given some starting server components and props, the entire subtree will be refetched at once. As with initial loading, this typically involves integration with routing and script bundling:</p>
<h3 id="On-Browser"><a href="#On-Browser" class="headerlink" title="On Browser"></a>On Browser</h3><ul>
<li>[App] When the application changes state or changes routes, it requests the server to refetch the new UI for the changed Server Component.</li>
<li>[Framework] The framework coordinates sending the new route and props to the appropriate API endpoint, requesting the rendering result.</li>
</ul>
<h3 id="On-Server"><a href="#On-Server" class="headerlink" title="On Server"></a>On Server</h3><ul>
<li>[Framework] The interface receives the request and matches it with the requested server component. And it calls React to render the component and props, and handles the streaming of the rendering result.</li>
<li>[React] React renders the component to the destination, with different rendering strategies for components and initial loading.</li>
<li>[Framework] The framework is responsible for gradually returning the streaming response data to the client.</li>
</ul>
<h3 id="On-Browser-1"><a href="#On-Browser-1" class="headerlink" title="On Browser"></a>On Browser</h3><ul>
<li>[Framework] The framework receives the streaming response and triggers a rerender of the route with the new rendering output.</li>
<li>[React] React reconciles the new rendering output with the existing components on the screen. Because the description of UI is data, not HTML, React can merge new props into existing components, preserving important UI state such as focus or input input, or triggering CSS transitions on top of existing content. This is a key reason why server components return UI output as data (‚Äúvirtual DOM‚Äù) rather than HTML.</li>
</ul>
<h2 id="Summary-So-Far‚Ä¶"><a href="#Summary-So-Far‚Ä¶" class="headerlink" title="Summary So Far‚Ä¶"></a>Summary So Far‚Ä¶</h2><p>This section is very long, but we can summarize the working principle of RSC in one sentence.</p>
<p>Client Component will be rendered into a script reference, Server Component will be streamed into a JSON-like UI, Server Component with <code>async</code>&#x2F;<code>await</code> will be replaced by a placeholder first, and then streamed to the browser after resolving.</p>
<p>The table below has more details and principles analysis.</p>
<table>
<thead>
<tr>
<th>Phase</th>
<th>Platform</th>
<th>ServerComponent</th>
<th>ClientComponent</th>
</tr>
</thead>
<tbody><tr>
<td>Initial Load</td>
<td>Server</td>
<td>Run, transformed into JSON UI</td>
<td>Do not run, passed as script reference</td>
</tr>
<tr>
<td>Initial Load</td>
<td>Browser</td>
<td>Do not run, mutating dom by JSON UI</td>
<td>Run, resolving script reference and mutating dom</td>
</tr>
<tr>
<td>View Update</td>
<td>Browser</td>
<td>Do not run, requesting server for new JSON UI</td>
<td>Run, updating client state</td>
</tr>
<tr>
<td>View Update</td>
<td>Server</td>
<td>Run, transformed into new JSON accroding to props and routing</td>
<td>Do not run</td>
</tr>
<tr>
<td>View Update</td>
<td>Browser</td>
<td>Do not run, updating dom by new JSON UI</td>
<td>Run, reconciling client state and RSC to dom</td>
</tr>
</tbody></table>
<h1 id="Three-Quizzes-Three-Features"><a href="#Three-Quizzes-Three-Features" class="headerlink" title="Three Quizzes, Three Features"></a>Three Quizzes, Three Features</h1><p>Now let‚Äôs see how the above rendering process is applied in the RSC quizzes?</p>
<p>This article will combine these three questions to explain the three major features of RSC: rendering completeness, state consistency, and commutative client&#x2F;server component.</p>
<h2 id="Rendering-Completeness"><a href="#Rendering-Completeness" class="headerlink" title="Rendering Completeness"></a>Rendering Completeness</h2><p>The first quiz:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">Note</span>(<span class="params">&#123; note &#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">Details</span> <span class="attr">note</span>=<span class="string">&#123;note&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">Toggle</span>&gt;</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let‚Äôs write some more components to provide context for this question. Our <code>Toggle</code> component and <code>Details</code> component looks like this:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Toggle</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [isOn, setIsOn] = <span class="title function_">useState</span>(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">button</span> <span class="attr">onClick</span>=<span class="string">&#123;()</span> =&gt;</span> setIsOn(on =&gt; !on)&#125;&gt;Toggle<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;isOn ? &quot;on&quot; : &quot;off&quot;&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;isOn ? props.children : <span class="tag">&lt;<span class="name">p</span>&gt;</span>not showing children<span class="tag">&lt;/<span class="name">p</span>&gt;</span>&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">Details</span>(<span class="params">props</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> details = <span class="keyword">await</span> <span class="title function_">getDetails</span>(props.<span class="property">note</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span>&#123;details&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">async</span> <span class="keyword">function</span> <span class="title function_">getDetails</span>(<span class="params">note: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">  <span class="keyword">await</span> <span class="keyword">new</span> <span class="title class_">Promise</span>(<span class="function">(<span class="params">resolve</span>) =&gt;</span> <span class="built_in">setTimeout</span>(resolve, <span class="number">2000</span>));</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`Details for <span class="subst">$&#123;note&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In this example, <code>Note</code> and <code>Details</code> are server-side components. <code>Toggle</code> is a client-side component, but its children <code>Details</code> appears directly under the server-side component &#96;Note. So when rendering Note, it will roughly be rendered into</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">$$typeof</span>: <span class="title class_">Symbol</span>(react.<span class="property">element</span>),</span><br><span class="line">  <span class="attr">type</span>: &#123;</span><br><span class="line">    <span class="attr">$$typeof</span>: <span class="title class_">Symbol</span>(react.<span class="property">module</span>.<span class="property">reference</span>),</span><br><span class="line">    <span class="attr">name</span>: <span class="string">&quot;default&quot;</span>,</span><br><span class="line">    <span class="attr">filename</span>: <span class="string">&quot;./Toggle.js&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">props</span>: &#123; <span class="attr">children</span>: [</span><br><span class="line">   <span class="comment">// children, note the</span></span><br><span class="line">   &#123;</span><br><span class="line">      <span class="attr">$$typeof</span>: <span class="title class_">Symbol</span>(react.<span class="property">element</span>),</span><br><span class="line">      <span class="attr">type</span>: <span class="title class_">Details</span>,  <span class="comment">// Details is rendered!</span></span><br><span class="line">      <span class="attr">props</span>: &#123; <span class="attr">note</span>: note &#125;,</span><br><span class="line">   &#125;</span><br><span class="line">  ] &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Notice that <code>Details</code> is always rendered on the server side and delivered to the client.</p>
<p>When <code>Toggle</code> is rendered on the client side, <code>Details</code> is not used, but its rendering result is still sent to the client side.</p>
<p>Even though <code>Details</code> is an asynchronous server component that uses <code>async</code>&#x2F;<code>await</code>, it can still be sent to the front-end after it finishes asynchronously due to the streaming process of React Server Component.</p>
<p>And when the user changes state, the client can directly use the server‚Äôs pre-rendered results for dom operations because <code>Details</code> props are the same as those rendered by the server. Therefore, the answer to this question is that Details will appear immediately.</p>
<p><strong>This question reveals the ‚Äúcompleteness‚Äù of React Server Component: as long as the component appears under the render function of the server-side component, it will be rendered regardless of its usage in client side.</strong></p>
<h2 id="State-Consistency"><a href="#State-Consistency" class="headerlink" title="State Consistency"></a>State Consistency</h2><blockquote>
<p>Now assume that isOn is <code>true</code>. You edit the note and tell the router to ‚Äúrefresh‚Äù the route. This will re-fetch the RSC tree for this route, and your <code>Note</code> server component will receive a <code>note</code> attribute with the latest database content.</p>
</blockquote>
<p>The second question reveals the consistency of the RSC. When the <code>Toggle</code> component changes props on the client side, this change is synchronized between both the server-side component and the client-side component and remains consistent on both ends.<br><code>&lt;Details note=&#123;note&#125; /&gt;</code> When a <code>note</code> changes, React detects the change in the note and sends a request to the server for the new <code>Details</code> rendering data.</p>
<p>Also, the state of the client component <code>Toggle</code> itself is not reset or lost in the browser.</p>
<p><strong>Thus, the design of RSC ensures that the state of the application is consistent across both server and browser.</strong></p>
<h2 id="3-Commutative-Client-x2F-Server-Component"><a href="#3-Commutative-Client-x2F-Server-Component" class="headerlink" title="3. Commutative Client&#x2F;Server Component"></a>3. Commutative Client&#x2F;Server Component</h2><p>For the third question, let‚Äôs expand the question code for context as well.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">App</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">Layout</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">      <span class="attr">left</span>=<span class="string">&#123;</span>&lt;<span class="attr">Sidebar</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">      right=&#123;<span class="tag">&lt;<span class="name">Content</span> /&gt;</span>&#125;</span></span><br><span class="line"><span class="language-xml">    /&gt;</span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Layout</code> component is a server component.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Server Component</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Layout</span>(<span class="params">props: &#123;</span></span><br><span class="line"><span class="params">  left: React.ReactNode</span></span><br><span class="line"><span class="params">  right: React.ReactNode</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> `$&#123;<span class="attr">width</span>&#125;<span class="attr">px</span>` &#125;&#125;&gt;</span>&#123;props.left&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> `$&#123;<span class="attr">500</span> <span class="attr">-</span> <span class="attr">width</span>&#125;<span class="attr">px</span>` &#125;&#125;&gt;</span>&#123;props.right&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Let‚Äôs rewrite it to a client component that <code>useState</code>. In this example, the width is changed on the client side by changing the input slider. (The implementation detail is inconsequential here).</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;use client&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">&quot;react&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">function</span> <span class="title function_">Layout</span>(<span class="params">props: &#123;</span></span><br><span class="line"><span class="params">  left: React.ReactNode</span></span><br><span class="line"><span class="params">  right: React.ReactNode</span></span><br><span class="line"><span class="params">&#125;</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> [width, setWidth] = <span class="title function_">useState</span>(<span class="number">200</span>)</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    <span class="language-xml"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">input</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">type</span>=<span class="string">&quot;range&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">step</span>=<span class="string">&#123;1&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">value</span>=<span class="string">&#123;width&#125;</span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml">        <span class="attr">onChange</span>=<span class="string">&#123;(e)</span> =&gt;</span> setWidth(Number(e.target.value))&#125;</span></span><br><span class="line"><span class="language-xml">      /&gt;</span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> `$&#123;<span class="attr">width</span>&#125;<span class="attr">px</span>` &#125;&#125;&gt;</span>&#123;props.left&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">        <span class="tag">&lt;<span class="name">div</span> <span class="attr">style</span>=<span class="string">&#123;&#123;</span> <span class="attr">width:</span> `$&#123;<span class="attr">500</span> <span class="attr">-</span> <span class="attr">width</span>&#125;<span class="attr">px</span>` &#125;&#125;&gt;</span>&#123;props.right&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note, in this case we can change the <code>Layout</code> from server component to client component without the <code>App</code> component.<br>The only thing changed is how the <code>App</code> is rendered on server side.</p>
<figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"> &#123;</span><br><span class="line">   $$typeof: Symbol(react.element),</span><br><span class="line"><span class="deletion">-  type: Layout,</span></span><br><span class="line"><span class="addition">+  type: &#123;</span></span><br><span class="line"><span class="addition">+    $$typeof: Symbol(react.module.reference),</span></span><br><span class="line"><span class="addition">+    name: &quot;default&quot;,</span></span><br><span class="line"><span class="addition">+    filename: &quot;./Layout.js&quot;</span></span><br><span class="line"><span class="addition">+  &#125;,</span></span><br><span class="line">   props: &#123;</span><br><span class="line">    left: &#123;</span><br><span class="line">       $$typeof: Symbol(react.element),</span><br><span class="line">       type: Sidebar,</span><br><span class="line">    &#125;,</span><br><span class="line">    right: &#123;</span><br><span class="line">       $$typeof: Symbol(react.element),</span><br><span class="line">       type: Content,</span><br><span class="line">    &#125;</span><br><span class="line">   &#125;,</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<p>As you can see, during serialization, the Layout is transformed from a server-side component to a client-side component. The <code>type</code> field is change from a direct import of Layout component to a <code>module.reference</code>. Meanwhile its child components remain unchanged.</p>
<p>Before we change <code>Layout</code> to client component, the process of rendering <code>Layout</code> happens completely on the server side, and its children are also rendered on the server side. The rendered results are sent to the browser to be transformed into DOM.</p>
<p>After we change <code>Layout</code> to a client component, the process of rendering <code>Layout</code> happens in the browser, but the child components are still rendered on the server side. When the browser renders the server‚Äôs JSON UI output, <code>Layout</code> inserts the results of the server-side child components into the browser DOM.</p>
<p>Since the props of the child components are not changed when user changes the layout width on client-side (because they have no props), so the rendering result on the server side does not need to be recaptured.</p>
<p>Therefore, the answer to this question is ‚Äúit can be converted to a client-side component and the child components will not be recaptured‚Äù.</p>
<p><strong>We can rewrite server-side components as client-side components in RSC projects without rewriting component composition at use site. We can call this interchangeability as ‚Äúcommutative‚Äù server&#x2F;client components.</strong></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>The documentation and RFC for React Server Component is relatively obscure and does not give practical examples, leading many people to wonder what it really is.</p>
<p>In this article, I tried to explain the design ideas and principles of React Server Component by explaining it with Dan‚Äôs quizzes.<br>I hope it can help you understand this new feature and become one of the few materials that can let you learn RSC without watching Youtube or following Twitter threads. I hope this will let you understand more about the principle of RSC and the three performance characteristics! Complete Rendering, Consistent State, and Commutative Server&#x2F;Client Components.</p>
<p>It is not easy to create, if you think this article is helpful to you, please follow me on <a target="_blank" rel="noopener" href="https://medium.com/@hchan_nvim">Medium</a> or <a target="_blank" rel="noopener" href="https://github.com/sponsors/HerringtonDarkholme/">treat me a cup of coffee</a>.</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ol>
<li>React 18: React Server Components | Next.js. <a target="_blank" rel="noopener" href="https://nextjs.org/docs/advanced-features/react-18/server-components">https://nextjs.org/docs/advanced-features/react-18/server-components</a>.</li>
<li>What you need to know about React Server Components. <a target="_blank" rel="noopener" href="https://blog.logrocket.com/what-you-need-to-know-about-react-server-components/">https://blog.logrocket.com/what-you-need-to-know-about-react-server-components/</a>.</li>
<li>React Server Components. - It‚Äôs not server-side rendering. | by Nathan ‚Ä¶. <a target="_blank" rel="noopener" href="https://blog.bitsrc.io/react-server-components-1ca621ac2519">https://blog.bitsrc.io/react-server-components-1ca621ac2519</a>.</li>
<li>What are React Server Components? - FreeCodecamp. <a target="_blank" rel="noopener" href="https://www.freecodecamp.org/news/what-are-react-server-components/">https://www.freecodecamp.org/news/what-are-react-server-components/</a>.</li>
<li>How React Server Compoents Wors. <a target="_blank" rel="noopener" href="https://www.plasmic.app/blog/how-react-server-components-work#the-high-level-picture">https://www.plasmic.app/blog/how-react-server-components-work#the-high-level-picture</a></li>
<li>45% failed Dan‚Äôs Server Component Quiz <a target="_blank" rel="noopener" href="https://www.youtube.com/watch?v=AGAax7WzStc">https://www.youtube.com/watch?v=AGAax7WzStc</a></li>
</ol>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-typescript-magic" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2023/04/30/typescript-magic/">Into the Chamber of Secrets, Break through the limits of TypeScript</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2023-05-01T05:26:14.000Z" itemprop="datePublished">April 30, 2023, 10:26 PM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <blockquote>
<p>This is a rewrite of the <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/613266541">zhihu article</a>. Permission has been granted.<br><em>The original author of this article is finding a job, <a target="_blank" rel="noopener" href="https://github.com/fightingcat">find him on GitHub</a>.</em></p>
</blockquote>
<h1 id="What‚Äôs-Type-level-programming-a-k-a-type-gymnastics"><a href="#What‚Äôs-Type-level-programming-a-k-a-type-gymnastics" class="headerlink" title="What‚Äôs Type level programming, a.k.a type gymnastics?"></a>What‚Äôs Type level programming, a.k.a type gymnastics?</h1><p>TypeScript is a powerful and expressive language that allows you to write complex yet elegant code. Some TypeScript users love to explore the possibilities of the type system and love to encode logic at type level.<br>This practice, as we have a slang for it, is known as <em>type gymnastics</em>. Type gymnastics can help you to perform various tasks such as parsing, validating, transforming, or computing values based on types. Type gymnastics often requires the users mastering a wide range of advanced TypeScript features such as conditional types, recursive types, template literal types, mapped types and more. The community also helps users to learn type gymnastics by creating fun and challenges such as <a target="_blank" rel="noopener" href="https://tsch.js.org/">type challenges</a>.</p>
<p>You can proudly call yourself a TypeScript magician if you can solve most of the type challenges!</p>
<p>The type-level programming community has been creating all kinds of amazing tricks ever since the introduction of template literal type in version 4.1. Some enthusiasts have pushed this hobby to the extreme, and even tried to reimplement TypeScript at compile-time using pure types!</p>
<p>However, there are still three major obstacles that prevent TypeScript becoming a true <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/issues/14833">turing complete machine (#14833)</a>. They are:</p>
<ul>
<li>tail recursion count: the maximum number of recursive calls in a conditional type.</li>
<li>type instantiation depth: the maximum depth when we instantiate a generic type alias.</li>
<li>type instantiation count: the maximum number of type instantiations.</li>
</ul>
<p>These limits are not arbitrary. The compiler has set a maximum limit for these three values and will throw an error <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/blob/1416053b9e85ca2344a7a6aa10456d633ea1cd65/src/compiler/diagnosticMessages.json#L2718">TS2589</a> if we exceed them to prevent the compiler from hanging or crashing.<br>They are the walls that stop us from breaking through the limits of TypeScript compiler. But, there is actually a hidden layer behind the wall, if we explore the compiler source code carefully.</p>
<blockquote>
<p>Doing type level programming is like casting magic, but breaking through the wall of type gymnastics is like finding the hidden chamber of secrets that contains the most powerful and dangerous type of all.</p>
</blockquote>
<h2 id="Some-digression-for-background‚Ä¶"><a href="#Some-digression-for-background‚Ä¶" class="headerlink" title="Some digression for background‚Ä¶"></a>Some digression for background‚Ä¶</h2><p>Back then three years ago, I wrote <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/86008532">an article</a> about how to implement a recursive descent parser. At that time, there was no template literal type, and a lot of type system limitations have been lifted since then. Crafting a code interpreter using recursive descent parsing would easily exceed the compiler‚Äôs limit.</p>
<p>So I decided to switch to a bottom-up parsing method to more easily bypass the limit, with some tricks :). Later, as TypeScript gradually evolves, newly added features opened unprecedented possibilities of type gymnastics. This finally gave me a chance to implement a <a target="_blank" rel="noopener" href="https://github.com/fightingcat/sits">type gymnastics parser generator for LALR(1) grammar</a> to generate a parser for a subset of JavaScript syntax.<br>I designed a special purpose <em>‚Äúbytecode‚Äù</em> for the ease of type level execution and directly compiled the input code into the bytecode during the parsing process(I still have some unfinished work left, procrastinating now‚Ä¶). My ultimate goal is to implement a type level scripting language that can execute sufficiently complex code.</p>
<p>To achieve this goal, I need to solve all the three limitations mentioned above to run lunatic code patterns, to some extent, at compile time!</p>
<p><img src="https://pic1.zhimg.com/v2-7fac8439827a5a3e618f7faba7c5dfb8_r.jpg" alt="Type Level Programming nowadays can represent monsters like this..."></p>
<h1 id="Tail-Recursion-Count"><a href="#Tail-Recursion-Count" class="headerlink" title="Tail Recursion Count"></a>Tail Recursion Count</h1><p>Let‚Äôs look at the first limitation, the type tail recursion count (tailCount). Type level programming often uses recursive types. Before the previous versions supported recursive types, we usually <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/issues/14833">implemented recursion</a> by combining mapped types, recursive type definitions and index types. Ever since we had <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/pull/33050">recursive types</a> and <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/pull/45711">tail recursion of type instantiation</a>, this kind of type gymnastics became much more elegant, but at the same time we also got this tail recursion count limitation.</p>
<p>Searching for <code>tailCount</code> in the TypeScript source code, we can see that the implementation is related to computing conditional types. Let‚Äôs simplify the code a bit and take a look (sorry folks, I cannot get a link to GitHub source code due to checker.ts is too large):</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// transitively used in instantiateType</span></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">getConditionalType</span>(<span class="params">root: ConditionalRoot</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> result;</span><br><span class="line">    <span class="keyword">let</span> tailCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (tailCount === <span class="number">1000</span>) &#123;</span><br><span class="line">            <span class="title function_">error</span>(<span class="number">2589</span>);</span><br><span class="line">            result = errorType;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// false branch</span></span><br><span class="line">        <span class="keyword">if</span> (!<span class="title function_">isTypeAssignableTo</span>(checkType, extendsType)) &#123;</span><br><span class="line">            <span class="keyword">const</span> falseType = <span class="title function_">getTypeFromTypeNode</span>(root.<span class="property">node</span>.<span class="property">falseType</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">canTailRecurse</span>(falseType)) &#123;</span><br><span class="line">                <span class="comment">// root = falseType;</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// tail call terminates, creating new type</span></span><br><span class="line">            result = <span class="title function_">instantiateType</span>(falseType);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// true branch</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_">isTypeAssignableTo</span>(checkType, extendsType)) &#123;</span><br><span class="line">            <span class="keyword">const</span> trueType = <span class="title function_">getTypeFromTypeNode</span>(root.<span class="property">node</span>.<span class="property">trueType</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_">canTailRecurse</span>(trueType)) &#123;</span><br><span class="line">                <span class="comment">// root = trueType;</span></span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// end of tail recursion, instantiate new type</span></span><br><span class="line">            result = <span class="title function_">instantiateType</span>(trueType);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">canTailRecurse</span>(<span class="params">newType: Type</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (newType.<span class="property">flags</span> &amp; <span class="title class_">TypeFlags</span>.<span class="property">Conditional</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> newRoot = (newType <span class="keyword">as</span> <span class="title class_">ConditionalType</span>).<span class="property">root</span>;</span><br><span class="line">            <span class="keyword">const</span> newCheckType = newRoot.<span class="property">isDistributive</span></span><br><span class="line">                ? newRoot.<span class="property">checkType</span></span><br><span class="line">                : <span class="literal">undefined</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                !newCheckType ||</span><br><span class="line">                !(newCheckType.<span class="property">flags</span> &amp; (<span class="title class_">TypeFlags</span>.<span class="property">Union</span> | <span class="title class_">TypeFlags</span>.<span class="property">Never</span>))</span><br><span class="line">            ) &#123;</span><br><span class="line">                root = newRoot;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (newRoot.<span class="property">aliasSymbol</span>) &#123;</span><br><span class="line">                    tailCount++;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We can see that as long as the branch of the conditional type that matches is another conditional type, and the new conditional type is neither a distributive conditional type nor a union type or never, then the new conditional type will be substituted into the next round of computation.</p>
<p>The only problem is that it will trigger an error TS2589 when the loop reaches 1000 times, <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/play#code/C4TwDgpgBAWhBOB7AYgSwDboDwCgr6gHkBXYMUqCAD2AgDsATAZygAYBtAXQBo8CBhRMTrBKNesyh1iAWwBGCHAD4oAXiKlywdgCJ09AObAAFjs5jajFoOGiA-BrIUAXLAQoM2dgDpfJJ8DcbDxQNiJKANw4OKCQUADKqABeEAwAnBlqbkhomFhcQRlpkVAA9KVEANYAhiDeMeDQiSkMAIwA0llwOZ75Ia2sgyXlRIhgTEEAKvEATACsABxp9UA">TS Playground</a>:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">ZeroFill</span>&lt;</span><br><span class="line">    <span class="title class_">Output</span> <span class="keyword">extends</span> <span class="number">0</span>[],</span><br><span class="line">    <span class="title class_">Count</span> <span class="keyword">extends</span> <span class="built_in">number</span></span><br><span class="line">&gt; = <span class="title class_">Output</span>[<span class="string">&quot;length&quot;</span>] <span class="keyword">extends</span> <span class="title class_">Count</span> ? <span class="title class_">Output</span> : <span class="title class_">ZeroFill</span>&lt;[...<span class="title class_">Output</span>, <span class="number">0</span>], <span class="title class_">Count</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Sized999</span> = <span class="title class_">ZeroFill</span>&lt;[], <span class="number">999</span>&gt;; <span class="comment">// Okay.</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Sized1K</span> = <span class="title class_">ZeroFill</span>&lt;[], <span class="number">1000</span>&gt;; <span class="comment">// Oops, TS2589.</span></span><br></pre></td></tr></table></figure>

<p>To avoid reaching the 1000 times recursion limit, we can deliberately break the tail recursion after a certain number of recursions (using an extra parameter to count), as long as we return a type that does not satisfy the above conditions, and does not affect the result of the type we return, such as returning an intersection type (<a target="_blank" rel="noopener" href="https://www.typescriptlang.org/play#code/PTAEAkEMCcBMFoDGB7WBTUlQDsCuBbAIzWk2mkgE8AaMiy0AS23QA9QVy0BnAB2RbdQAF2SgAbpAA2uDLxlCAjAChhlXhgCS2RKQC8oANrLQpxbVAAmCwGYLAFgsBWCwDYLAdgsAOCwE5aRQAGQPNQRWtwu3DHcJdw93CvcN9wgKsQkyswy0jLaMtYy3jLRMtky1TLdJsQ0Bswm0ibaJtYm3ibRJtkm1SbdPtM03sw+0j7aPtY+3j7RPtk+1T7dKc6pzCnSKdop1ineKdEp2SnVKd012HQVzDXSNdo11jXeNdE12TXVNd0jzqHjCHkiHmiHliHniHkSHmSHlSHnS3hu3jC3ki3mi3li3ni3kS3mS3lS3nSfjqfjCfkifmiflifnifkSfmSflSfnSwRumQAugBuZSqdQYABaJGQADFGFIpAAeLKmADyuGEvDVoDQrGEaEEoCChj51CVoAAwshcNhhFqdXrYEI8EQSCbTKZNLqKMJGAIhNrdfrtLpDE7iNA+aADEFlAA+SOgD0kSDe322gMO8JBaNu0AAflAIHNAAtINgAOYYYRFjDQNCIXDQbiMcSV0UiMSlpjWkjcOsp7AiUW0Qi1yAAaxE1ZEkFloFr9cbPoHpdgc54aBtVYwjE9yaXptMEug0tlCtV6rVtAtVuEtCCcYAZKAAN4AX1NAC4C2AAEp1htNgIIgkPgzDJjwprnhqwiGAARFIepllWsERv69pCNe1qmvmhYytg0igH+3C4FIwgHqAUFqp+34Jjotb4Hqm5TigN6gAAZsgpBoJAiBFmuC6Adg5FHiecryoYAB0UmUbeBrGualrWrQQbQIYiZeku3B8jGQoihooAAMqMAAXmgsA2AA0vGIkymJRq0LUWY6TRypjlQEl6RgRmmbA9hWQYNmnuJ8lDE5AouW5NCgIQmpVowQjxTgyBMRg9qgMgbGgNwojQJQUkeUAA">Playground Link</a>):</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Hard-code a number array, array index corresponds to value plus 1</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Incr</span> = [</span><br><span class="line">   <span class="number">1</span>,  <span class="number">2</span>,  <span class="number">3</span>,  <span class="number">4</span>,  <span class="number">5</span>,  <span class="number">6</span>,  <span class="number">7</span>,  <span class="number">8</span>,  <span class="number">9</span>, <span class="number">10</span>, <span class="number">11</span>, <span class="number">12</span>, <span class="number">13</span>, <span class="number">14</span>, <span class="number">15</span>, <span class="number">16</span>, <span class="number">17</span>, <span class="number">18</span>, <span class="number">19</span>, <span class="number">20</span>,</span><br><span class="line">  <span class="number">21</span>, <span class="number">22</span>, <span class="number">23</span>, <span class="number">24</span>, <span class="number">25</span>, <span class="number">26</span>, <span class="number">27</span>, <span class="number">28</span>, <span class="number">29</span>, <span class="number">30</span>, <span class="number">31</span>, <span class="number">32</span>, <span class="number">33</span>, <span class="number">34</span>, <span class="number">35</span>, <span class="number">36</span>, <span class="number">37</span>, <span class="number">38</span>, <span class="number">39</span>, <span class="number">40</span>,</span><br><span class="line">  <span class="number">41</span>, <span class="number">42</span>, <span class="number">43</span>, <span class="number">44</span>, <span class="number">45</span>, <span class="number">46</span>, <span class="number">47</span>, <span class="number">48</span>, <span class="number">49</span>, <span class="number">50</span>, <span class="number">51</span>, <span class="number">52</span>, <span class="number">53</span>, <span class="number">54</span>, <span class="number">55</span>, <span class="number">56</span>, <span class="number">57</span>, <span class="number">58</span>, <span class="number">59</span>, <span class="number">60</span>,</span><br><span class="line">  <span class="number">61</span>, <span class="number">62</span>, <span class="number">63</span>, <span class="number">64</span>, <span class="number">65</span>, <span class="number">66</span>, <span class="number">67</span>, <span class="number">68</span>, <span class="number">69</span>, <span class="number">70</span>, <span class="number">71</span>, <span class="number">72</span>, <span class="number">73</span>, <span class="number">74</span>, <span class="number">75</span>, <span class="number">76</span>, <span class="number">77</span>, <span class="number">78</span>, <span class="number">79</span>, <span class="number">80</span>,</span><br><span class="line">  <span class="number">81</span>, <span class="number">82</span>, <span class="number">83</span>, <span class="number">84</span>, <span class="number">85</span>, <span class="number">86</span>, <span class="number">87</span>, <span class="number">88</span>, <span class="number">89</span>, <span class="number">90</span>, <span class="number">91</span>, <span class="number">92</span>, <span class="number">93</span>, <span class="number">94</span>, <span class="number">95</span>, <span class="number">96</span>, <span class="number">97</span>, <span class="number">98</span>, <span class="number">99</span>, <span class="number">100</span>,</span><br><span class="line">  <span class="number">0</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">ZeroFill</span>&lt;</span><br><span class="line">    <span class="title class_">Output</span> <span class="keyword">extends</span> <span class="number">0</span>[],</span><br><span class="line">    <span class="title class_">Count</span> <span class="keyword">extends</span> <span class="built_in">number</span>,</span><br><span class="line">    <span class="title class_">Iterations</span> <span class="keyword">extends</span> <span class="title class_">Incr</span>[<span class="built_in">number</span>] = <span class="number">0</span></span><br><span class="line">&gt; = <span class="title class_">Iterations</span> <span class="keyword">extends</span> <span class="number">100</span></span><br><span class="line">    ? <span class="comment">// Change the recursive type to an intersection type, break the tail recursion and reset the iteration</span></span><br><span class="line">      <span class="title class_">ZeroFill</span>&lt;<span class="title class_">Output</span>, <span class="title class_">Count</span>, <span class="number">0</span>&gt; &amp; &#123;&#125;</span><br><span class="line">    : <span class="comment">// Recursion terminates</span></span><br><span class="line">    <span class="title class_">Output</span>[<span class="string">&quot;length&quot;</span>] <span class="keyword">extends</span> <span class="title class_">Count</span></span><br><span class="line">    ? <span class="comment">// Final Result</span></span><br><span class="line">      <span class="title class_">Output</span></span><br><span class="line">    : <span class="comment">// Increment the count for each recursion</span></span><br><span class="line">      <span class="title class_">ZeroFill</span>&lt;[...<span class="title class_">Output</span>, <span class="number">0</span>], <span class="title class_">Count</span>, <span class="title class_">Incr</span>[<span class="title class_">Iterations</span>]&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Sized3K</span> = <span class="title class_">ZeroFill</span>&lt;[], <span class="number">3000</span>&gt;; <span class="comment">// Okay.</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Sized4K</span> = <span class="title class_">ZeroFill</span>&lt;[], <span class="number">4000</span>&gt;; <span class="comment">// Okay, but this is not the end of story...</span></span><br></pre></td></tr></table></figure>

<h1 id="Type-Instantiation-Depth"><a href="#Type-Instantiation-Depth" class="headerlink" title="Type Instantiation Depth"></a>Type Instantiation Depth</h1><p>The type above has now exceeded the limit of 1000 recursions, but if you comment out <code>Sized3K</code>, you will see that <code>Sized4K</code> will trigger TS2589. This is related to the second limitation, which is the <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/pull/45025">type instantiation depth</a> (<code>instantiationDepth</code>). The reason why commenting out has an effect is because TypeScript will cache all instantiated types, which we will discuss later. Again, we can search for <code>instantiationDepth</code> in the TS source code. You can see that it is implemented with all types that have type mapping. There are several kinds of type mapping. For example, types that use generic parameters will have type mapping to map parameters to actual types. The relevant code is simplified as follows:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">instantiateType</span>(<span class="params"><span class="keyword">type</span>?: Type, mapper?: TypeMapper</span>): <span class="title class_">Type</span> | <span class="literal">undefined</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">type</span> &amp;&amp; mapper ? <span class="title function_">instantiateTypeWithAlias</span>(<span class="keyword">type</span>, mapper) : <span class="keyword">type</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">instantiateTypeWithAlias</span>(<span class="params"></span></span><br><span class="line"><span class="params">    <span class="keyword">type</span>: Type,</span></span><br><span class="line"><span class="params">    mapper: TypeMapper,</span></span><br><span class="line"><span class="params">    aliasSymbol?: <span class="built_in">Symbol</span>,</span></span><br><span class="line"><span class="params">    aliasTypeArguments?: <span class="keyword">readonly</span> Type[]</span></span><br><span class="line"><span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (instantiationDepth === <span class="number">100</span> || instantiationCount &gt;= <span class="number">5000000</span>) &#123;</span><br><span class="line">        <span class="title function_">error</span>(<span class="number">2589</span>);</span><br><span class="line">        <span class="keyword">return</span> errorType;</span><br><span class="line">    &#125;</span><br><span class="line">    totalInstantiationCount++;</span><br><span class="line">    instantiationCount++; <span class="comment">// note: `count` only increments</span></span><br><span class="line">    instantiationDepth++;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="title function_">instantiateTypeWorker</span>(</span><br><span class="line">        <span class="keyword">type</span>,</span><br><span class="line">        mapper,</span><br><span class="line">        aliasSymbol,</span><br><span class="line">        aliasTypeArguments</span><br><span class="line">    );</span><br><span class="line">    instantiationDepth--; <span class="comment">// note: only depth got decremented</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>We also see the <code>instantiationCount</code> mentioned at the beginning, but we will first focus on the <code>instantiationDepth</code> for now. We can see that before and after each type alias instantiation, the instantiation depth will increase and decrease, and any call to instantiateType in the middle process will indirectly call the above type, which will make the depth count continue to increase.<br>To avoid reaching the maximum depth, one is to use tail recursion as much as possible, and the other is to reduce the dependence on intermediate types in the recursive process if you use the technique of breaking tail recursion before.<br>Here is an example code (to reduce interference we simplify it to only have two generic parameters, only keep the recursive logic itself, and use intersection type to prevent tail recursion instantiation):</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Simulate a type that keeps calculating values and sets the finish state based on the results</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">BadWay</span>&lt;<span class="title class_">State</span>, <span class="title class_">Value</span>&gt; = <span class="title class_">State</span> <span class="keyword">extends</span> <span class="string">`finish`</span></span><br><span class="line">    ? <span class="title class_">Value</span></span><br><span class="line">    : <span class="comment">// Use conditional type and infer type to save the new result</span></span><br><span class="line">    <span class="title class_">Calculate</span>&lt;<span class="title class_">Value</span>&gt; <span class="keyword">extends</span> infer <span class="title class_">NewValue</span></span><br><span class="line">    ? <span class="comment">// Use conditional type and infer type to save the new state</span></span><br><span class="line">      <span class="title class_">CheckValue</span>&lt;<span class="title class_">NewValue</span>&gt; <span class="keyword">extends</span> infer <span class="title class_">NewState</span></span><br><span class="line">        ? <span class="comment">// Compared to direct recursion, this adds two levels of type instantiation depth</span></span><br><span class="line">          <span class="title class_">BadWay</span>&lt;<span class="title class_">NewState</span>, <span class="title class_">NewValue</span>&gt;</span><br><span class="line">        : <span class="built_in">never</span></span><br><span class="line">    : <span class="built_in">never</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// In fact, repeating ‚Äúcalling‚Äù type aliases does not lose anything, TS will always cache all types instances.</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">GoodWay</span>&lt;<span class="title class_">State</span>, <span class="title class_">Value</span>&gt; = <span class="title class_">State</span> <span class="keyword">extends</span> <span class="string">`finish`</span></span><br><span class="line">    ? <span class="title class_">Value</span></span><br><span class="line">    : <span class="comment">// Direct recursion reduces the instantiation depth as much as possible</span></span><br><span class="line">      <span class="title class_">GoodWay</span>&lt;</span><br><span class="line">          <span class="comment">// The intermediate result is instantiated when passing parameters, which can be instantiated before recursion, releasing the increased depth.</span></span><br><span class="line">          <span class="title class_">CheckValue</span>&lt;<span class="title class_">Calculate</span>&lt;<span class="title class_">Value</span>&gt;&gt;,</span><br><span class="line">          <span class="comment">// The repeated alias calls will only be truly instantiated once due to the caching mechanism, so you don‚Äôt have to worry about various restrictions and overheads.</span></span><br><span class="line">          <span class="title class_">Calculate</span>&lt;<span class="title class_">Value</span>&gt;</span><br><span class="line">      &gt; &amp; &#123;&#125;;</span><br></pre></td></tr></table></figure>

<p>In the example above, <code>BadWay</code> increases the depth by two levels more than <code>GoodWay</code> for each recursion, which will reach the recursion depth limit faster.</p>
<p>With the instantiation level limit, we should <strong>start recursion as early as possible</strong>, putting all kinds of intermediate type calculations into parameters. And let each iteration type complete instantiation as soon as possible, releasing the increased depth.</p>
<p>Another way to release the depth count in advance is to manually <strong>split the iteration process into multiple parts</strong>, storing intermediate result as a type alias.<br>Let‚Äôs take the first type as an example:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Sized3K</span> = <span class="title class_">ZeroFill</span>&lt;[], <span class="number">3000</span>&gt;; <span class="comment">// Okay.</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Sized4K</span> = <span class="title class_">ZeroFill</span>&lt;<span class="title class_">Sized3K</span>, <span class="number">4000</span>&gt;; <span class="comment">// Okay.</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Sized5K</span> = <span class="title class_">ZeroFill</span>&lt;<span class="title class_">Sized4K</span>, <span class="number">5000</span>&gt;; <span class="comment">// Okay.</span></span><br></pre></td></tr></table></figure>

<p>One thing to keep in mind is that as the type becomes more complex, the tsc compiler may handle it fine, but the editor may not give any feedback due to the long response time. This is because they use different methods and caches for type checking. For example, in the code above, if we comment out <code>Sized4K</code> (which has a cache effect), and directly generate <code>Sized5K</code> from <code>Sized3K</code>, we will get a <code>TS2589</code> error again. See <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/play#code/PTAEAkEMCcBMFoDGB7WBTUlQDsCuBbAIzWk2mkgE8AaMiy0AS23QA9QVy0BnAB2RbdQAF2SgAbpAA2uDLxlCAjAChhlXhgCS2RKQC8oANrLQpxbVAAmCwGYLAFgsBWCwDYLAdgsAOCwE5aRQAGQPNQRWtwu3DHcJdw93CvcN9wgKsQkyswy0jLaMtYy3jLRMtky1TLdJsQ0Bswm0ibaJtYm3ibRJtkm1SbdPtM03sw+0j7aPtY+3j7RPtk+1T7dKc6pzCnSKdop1ineKdEp2SnVKd012HQVzDXSNdo11jXeNdE12TXVNd0jzqHjCHkiHmiHliHniHkSHmSHlSHnS3hu3jC3ki3mi3li3ni3kS3mS3lS3nSfjqfjCfkifmiflifnifkSfmSflSfnSwRumQAugBuZSqdQYABaJGQADFGFIpAAeLKmADyuGEvDVoDQrGEaEEoCChj51CVoAAwshcNhhFqdXrYEI8EQSCbTKZNLqKMJGAIhNrdfrtLpDE7iNA+aADEFlAA+SOgD0kSDe322gMO8JBaNu0AAflAIHNAAtINgAOYYYRFjDQNCIXDQbiMcSV0UiMSlpjWkjcOsp7AiUW0Qi1yAAaxE1ZEkFloFr9cbPoHpdgc54aBtVYwjE9yaXptMEug0tlCtV6rVtAtVuEtCCcYAZKAAN4AX1NAC4C2AAEp1htNgIIgkPgzDJjwprnhqwiGAARFIepllWsERv69pCNe1qmvmhYytg0igH+3C4FIwgHqAUFqp+34Jjotb4Hqm5TigN6gAAZsgpBoJAiBFmuC6Adg5FHiecryoYAB0UmUbeBrGualrWrQQbQIYiZeku3B8jGQoihooAAMqMAAXmgsA2AA0vGIkymJRq0LUWY6TRypjlQEnKIWaj6UZpmwPYVkGDZp7yr5ZmWbQQxOQKLluZQHneRgYWwE4gWgMFYnJRFoDrNFsXucoQA">the playground link</a>.This is not caused by the two limitations we mentioned before, because this time we only have 2000 iterations, much less than <code>Sized3K</code>. The actual cause of this compilation error leads us to the third limitation: the type instantiation count (<code>instantiationCount</code>).</p>
<h1 id="Type-Instantiation-Count"><a href="#Type-Instantiation-Count" class="headerlink" title="Type Instantiation Count"></a>Type Instantiation Count</h1><p>We have encountered the variable <code>instantiationCount</code> before in the function <code>instantiateTypeWithAlias</code>. It has a current limit of <code>5,000,000</code>, which is incremented together with <code>instantiationDepth</code> every time a type is instantiated. Unlike <code>instantiationDepth</code>, it does not decrease when the instantiation is done because it represents the number of type instances that are created in one instantiation process. If we continue to search the source code, we can see that it is set to 0 when the compiler checks some types of syntax nodes:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">checkSourceElement</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    instantiationCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">checkDeferredNode</span>(<span class="params">node</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    instantiationCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">checkExpression</span>(<span class="params">node, checkMode, forceTuple</span>) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    instantiationCount = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>If we debug tsc and set a breakpoint after the condition <code>instantiationCount &gt;= 5000000</code>, we will see in the call stack that the error is thrown when instantiating an object type with more than 3700 members. This object type is actually the array type that we generated. We will not analyze step by step why it produces so many (5 million) type instances here. We just need to know that this array is created by many generic parameters, which leads to a large number of type instances. Even if our type gymnastics did not generate such a large array, it would slow down the speed when producing so many type instances. So how can we avoid this situation?</p>
<p>The direct conclusion is to use other types to achieve the purpose according to the needs. For example, if you use an array type to simulate a stack structure, and only need to access the last one or a few elements, then you can define a List object type, which is concatenated, but the structure of the object is fixed:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">List</span>&lt;T&gt; = &#123; <span class="attr">data</span>: T; <span class="attr">prev</span>: <span class="title class_">List</span>&lt;T&gt; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Append</span>&lt;P <span class="keyword">extends</span> <span class="title class_">List</span>&lt;<span class="built_in">unknown</span>&gt;, T&gt; = &#123; <span class="attr">data</span>: T; <span class="attr">prev</span>: P &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Stack</span> = <span class="title class_">Append</span>&lt;<span class="title class_">Append</span>&lt;<span class="title class_">Append</span>&lt;<span class="built_in">never</span>, <span class="number">1</span>&gt;, <span class="number">2</span>&gt;, <span class="number">3</span>&gt;; <span class="comment">// [1, 2, 3]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Popped</span> = <span class="title class_">Stack</span>[<span class="string">&quot;prev&quot;</span>]; <span class="comment">// [1, 2]</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Last</span> = <span class="title class_">Stack</span>[<span class="string">&quot;data&quot;</span>]; <span class="comment">// 3</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">SecondToLast</span> = <span class="title class_">Stack</span>[<span class="string">&quot;prev&quot;</span>][<span class="string">&quot;data&quot;</span>]; <span class="comment">// 2</span></span><br></pre></td></tr></table></figure>

<p>Alternatively we can encode the logic in string by constructing template string of a specific format.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Append</span>&lt;S <span class="keyword">extends</span> <span class="built_in">string</span>, T <span class="keyword">extends</span> <span class="built_in">string</span>&gt; = <span class="string">`<span class="subst">$&#123;T&#125;</span>,<span class="subst">$&#123;S&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Stack</span> = <span class="title class_">Append</span>&lt;<span class="title class_">Append</span>&lt;<span class="title class_">Append</span>&lt;<span class="string">&quot;&quot;</span>, <span class="string">&quot;alpha&quot;</span>&gt;, <span class="string">&quot;beta&quot;</span>&gt;, <span class="string">&quot;gamma&quot;</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Popped</span> = <span class="title class_">Stack</span> <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;<span class="built_in">string</span>&#125;</span>,<span class="subst">$&#123;infer S&#125;</span>`</span> ? S : <span class="built_in">never</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Last</span> = <span class="title class_">Stack</span> <span class="keyword">extends</span> <span class="string">`<span class="subst">$&#123;infer T&#125;</span>,<span class="subst">$&#123;<span class="built_in">string</span>&#125;</span>`</span> ? T : <span class="built_in">never</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="https://github.com/fightingcat/sits/blob/fd958753c1f7514c29314fbfabab86d97075acec/lib/helpers.d.ts#L77">You can even use union types</a>. However, you need to pay attention that when union types are used in distributive conditional types, they will generate the same number of type instances as the number of elements, but they are still a better choice in many cases.</p>
<p>Usual type level programming will not trigger this limitation, so we will not describe it too much. To optimize the number of instantiations, you inevitably need to read the compiler source code, or you can add the <code>--diagnostics</code> parameter when calling <code>tsc</code>, and observe the <code>Instantiations</code> in the output, which can show how many type instances are generated in total.</p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>One caveat is that all tricks in the article are probably the byproduct of a specific compiler implementation and are not officially supported by the TypeScript team. And they may even be broken in the future!<br>Actually, most of these dark magics are manipulating type instantiation to make time-space trade-offs. We are nudging compiler to forget intermediate type caches (<a target="_blank" rel="noopener" href="https://harrypotter.fandom.com/wiki/Memory_Charm#cite_note-COS16-1">Obliviate!</a>), prompting it to compute more types (<a target="_blank" rel="noopener" href="https://harrypotter.fandom.com/wiki/Imperius_Curse">Imperio!</a>) and forcing it to work longer for a compilation (<a target="_blank" rel="noopener" href="https://harrypotter.fandom.com/wiki/Incarcerous_Spell">Incarcerous!</a>). All the grueling rituals for the holy grail of turing completeness!</p>
<p>However, they are still very useful in some cases and help us break the limitations of TypeScript! The snake is in the chamber of secrets, so use these lost spells wisely, my great mage!</p>
<p>If you find this article useful, I would be more than happy if you can <a target="_blank" rel="noopener" href="https://github.com/sponsors/HerringtonDarkholme/">treat me some coffee</a>.</p>
<hr>
<p><em>Translation, rewrite and title image generation are all assisted by MicroSoft Bing Chat.</em></p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-optimize-ast-grep" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2023/01/23/optimize-ast-grep/">Optimize ast-grep to get 10X faster</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2023-01-23T08:00:00.000Z" itemprop="datePublished">January 23, 2023, 12:00 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>In this post I will discuss how to optimize the Rust CLI tool <a target="_blank" rel="noopener" href="https://ast-grep.github.io/">ast-grep</a> to become 10 times faster.</p>
<p>Rust itself usually runs fast enough, but it is not a silver bullet to all performance issues.</p>
<p>In this case, I did not pay enough attention to runtime details or opted for naive implementation for a quick prototype. And these inadvertent mistakes and deliberate slacking off became ast-grep‚Äôs bottleneck.</p>
<h1 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h1><p><a target="_blank" rel="noopener" href="https://ast-grep.github.io/">ast-grep</a> is my hobby project to help you search and rewrite code using <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/Abstract_syntax_tree">abstract syntax tree</a>.</p>
<p>Conceptually, ast-grep takes a piece of pattern code (think it like a regular expression but for AST), matches the pattern against your codebase and gives a list of matched AST nodes back to you. See the <a target="_blank" rel="noopener" href="https://ast-grep.github.io/playground">playground</a> for a live demo.</p>
<p>I designed ast-grpe‚Äôs architecture with performance in mind. Here are a few performance related highlights:</p>
<ul>
<li>it is written in Rust, a native language compiled to machine code.</li>
<li>it uses the venerable C library <a target="_blank" rel="noopener" href="https://tree-sitter.github.io/">tree-sitter</a> to parse code, which is the same library powering <a target="_blank" rel="noopener" href="https://github.com/features/code-search">GitHub‚Äôs codesearch</a>.</li>
<li>its command line interface is built upon <a target="_blank" rel="noopener" href="https://docs.rs/ignore/latest/ignore/">ignore</a>, the same crates used by the blazing fast <a target="_blank" rel="noopener" href="https://github.com/BurntSushi/ripgrep">ripgrep</a>.</li>
</ul>
<p>Okay, enough self-promotion <em>BS</em>. If it is designed to be fast, how comes this blog? Let‚Äôs dive into the performance bottleneck I found in my bad code.</p>
<blockquote>
<p>Spoiler. It‚Äôs my bad to write slow Rust.</p>
</blockquote>
<h1 id="Profiling"><a href="#Profiling" class="headerlink" title="Profiling"></a>Profiling</h1><p>The first thing to optimize a program is to profile it. I am lazy this time and just uses the <a target="_blank" rel="noopener" href="https://github.com/flamegraph-rs/flamegraph">flamegraph</a> tool.</p>
<p>Installing it is simple.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cargo install flamegraph</span><br></pre></td></tr></table></figure>

<p>Then run it against ast-grep! No other setup is needed, compared to other profiling tools!</p>
<p>This time I‚Äôm using an ast-grep port of <a target="_blank" rel="noopener" href="https://github.com/ast-grep/eslint">es-lint</a> against <a target="_blank" rel="noopener" href="https://github.com/microsoft/TypeScript/">TypeScript</a>‚Äòs <code>src</code> folder.</p>
<p>This is the profiling command I used.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo flamegraph -- sg scan -c eslint/sgconfig.yml TypeScript/src --json &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>The flamegraph looks like this.</p>
<img width="1155" alt="Before Optimzation" src="https://user-images.githubusercontent.com/2883231/215253646-21b5f1dd-a810-4ddb-9bbe-4938b4cc15f9.png">

<p>Optimizing the program is a matter of finding the hotspots in the flamegraph and fix them.</p>
<p>For a more intuitive feeling about performance, I used the old command <code>time</code> to measure the wall time to run the command. The result is not good.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time sg scan -c eslint/sgconfig.yml TypeScript/src</span><br><span class="line">17.63s user, 0.46s system, 167% cpu, 10.823 total</span><br></pre></td></tr></table></figure>

<p>The time before <code>user</code> is the actual CPU time spent on my program. The time before <code>total</code> represents the wall time. The ratio between them is the CPU utilization. In this case, it is 167%. It means my program is not fully utilizing the CPU.</p>
<p>It only runs six rules against the codebase and it costs about 10 whole seconds!</p>
<p>In contrast, running one ast-grep pattern agasint the TypeScript source only costs 0.5 second and the CPU utilization is decent.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">time sg run -p <span class="string">&#x27;$A &amp;&amp; $A()&#x27;</span> TypeScript/src --json &gt; /dev/null</span><br><span class="line"></span><br><span class="line">1.96s user, 0.11s system, 329% cpu, 0.628 total</span><br></pre></td></tr></table></figure>

<h1 id="Expensive-Regex-Cloning"><a href="#Expensive-Regex-Cloning" class="headerlink" title="Expensive Regex Cloning"></a>Expensive Regex Cloning</h1><p>The first thing I noticed is that the <code>regex::Regex</code> type is cloned a lot. I do know it is expensive to compile a regex, but I did not expect cloning one will be the bottleneck.<br>Much to my limited understanding, <code>drop</code>ping Regex is also expensive!</p>
<p>Fortunately the fix is simple: I can use a reference to the regex instead of cloning it.</p>
<p>This optimzation alone shaves about 50% of execution time.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">time sg scan -c eslint/sgconfig.yml TypeScript/src --json &gt; /dev/null</span><br><span class="line">13.89s user, 0.74s system, 274% cpu 5.320 total</span><br></pre></td></tr></table></figure>

<p>The new flamegraph looks like this.</p>
<img width="1509" alt="Avoid Regex Cloning" src="https://user-images.githubusercontent.com/2883231/215318711-634a8b99-3e02-4187-9073-ea5be25d098f.png">


<h1 id="Matching-Rule-can-be-Avoided"><a href="#Matching-Rule-can-be-Avoided" class="headerlink" title="Matching Rule can be Avoided"></a>Matching Rule can be Avoided</h1><p>The second thing I noticed is that the <code>match_node</code> function is called a lot. It is the function that matches a pattern against an AST node.<br>ast-grep can match an AST node by rules, and those rules can be composed together into more complex rules.<br>For example, the rule <code>any: [rule1, rule2]</code> is a composite rule that consists of two sub-rules and the composite rule matches a node when either one of the sub-rules matches the node.<br>This can be expensive since multiple rules must be tried for every node to see if they actually make a match.</p>
<p>I have already forsee it so every rule in ast-grep has an optimzation called <code>potential_kinds</code>. AST node in tree-sitter has its own type encoded in a unsigned number called <code>kind</code>.<br>If a rule can only match nodes with specific kinds, then we can avoid calling <code>match_node</code> for nodes if its kind is not in the <code>potential_kinds</code> set.<br>I used a BitSet to encode the set of potential kinds. Naturally the <code>potential_kinds</code> of composite rules can be constructed by merging the <code>potential_kinds</code> of its sub-rules, according to their logic nature.<br>For example, <code>any</code>‚Äòs potential_kinds is the union of its sub-rules‚Äô potential_kinds, and <code>all</code>‚Äòs potential_kinds is the intersection of its sub-rules‚Äô potential_kinds.</p>
<p>Using this optimization, I can avoid calling <code>match_node</code> for nodes that can never match a rule. This optimization shaves another 40% of execution time!</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sg scan -c eslint/sgconfig.yml TypeScript/src --json &gt; /dev/null</span><br><span class="line">11.57s user, 0.48s system, 330% cpu, 3.644 total</span><br></pre></td></tr></table></figure>

<p>The new flamegraph.</p>
<img width="1503" alt="potential_kinds trick" src="https://user-images.githubusercontent.com/2883231/215318794-7e3cf452-5016-4541-9c9d-1e266c1ee324.png">

<h1 id="Duplicate-Tree-Traversal"><a href="#Duplicate-Tree-Traversal" class="headerlink" title="Duplicate Tree Traversal"></a>Duplicate Tree Traversal</h1><p>Finally, the function call <code>ts_tree_cursor_child_iterator_next</code> caught my eyes. It meant that a lot of time was spent on traversing the AST tree.</p>
<p>Well, I dumbly iterating through all the six rules and matching the whole AST tree for each rule. This is a lot of duplicated work!</p>
<p>So I used a data structure to combine these rules, according to their <code>potential_kinds</code>. When I‚Äôm traversing the AST tree, I will first retrieve the rules with potential_kinds containing the kind of the current node. Then I will only run these rules against the node. And nodes without any <code>potential_kinds</code> hit will be naturally skipped during the traversal.</p>
<p>This is a huge optimization! The ending result is less than 1 second! And the CPU utilization is pretty good.</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sg scan -c eslint/sgconfig.yml TypeScript/src --json &gt; /dev/null</span><br><span class="line">2.82s user, 0.12s system, 301% cpu, 0.975 total</span><br></pre></td></tr></table></figure>

<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><p>The final flamegraph looks like this. I‚Äôm too lazy to optimize more. I‚Äôm happy with the sub-second result for now.</p>
<img width="1513" alt="Merging rules" src="https://user-images.githubusercontent.com/2883231/215318867-b670b5fe-c678-4c31-985f-36e4f620baeb.png">

<p>Optimizing ast-grep is a fun journey. I learned a lot about Rust and performance tuning. I hope you enjoyed this post as well.</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-angular-ivy" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2018/02/19/angular-ivy/">A quick intro to Angular Ivy</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2018-02-19T08:00:00.000Z" itemprop="datePublished">February 19, 2018, 12:00 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>Angular recently announced a new render engine called <a target="_blank" rel="noopener" href="https://github.com/angular/angular/issues/21706">Ivy</a>.<br>Ivy is an amazing present from Angular team! It produces hello-world app in mere <a target="_blank" rel="noopener" href="https://twitter.com/IgorMinar/status/961484134425088001">3.2KB</a>, on a par with minimal framework like preact. Unfortunately little documentation, if any, exists to explain how Ivy works.</p>
<p>This blog post strives to fill this gap, by translating an amazing answer from <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/266923267/answer/316279829">zhihu</a>, a superior Q&amp;A website to Quora. I hope this post can communicate Angular‚Äôs innovation to broader front-end world by breaking language barrier.</p>
<blockquote>
<p>TL;DR: Ivy is an extremely building-tool friendly, web-first render engine that paves Angular‚Äôs way to web components.</p>
</blockquote>
<p>Opinion is not mine. Words in parentheses are from the original author unless explicitly annotated as from translator. Translator notes are added for audience with no Angular background.</p>
<h2 id="Orignal-post"><a href="#Orignal-post" class="headerlink" title="Orignal post:"></a>Orignal post:</h2><p>How to comment on the fact that Angular‚Äôs new Ivy render engine produces 3.2KB compiled JavaScript? <em>(traslator note: <code>how to comment</code> is a jargon on zhihu, meaning <code>what&#39;s your opinion</code>)</em></p>
<p>Let‚Äôs first answer several frequent questions:</p>
<ol>
<li><p>3.2KB is the result after minification + gzip (a convention to compare framework size), which is the exact payload size we send to browser. (if we use more advanced compression like brotli, the size will be smaller on modern browsers).</p>
</li>
<li><p>Ivy renderer won‚Äôt be default in Angular v6. You need to manually enable it by switching on certain compiler option. It might be default in v7 if no further issues are found.</p>
</li>
<li><p>Code completion isn‚Äôt proportional to feature completion. 50% code completed doesn‚Äôt imply 50% feature completed. For now Ivy has seemingly decent code completion rate, but it still has a long way before ready for production. It can‚Äôt even complete a simple app for <a target="_blank" rel="noopener" href="https://github.com/krausest/js-framework-benchmark">benchmark</a>.</p>
</li>
<li><p>Compared with previous Angular‚Äôs compiled code, Ivy‚Äôs result is almost like hand-written. And actually you can write it by hand! (Though in practice you won‚Äôt.)</p>
</li>
<li><p><code>NgModule</code> is challenged, <strong>again</strong>.</p>
</li>
<li><p>Ivy won‚Äôt promise you a plunge in code weight. Your bundle will still be bulky if a lot of CSS is inlined in your components.</p>
</li>
</ol>
<hr>
<p>Since the question is to <em>comment on</em> 3.2KB compiled file, I will focus on payload size optimization, thus, answering the question <em>‚ÄúWhat optimization has Ivy Renderer done?‚Äù.</em></p>
<p>It can never be overstated that the extreme size isn‚Äôt achieved by the ADVANCED mode of Closure Compiler. <strong>Rollup</strong> can achieve the same level optimization (within less than 1KB difference). Therefore Ivy is arguably the true <strong>building-tool friendly</strong> renderer, not Closure-Compiler-only renderer.</p>
<p>Disclaimer: all the below is based on current (Feb, 2018) implementation, published roadmap. If following version changes leads to the following content outdated or incorrect, please pardon our no updating.</p>
<h2 id="A-Removing-dependence-on-platform-browser"><a href="#A-Removing-dependence-on-platform-browser" class="headerlink" title="A. Removing dependence on platform-browser"></a>A. Removing dependence on <code>platform-browser</code></h2><p>As a platform independent framework, can we run application without platform specific code? The answer is NO, of course. Ivy just <strong>inlines DOM Rendere to its core.</strong> If you only need run your application on browser (taking no account of WebWorker), you can run Angular without including platform specific code. For example, the <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/92d7060cb086632d2188c8da37ff72838d1abeef/packages/core/src/render3/instructions.ts#L842-L845">code for binding text</a> is:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">value !== <span class="variable constant_">NO_CHANGE</span> &amp;&amp;</span><br><span class="line">  ((renderer <span class="keyword">as</span> <span class="title class_">ProceduralRenderer3</span>).<span class="property">setValue</span> ?</span><br><span class="line">    (renderer <span class="keyword">as</span> <span class="title class_">ProceduralRenderer3</span>).<span class="title function_">setValue</span>(existingNode.<span class="property">native</span>, <span class="title function_">stringify</span>(value)) :</span><br><span class="line">    existingNode.<span class="property">native</span>.<span class="property">textContent</span> = <span class="title function_">stringify</span>(value));</span><br></pre></td></tr></table></figure>

<p>Fallback code is obvious: if no <code>renderer</code> exists <em>(translator note: the condition is better explained as <code>renderer</code> isn‚Äôt a <code>ProceduralRenderer3</code>)</em>, Ivy will directly modify dom element‚Äôs <code>textContent</code>.</p>
<p>Currently no Ivy code relies on <code>platform</code>, thus common problems arise:</p>
<ul>
<li><p>No support for <a target="_blank" rel="noopener" href="https://angular.io/api/platform-browser/EVENT_MANAGER_PLUGINS">Event Plugin</a>. e.g. syntactic sugar for keyboard event (like <code>keydown.enter</code>) and events from Hammer, which are all provided by platform-browser.</p>
</li>
<li><p>No <code>Sanitizer</code>. Though Angular isn‚Äôt string template by itself and is naturally immune to XSS, it still cannot survive abhorrent abuse of <code>innerHTML</code>. <code>Sanitizer</code>, again currently bestowed by platform-browser, comes to rescue by filtering user content. Without platform hardly can we achieve the same level security.</p>
</li>
<li><p>No support for Component Style; No View Encapsulation. They are all implemented by different <code>Renderer</code>s in platform-browser package. Only inline style is available for component styling (Another better way is independent CSS and dynamic class).</p>
</li>
</ul>
<p>So the current Ivy renderer demoed in hello-world app isn‚Äôt a full featured Angular for some users.</p>
<h2 id="B-No-NgFactory-file-anymore"><a href="#B-No-NgFactory-file-anymore" class="headerlink" title="B. No NgFactory file anymore"></a>B. No NgFactory file anymore</h2><p>Under the new Ivy mode, compiled template will be stored in the static fields in class, instead of generating new wrapper class (NgFactory). For example:</p>
<p><code>Component</code> -&gt; <code>ngComponentDef</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyComponent</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> ngComponentDef = <span class="title function_">defineComponent</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Directive</code> -&gt; <code>ngDirectiveDef</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Directive</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDirective</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyDirective</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> ngDirectiveDef = <span class="title function_">defineDirective</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>NgModule</code> -&gt; <code>ngInjectorDef</code></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@NgModule</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyModule</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyModule</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> ngInjectorDef = <span class="title function_">defineInjector</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><del>WAT? How can Your Majesty NgModule compiled to one single Injector?(</del></p>
<p>Due to the colocation of compiled template and class, the new compilation can fully enjoy building tool‚Äôs normal optimization. (Tree-Shaking for the most part), waiving most special process in build-optimizer.</p>
<p><strong>In fact, this improvment is more significant for building than for size optimization.</strong> The new style compiler enables single file compilation, one ts file to one js file. We no longer need to worry about mapping from source file to ngfactory.</p>
<p>Further more, this unifies library consumption in JIT and AOT. Once the compilation is stabilized, all libraries can compile code before publication, rather than at end uses‚Äô bundling phase. This can lead to faster building.</p>
<h2 id="C-Greatly-simplify-bootstrap-code"><a href="#C-Greatly-simplify-bootstrap-code" class="headerlink" title="C. Greatly simplify bootstrap code"></a>C. Greatly simplify bootstrap code</h2><p>All Angular applications need to configure bootstrap component (actually it isn‚Äôt mandatory, but alternatives are more complex), and initialize one <code>NgModule[Factory]</code>. Something like:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">NgModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; platformBrowser &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/platform-browser&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">bootstrap</span>: [<span class="title class_">AppComponent</span>]</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppModule</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="title function_">platformBrowserDynamic</span>().<span class="title function_">bootstrapModule</span>(<span class="title class_">AppModule</span>)</span><br></pre></td></tr></table></figure>

<p>New bootstrapping code is based on component:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// not available yet</span></span><br><span class="line"><span class="keyword">import</span> &#123; renderComponent &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">renderComponent</span>(<span class="title class_">AppComponent</span>)</span><br></pre></td></tr></table></figure>

<p><del>Hey, why we still need AppModule?</del></p>
<p>Ivy is based on NgModule-less bootstrapping for now. Though not completed yet, compilers can make bootstrapping accept NgModule (if it still exists) to provide Injector. In other word, <code>renderComponent</code> can accept <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/92d7060cb086632d2188c8da37ff72838d1abeef/packages/core/src/render3/component.ts#L37">an optional configuration argument</a>.</p>
<p>By the way, this is also friendlier to bootstrapping multiple Angular instances in one page.</p>
<h2 id="D-Redesigned-DevMode-configuration-and-checking"><a href="#D-Redesigned-DevMode-configuration-and-checking" class="headerlink" title="D. Redesigned DevMode configuration and checking"></a>D. Redesigned DevMode configuration and checking</h2><p>In the previous Angular, <code>DevMode</code> is disabled by function call dynamically.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; enableProdMode &#125; <span class="keyword">from</span> <span class="string">&#x27;@angular/core&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">enableProdMode</span>()</span><br><span class="line"></span><br><span class="line"><span class="title function_">platformFoo</span>().<span class="title function_">bootstrapBar</span>(baz)</span><br></pre></td></tr></table></figure>

<p>In other word, whether DevMode is on is totally Angular‚Äôs <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/5.2.4/packages/core/src/application_ref.ts#L64-L67">internal state</a>. Thus all debug related code is dynamically used and cannot be excluded in compile time. (Even closure compiler is ineffective).</p>
<p>But in Ivy DevMode is purely compile time configuration, all debugging code will be executed after checking the global variable <code>ngDevMode</code>.  <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/92d7060cb086632d2188c8da37ff72838d1abeef/packages/core/src/render3/instructions.ts#L231">For example</a>:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ngDevMode &amp;&amp; <span class="title function_">assertEqual</span>((state <span class="keyword">as</span> <span class="title class_">LView</span>).<span class="property">node</span>, <span class="literal">null</span>, <span class="string">&#x27;lView.node&#x27;</span>);</span><br></pre></td></tr></table></figure>

<p>So building tool can replace the corresponding variable (e.g Webpack‚Äôs DefinePlugin), and corresponding debug code can be detected as dead code, and then optimizer (e.g UglifyJS) can remove it.</p>
<h2 id="E-Feature-named-as-Feature"><a href="#E-Feature-named-as-Feature" class="headerlink" title="E. Feature named as Feature"></a>E. Feature named as Feature</h2><p>Ivy mode has added a new feature called Feature. Or, Ivy introduces a new concept called Feature. Simply put, Feature is a pre-processor for <code>DirectiveDef</code>, which can be thought as a ‚ÄúDecorator pattern‚Äù tailored for <code>DirectiveDef</code>. <em>(Translator note: More simply, you can provide a custom function to Angular, and Angular will apply it against <code>ComponentDef</code> metadata. So you can extend <code>ComponentDef</code>‚Äòs <code>Feature</code> in your own function. <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/92d7060cb086632d2188c8da37ff72838d1abeef/packages/core/src/render3/definition.ts#L58-L59">Source</a>)</em>.</p>
<p>Let‚Äôs take an example in Ivy. <code>OnChanges</code> isn‚Äôt implemented by <code>Renderer</code> but a <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/92d7060cb086632d2188c8da37ff72838d1abeef/packages/core/src/render3/definition.ts#L71-L122">predefined <code>Feature</code></a>. The Feature uses <code>defineProperty</code> to listen on the property decorated by <code>@Input</code>, and automatically stores <code>previousValue</code> in the instance to generate <code>SimpleChanges</code> for change detection, and finally triggers <code>OnChanges</code> by intercepting <code>OnInit</code> and <code>DoCheck</code> without Angular core‚Äôs help.</p>
<p>This means <code>OnChanges</code>‚Äò code is also tree-shakable! If no component ever declares the lifecycle <code>ngOnChanges</code>, no <code>DirectiveDef</code> will import <code>NgOnChangesFeature</code>. So optimizer can reasonably eliminate dead code.</p>
<p><del>WAT? How about the dirty check promise? From now on we have exception in Angular‚Äôs change detection?!</del></p>
<p>So it is notable that <code>OnChanges</code> in Ivy is not a <a target="_blank" rel="noopener" href="https://github.com/angular/angular/blob/92d7060cb086632d2188c8da37ff72838d1abeef/packages/core/src/render3/definition.ts#L50-L56">real lifecycle</a> any more <em>(Translator note: it is not listed in the <code>ComponentDef</code>)</em>.<br>Put differently, users can extend lifecycle themselves, do as they please.</p>
<p>But the direct aim of Feature concept is for the incoming <a target="_blank" rel="noopener" href="https://github.com/angular/angular/issues/10185">LifeCycle as Observables</a>. Users don‚Äôt need to declare methods (ngOnInt) in class, but rather use the lifecycle observables directly. Indeed. by intercepting <code>DirectiveDef</code>, users and third-party library authors can modify lifecycle hooks in runtime. We can even use decorators to declare lifecycles.</p>
<p>In summary, <code>Feature</code> can be thought as a variant of <code>Higher Order Component</code> (compared with class factory): it modifies component type itself based on runtime requirement, instead of changing component‚Äôs internal state according to component logic.</p>
<h2 id="F-New-Injectable-API"><a href="#F-New-Injectable-API" class="headerlink" title="F. New Injectable API"></a>F. New Injectable API</h2><p>Actually this isn‚Äôt related to the hello-world demo, nor related to even Ivy (since it can be used in non Ivy mode). However, the new Injectable API has a huge impact on Angular‚Äôs size.</p>
<p>Besides the <code>XXXDef</code> properties listed above, we have another one called <code>ngInjectableDef</code>:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyService</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// -&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line">  <span class="keyword">static</span> ngInjectableDef = <span class="title function_">defineInjectable</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In classical sense (if anyone ever cared), we can easily find <strong>dependency injection and dead code elimination are contradictory in priciple</strong>.</p>
<ul>
<li><p>DI‚Äôs nature is side effect: <code>Provider</code> <em>changes</em> execution context via configuration, and <code>Consumer</code> retrieves content <em>from context</em>.</p>
</li>
<li><p>DCE‚Äôs assumption is side-effect-free: <code>Consumer</code> should import <code>Provider</code> directly, and if <code>Consumer</code> doesn‚Äôt exist in application, <code>Provider</code> can be removed at all.</p>
</li>
</ul>
<p>Apparently, all DI based code cannot be effectively DCE optimized.</p>
<p>In current Angular pattern, we will configure <code>Provider</code> in <code>NgModule</code>:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.service.ts</span></span><br><span class="line"><span class="meta">@Injectable</span>()</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibService</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LibService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./lib.service&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">providers</span>: [<span class="title class_">LibService</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibModule</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LibService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./lib.service&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">libService: LibService</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LibModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./lib.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [<span class="title class_">AppComponent</span>],</span><br><span class="line">  <span class="attr">imports</span>: [<span class="title class_">LibModule</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>The dependence flow is: <em>(translator note: in the below items parentheses after is added by translator for Angular newcomer)</em></p>
<ul>
<li>Library Module imports Library Service <em>(for exposing interface and providing implementation)</em></li>
<li>Application Component imports Library Service <em>(for consuming interface)</em></li>
<li>Application Module imports  Application Component</li>
<li>Application Module imports Library Module <em>(for configuring which implementation to inject)</em></li>
</ul>
<p>Even if service isn‚Äôt used in application component, service cannot be removed. This is because we introduce additional dependence during DI configuration. <em>(translator note: consider app component doesn‚Äôt import libService. It is desirable libService is excluded from final build. But we cannot eliminate it because libModule imports it, and libModule is further imported by application module)</em></p>
<p>To solve this problem, Angular allows to invert the dependence of configuration. The new API is like:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lib.module.ts</span></span><br><span class="line"><span class="meta">@NgModule</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibModule</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lib.service.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LibModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./lib.module&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Injectable</span>(&#123; <span class="attr">scope</span>: <span class="title class_">LibModule</span> &#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LibService</span> &#123; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.component.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LibService</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./lib.service&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@Component</span>(&#123; <span class="comment">/*...*/</span> &#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppComponent</span> &#123;</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params">libService: LibService</span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// app.module.ts</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">LibModule</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./lib.module&#x27;</span></span><br><span class="line"><span class="keyword">import</span> &#123; <span class="title class_">AppComponent</span> &#125; <span class="keyword">from</span> <span class="string">&#x27;./app.component&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@NgModule</span>(&#123;</span><br><span class="line">  <span class="attr">declarations</span>: [<span class="title class_">AppComponent</span>],</span><br><span class="line">  <span class="attr">import</span>: [<span class="title class_">LibModule</span>],</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">AppModule</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>The new dependence flow is:</p>
<ul>
<li>Library Service imports Library Module</li>
<li>Application Component imports Library Service</li>
<li>Application Module imports  Application Component</li>
<li>Application Module imports Library Module</li>
</ul>
<p>Thus, as long as application component is removed, library service is not depended at all and can be safely removed together.</p>
<p><del>WAT? So why is libModule there? As a cosmetic?</del></p>
<p>We can optionally choose providers like <code>useClass</code>, <code>useFactory</code> to set implementation to other values instead of current class.<br><em>(translator note: they are Angular‚Äôs alternative DI functions and are DCE ready)</em></p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Injectable</span>(&#123;</span><br><span class="line">  <span class="attr">scope</span>: <span class="title class_">SomeModule</span>,</span><br><span class="line">  <span class="attr">useValue</span>: &#123; <span class="attr">valueOfLife</span>: <span class="number">42</span> &#125;,</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">abstract</span> <span class="keyword">class</span> <span class="title class_">MyService</span> &#123;</span><br><span class="line">  <span class="keyword">abstract</span> <span class="attr">valueOfLife</span>: <span class="built_in">number</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Of course, the new Injectable API only handles one ideal situation where <strong>dependency declared</strong> is <strong>dependency used</strong>. Nevertheless this is the most common situation. If intermediate Injector nodes overrides <code>Provider</code>, side effect is still ineluctable and thus adds code size. (But the injected dependency is probably used when one does override)</p>
<h2 id="G-New-template-compilation"><a href="#G-New-template-compilation" class="headerlink" title="G. New template compilation"></a>G. New template compilation</h2><p>Template compilation, at macro level, <strong>has only two types:</strong></p>
<ul>
<li>(structural) data</li>
<li>(operational) instructions</li>
</ul>
<p>Take a simple example. If we compile template (or equivalent) to some <code>render</code> method and if:</p>
<ul>
<li>calling <code>render</code> <strong>doesn‚Äôt make view changed</strong>, but its return value is <strong>what to be rendered</strong>. This is the former type.</li>
<li>calling <code>render</code> <strong>does update view</strong>, and thus <strong>no return value is needed</strong>. This is the latter type.</li>
</ul>
<p>The most early Angular, v2 version, compiles template to instructions. One can refer to <a target="_blank" rel="noopener" href="https://www.zhihu.com/question/53434390/answer/134956516">this zhihu answer</a> for compilation behavior. This style is very similar to <a target="_blank" rel="noopener" href="https://github.com/sveltejs/svelte">Svelte</a>: compile as much detail as possible, in order to reduce common runtime dependency (shared code).</p>
<p>But the problem of this approach is obvious. With more and more template authored, compiled code size will easily exceed shared code (Off-topic: the 0kb-boasting framework Svelte also provides a <code>shared</code> compile option to use library).</p>
<p>Later Angular v4 compiles template to data and introduces <em>View Engine</em> as common dependency. Its compilation is explained <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/32137489">here</a>. This style is very close to virtual dom, except that dom-like data is stored per type, not per instance.</p>
<p>Ivy renderer in v6 re-chooses compiling to instruction approach. Different from v2, v6 employs a strategy to minimize compiled code size.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">AppComponent</span>  &#123;</span><br><span class="line">  <span class="keyword">static</span> ngComponentDef = <span class="title function_">defineComponent</span>(&#123;</span><br><span class="line">    <span class="attr">type</span>: <span class="title class_">AppComponent</span>,</span><br><span class="line">    <span class="attr">tag</span>: <span class="string">&#x27;my-app&#x27;</span>,</span><br><span class="line">    <span class="attr">template</span>: <span class="keyword">function</span> <span class="title function_">AppComponent_Template</span>(<span class="params">comp: AppComponent, cm: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (cm) &#123;</span><br><span class="line">        <span class="title function_">E</span>(<span class="number">0</span>, <span class="string">&#x27;div&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;container&#x27;</span>])</span><br><span class="line">          <span class="title function_">E</span>(<span class="number">1</span>, <span class="string">&#x27;div&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;jumbotron&#x27;</span>])</span><br><span class="line">            <span class="title function_">E</span>(<span class="number">2</span>, <span class="string">&#x27;div&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;row&#x27;</span>])</span><br><span class="line">              <span class="title function_">E</span>(<span class="number">3</span>, <span class="string">&#x27;div&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;col-md-6&#x27;</span>])</span><br><span class="line">                <span class="title function_">E</span>(<span class="number">4</span>, <span class="string">&#x27;h1&#x27;</span>)</span><br><span class="line">                  <span class="title function_">T</span>(<span class="number">5</span>, <span class="string">&#x27;Angular v6.x.x (Ivy Renderer)&#x27;</span>)</span><br><span class="line">                <span class="title function_">e</span>()</span><br><span class="line">              <span class="title function_">e</span>()</span><br><span class="line">              <span class="title function_">E</span>(<span class="number">6</span>, <span class="string">&#x27;div&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;col-md-6&#x27;</span>])</span><br><span class="line">                <span class="title function_">E</span>(<span class="number">7</span>, <span class="string">&#x27;div&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;col-sm-6 smallpad&#x27;</span>])</span><br><span class="line">                  <span class="title function_">E</span>(<span class="number">8</span>, <span class="string">&#x27;button&#x27;</span>, [<span class="string">&#x27;type&#x27;</span>, <span class="string">&#x27;button&#x27;</span>, <span class="string">&#x27;id&#x27;</span>, <span class="string">&#x27;run&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;btn btn-primary btn-block&#x27;</span>])</span><br><span class="line">                    <span class="title function_">L</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">() =&gt;</span> &#123;</span><br><span class="line">                      comp.<span class="title function_">run</span>()</span><br><span class="line">                      <span class="title function_">detectChanges</span>(comp)</span><br><span class="line">                    &#125;)</span><br><span class="line">                    <span class="title function_">T</span>(<span class="number">9</span>, <span class="string">&#x27;Create 1,000 rows&#x27;</span>)</span><br><span class="line">                  <span class="title function_">e</span>()</span><br><span class="line">                  <span class="comment">//...</span></span><br><span class="line">                <span class="title function_">e</span>()</span><br><span class="line">              <span class="title function_">e</span>()</span><br><span class="line">            <span class="title function_">e</span>()</span><br><span class="line">          <span class="title function_">e</span>()</span><br><span class="line">          <span class="title function_">E</span>(<span class="number">20</span>, <span class="string">&#x27;table&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;table table-hover table-striped test-data&#x27;</span>])</span><br><span class="line">            <span class="title function_">E</span>(<span class="number">21</span>, <span class="string">&#x27;tbody&#x27;</span>)</span><br><span class="line">              <span class="title function_">C</span>(<span class="number">22</span>, [<span class="title class_">NgForOf</span>], trTemplate)</span><br><span class="line">            <span class="title function_">e</span>()</span><br><span class="line">          <span class="title function_">e</span>()</span><br><span class="line">          <span class="title function_">E</span>(<span class="number">24</span>, <span class="string">&#x27;span&#x27;</span>, [<span class="string">&#x27;aria-hidden&#x27;</span>, <span class="string">&#x27;true&#x27;</span>, <span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;preloadicon glyphicon glyphicon-remove&#x27;</span>])</span><br><span class="line">          <span class="title function_">e</span>()</span><br><span class="line">        <span class="title function_">e</span>()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="title function_">p</span>(<span class="number">22</span>, <span class="string">&#x27;ngForOf&#x27;</span>, <span class="title function_">b</span>(comp.<span class="property">data</span>))</span><br><span class="line">      <span class="title function_">p</span>(<span class="number">22</span>, <span class="string">&#x27;ngForTrackBy&#x27;</span>, <span class="title function_">b</span>(comp.<span class="property">itemById</span>))</span><br><span class="line">      <span class="title function_">cR</span>(<span class="number">22</span>)</span><br><span class="line">        <span class="title function_">r</span>(<span class="number">23</span>, <span class="number">0</span>)</span><br><span class="line">      <span class="title function_">cr</span>()</span><br><span class="line"></span><br><span class="line">      <span class="keyword">function</span> <span class="title function_">trTemplate</span>(<span class="params">row: NgForOfContext&lt;Data&gt;, cm: <span class="built_in">boolean</span></span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cm) &#123;</span><br><span class="line">          <span class="title function_">E</span>(<span class="number">0</span>, <span class="string">&#x27;tr&#x27;</span>)</span><br><span class="line">            <span class="title function_">E</span>(<span class="number">1</span>, <span class="string">&#x27;td&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;col-md-1&#x27;</span>])</span><br><span class="line">              <span class="title function_">T</span>(<span class="number">2</span>)</span><br><span class="line">            <span class="title function_">e</span>()</span><br><span class="line">            <span class="title function_">E</span>(<span class="number">3</span>, <span class="string">&#x27;td&#x27;</span>, [<span class="string">&#x27;class&#x27;</span>, <span class="string">&#x27;col-md-4&#x27;</span>])</span><br><span class="line">              <span class="title function_">E</span>(<span class="number">4</span>, <span class="string">&#x27;a&#x27;</span>, [<span class="string">&#x27;href&#x27;</span>, <span class="string">&#x27;#&#x27;</span>])</span><br><span class="line">                <span class="title function_">L</span>(<span class="string">&#x27;click&#x27;</span>, <span class="function">(<span class="params">e: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">                  comp.<span class="title function_">select</span>(row.<span class="property">$implicit</span>, e)</span><br><span class="line">                  <span class="title function_">detectChanges</span>(comp)</span><br><span class="line">                &#125;)</span><br><span class="line">                <span class="title function_">T</span>(<span class="number">5</span>)</span><br><span class="line">              <span class="title function_">e</span>()</span><br><span class="line">            <span class="title function_">e</span>()</span><br><span class="line">            <span class="comment">//...</span></span><br><span class="line">          <span class="title function_">e</span>()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="title function_">p</span>(<span class="number">0</span>, <span class="string">&#x27;class.danger&#x27;</span>, <span class="title function_">b</span>(row.<span class="property">$implicit</span>.<span class="property">id</span> === comp.<span class="property">selected</span>))</span><br><span class="line">        <span class="title function_">t</span>(<span class="number">2</span>, <span class="title function_">b</span>(row.<span class="property">$implicit</span>.<span class="property">id</span>))</span><br><span class="line">        <span class="title function_">t</span>(<span class="number">5</span>, <span class="title function_">b</span>(row.<span class="property">$implicit</span>.<span class="property">label</span>))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">factory</span>: <span class="function">() =&gt;</span> <span class="keyword">new</span> <span class="title class_">AppComponent</span>()</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><em>(The density of information is almost as high as HTML.)</em></p>
<p>Compiling to instructions has another advantage over compiling to data: common dependency is still DCE friendly.<br>Used instructions will be directly depended, and non-used instructions will be removed by optimizer.<br>On the other hand compiling to data requires all operations used by template processor, and thus cannot be optimized statically.</p>
<p>Therefore, Ivy‚Äôs new compilation strategy should be the one with minimal code size (not regarding of the cost to implement compiler).</p>
<h2 id="Memory-and-Speed"><a href="#Memory-and-Speed" class="headerlink" title="Memory and Speed"></a>Memory and Speed</h2><ul>
<li>New view layer employs compact binary frame design (and more bitwise operations).</li>
<li>New view layer uses as many sequences (arrays) as possible rather than key-value pairs (objects) to store data.</li>
<li>New view layer prefers adding expando properties on exposing types rather than new wrapping type.</li>
<li>DI uses <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Bloom_filter">bloom filter</a> to speed up <code>Directive</code> searching</li>
</ul>
<p>(View layer is less friendly to pull request)</p>
<h2 id="Summary"><a href="#Summary" class="headerlink" title="Summary"></a>Summary</h2><p>The new Ivy mode push ‚Äúbuilding-friendliness‚Äù to extreme, but you can also say it is not ‚Äúnon-building-friendly‚Äù. It won‚Äôt be useful for projects built with bare <code>&lt;script&gt;</code> tags.</p>
<p>Ivy‚Äôs most crucial target is cooperation with <a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/30717321">Angular Element</a>. By encapsulating Angular components to custom elements (web components), we can achieve standalone publication, independent importing and independent usage of Angular as widgets. (To some degree this strangulates Svelte?)</p>
<p>The most important part of this strategy is code size. Even wihout common runtime library, Angular should work with minial size.<br>Components used as Angular Elements will not depended on external packages like forms and router, hence creating great value for size reduction.</p>
<p>Whether should NgModule still exist? It certainly has value on organizing code. That said, Dart version didn‚Äôt ever has NgModule. It is sure that application structure can be well formed without NgModule (at least for Googler).<br>With decreasing usage of NgModule in real world API, it might be optional in future. But I‚Äôm sure v6 won‚Äôt change NgModule. (I personally favor NgModule, but oppose enforcing it in app).</p>
<p>For applications plumbing many third party libraries, the main size problem might not come from Angular but rather from, for example, incorrect use of RxJS, importing <code>moment.js</code> inadvertently, or writing all styles in ‚Äúcomonent styles‚Äù. For specific size problem one needs to analyze it specifically. Don‚Äôt pray to Angular‚Äôs advanced optimizer.</p>
<p>The worst part of Ivy is <code>OnChanges</code>. It is now implemented by <code>Object.defineProperty</code>! It is no longer right to say Angular is based <strong>solely</strong> on dirty check. All articles about change detection need updating! And every section needs separate explaination!</p>
<p>Lifecycles might have big change in near future. But it will await Ivy being the default, no earlier than v7. In fact, Angular‚Äôs overall extensibility and runtime preprocessing has been greatly improved.</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-vue-ts3" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/10/12/vue-ts3/">Deep dive into Vue2.5 Typing -- A tour of advanced typing feature</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-10-12T07:00:00.000Z" itemprop="datePublished">October 12, 2017, 12:00 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>Vue 2.5 improves TypeScript definition! Before that, TS users will have to use class component API to get proper typing, but now canonical API is both precise and concise with few compromises!</p>
<p>For ordinary users, Vue‚Äôs <a target="_blank" rel="noopener" href="https://medium.com/the-vue-point/upcoming-typescript-changes-in-vue-2-5-e9bd7e2ecf08">official blog</a> and <a target="_blank" rel="noopener" href="https://vuejs.org/v2/guide/typescript.html">updated documentation</a> will guide you to upgrade or create projects.<br>But curious audience might wonder how the improvement is done and why TS support isn‚Äôt integrated in Vue2.0 at first place.</p>
<p>This blog post will deep dive into the technical details of Vue2.5 typing, which seems <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue/blob/dev/types/options.d.ts#L54">daunting</a> at first glance. Don‚Äôt worry! We will show how TypeScript‚Äôs <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/advanced-types.html">advanced types</a> can be used in a popular framework.</p>
<blockquote>
<p>Note: Reader‚Äôs familiarity with Vue and TypeScript is assumed in this post. If you are new to these two, checkout their <a target="_blank" rel="noopener" href="https://vuejs.org/">official</a> <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/home.html">website</a>!</p>
</blockquote>
<h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR;"></a>TL;DR;</h2><p>Vue2.5 exploits <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/pull/14141">ThisType</a>, <a target="_blank" rel="noopener" href="https://blog.mariusschulz.com/2017/01/20/typescript-2-1-mapped-types">mapped type</a>, <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-2-3.html#generic-parameter-defaults">generic defaults</a> and a clever trick to cover most APIs.</p>
<p>We will also list some limitations in current typing schema.</p>
<h2 id="this-is-Vue"><a href="#this-is-Vue" class="headerlink" title="this is Vue"></a><code>this</code> is Vue</h2><p>Let‚Äôs examine a basic Vue usage. We pass an object literal as component option to Vue constructor.</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">greet</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$el</span> <span class="comment">// `this` is Vue</span></span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&#x27;Hello World!&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p><code>this</code> keyword is bound to Vue instance in component option. Prior to Vue2.5, we declare <code>this</code> as a plain Vue type. Here is a simplified <code>ComponentOption</code> type.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ComponentOption</span> &#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="function">(<span class="params"><span class="variable language_">this</span>: Vue</span>) =&gt;</span> <span class="built_in">any</span> &#125;</span><br><span class="line">  <span class="comment">// other fields ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>However, we cannot access our custom methods&#x2F;data via the declaration above since <code>this</code> is nothing but Vue. The typing doesn‚Äôt capture the fact that the VM injected into methods is instantiated with our custom methods&#x2F;data&#x2F;props.</p>
<p>A new type parameter <code>V</code> can allow users to specify their custom properties. So a better solution will be:</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ComponentOption</span>&lt;V <span class="keyword">extends</span> <span class="title class_">Vue</span>&gt; &#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123; [<span class="attr">key</span>: <span class="built_in">string</span>]: <span class="function">(<span class="params"><span class="variable language_">this</span>: V</span>) =&gt;</span> <span class="built_in">void</span> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And users can use it like this.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> newVue&lt;V <span class="keyword">extends</span> <span class="title class_">Vue</span>&gt;(<span class="attr">option</span>: <span class="title class_">ComponentOption</span>&lt;V&gt;): V</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">MyComponent</span> <span class="keyword">extends</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line">  <span class="title function_">greet</span>(<span class="attr">str</span>: <span class="built_in">string</span>): <span class="built_in">void</span></span><br><span class="line">  <span class="title function_">hello</span>(): <span class="built_in">void</span></span><br><span class="line">&#125;</span><br><span class="line">newVue&lt;<span class="title class_">MyComponent</span>&gt;(&#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">greet</span>(<span class="params">str</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(str)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">greet</span>(<span class="string">&#x27;hello world&#x27;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>It works, but also requires one interface declaration and one explicit type annotation.<br>Can compiler be smarter and infer this for us?</p>
<h2 id="ThisType-lt-Vue-gt"><a href="#ThisType-lt-Vue-gt" class="headerlink" title="ThisType&lt;Vue&gt;"></a><code>ThisType&lt;Vue&gt;</code></h2><p>We can strongly type <code>this</code> by a special marker interface <code>ThisType</code>. It is introduced in TypeScript 2.3, which is the very reason why we didn‚Äôt have strong type until Vue2.5.</p>
<p>The original <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/pull/14141">pull request</a> has a detailed introduction and example for <code>ThisType</code>.</p>
<p>The most important rule is quoted here.</p>
<blockquote>
<p>(If) the containing object literal has a contextual type that includes a <code>ThisType&lt;T&gt;</code>, <code>this</code> has type T</p>
</blockquote>
<p>What does this mean? Let‚Äôs break this rule down to several pieces.</p>
<p><code>object literal</code> means the component option in Vue‚Äôs case; <code>contextual type</code> means the component option is passed to a function as argument and the component option is typed via function declaration, without caller‚Äôs annotation; and finally <code>ThisType&lt;T&gt;</code> needs to be used in the function parameter declaration. The type parameter <code>T</code> refers to the type of <code>this</code> in the component option. In simple terms, this rule says we can change <code>this</code> keyword‚Äôs type according to the component option passed to <code>new Vue</code> or so.</p>
<p>Combining these together, we can write a simple declaration that understands our Vue component option.</p>
<blockquote>
<p>Note, you will need <code>noImplicitThis</code> compiler flag to enable this new type checking.</p>
</blockquote>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ComponentOption</span>&lt;<span class="title class_">Method</span>&gt; &#123;</span><br><span class="line">  <span class="attr">methods</span>: <span class="title class_">Method</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> newVue&lt;<span class="title class_">Method</span>&gt;(</span><br><span class="line">  <span class="attr">option</span>: <span class="title class_">ComponentOption</span>&lt;<span class="title class_">Method</span>&gt; &amp; <span class="title class_">ThisType</span>&lt;<span class="title class_">Method</span> &amp; <span class="title class_">Vue</span>&gt;</span><br><span class="line">): <span class="title class_">Vue</span>&amp;<span class="title class_">Method</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Method is inferred as</span></span><br><span class="line"><span class="comment">// &#123; greet(str): void, hello(): void &#125;</span></span><br><span class="line"><span class="title function_">newVue</span>(&#123;</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">greet</span>(<span class="params">str</span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(str)</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">hello</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="comment">// this is typed as Method &amp; Vue</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="title function_">greet</span>(<span class="string">&#x27;hello world&#x27;</span>)   <span class="comment">// custom methods works!</span></span><br><span class="line">      <span class="variable language_">this</span>.<span class="property">$el</span> <span class="comment">// vue property also works!</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>This code needs some explanation. First we define an <code>ComponentOption</code> and it takes a type parameter <code>Method</code>, which acts as a ‚Äústub‚Äù for compiler to infer custom properties on <code>this</code>.<br>Then in the function we declare a type parameter <code>Method</code> again and pass it to <code>ComponentOption</code> and <code>ThisType</code>.<br>Finally, <code>ThisType&lt;Method &amp; Vue&gt;</code> means the type of <code>this</code> inside option will be an intersection of <code>Vue</code> and <code>Method</code>.</p>
<p>When we call <code>newVue</code>, compiler will first infer <code>Method</code> from <code>ComponentOption</code> object we pass to the function. Then the <code>Method</code> will flow into <code>this</code> keyword, resulting a type that has both Vue property and our own methods.</p>
<h2 id="Mapping-Computed"><a href="#Mapping-Computed" class="headerlink" title="Mapping Computed"></a>Mapping Computed</h2><p>Typing <code>methods</code> alone is so far so good. However fields like <code>computed</code> have a different story.<br>The object in <code>methods</code> field has the same shape as part of <code>this</code> type. Say, <code>methods</code> has a <code>hello</code> function property and <code>this</code> also has a function property with the same name (in algebraic terms, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Homomorphism#Endomorphism">endomorphism</a>). But a property in <code>computed</code> is a function that returns a value and <code>this</code> has a namesake property with the same value type. For example.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="title function_">newVue</span>(&#123;</span><br><span class="line">  <span class="attr">computed</span>: &#123;</span><br><span class="line">    <span class="attr">myname</span>: <span class="function">() =&gt;</span> <span class="string">&#x27;world&#x27;</span> <span class="comment">// a function returns string</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">methods</span>: &#123;</span><br><span class="line">    <span class="title function_">greet</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="variable language_">this</span>.<span class="property">myname</span>)</span><br><span class="line">      <span class="comment">// myname is a string, not a function returning string</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>How can we get a new type from <code>computed</code> definition object?</p>
<p>Here comes the mapped type, a new kind of object type that maps a type representing property names over a property declaration template. In other words, we can create computed type in Vue instance based on that in component option. (algebraically, <a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Homomorphism#Definition">homomorphism</a>)</p>
<blockquote>
<p>In a mapped type, the new type transforms each property in the old type in the same way.</p>
</blockquote>
<p>The <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#mapped-types">official documentation</a> is crystal clear. Let‚Äôs see how we integrate this awesomeness into Vue.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// we map a plain type to a type of which the property is a function</span></span><br><span class="line"><span class="comment">// e.g. &#123; myname: string &#125; will be mapped to &#123; myname: () =&gt; string &#125;</span></span><br><span class="line"><span class="comment">// note this process can also be reversed during type inference</span></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Accessors</span>&lt;T&gt; = &#123; [K <span class="keyword">in</span> keyof T]: <span class="function">() =&gt;</span> T[K] &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ComponentOption</span>&lt;<span class="title class_">Method</span>, <span class="title class_">Computed</span>&gt; &#123;</span><br><span class="line">  <span class="attr">methods</span>: <span class="title class_">Method</span></span><br><span class="line">  <span class="attr">computed</span>: <span class="title class_">Accessors</span>&lt;<span class="title class_">Computed</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">ThisTypedOption</span>&lt;<span class="title class_">Method</span>, <span class="title class_">Computed</span>&gt; =</span><br><span class="line">  <span class="title class_">ComponentOption</span>&lt;<span class="title class_">Method</span>, <span class="title class_">Computed</span>&gt; &amp; <span class="title class_">ThisType</span>&lt;<span class="title class_">Method</span> &amp; <span class="title class_">Computed</span> &amp; <span class="title class_">Vue</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> newVue&lt;<span class="title class_">Method</span>, <span class="title class_">Computed</span>&gt;(</span><br><span class="line">  <span class="attr">option</span>: <span class="title class_">ThisTypedOption</span>&lt;<span class="title class_">Method</span>, <span class="title class_">Computed</span>&gt;</span><br><span class="line">): <span class="title class_">Method</span> &amp; <span class="title class_">Computed</span> &amp; <span class="title class_">Vue</span></span><br></pre></td></tr></table></figure>

<p><code>Accessors&lt;T&gt;</code> will map the type <code>T</code> to a new type with same property names. But property value type is a function returning the type in the original <code>T</code>. This process is reversed during type inference.  When we pass <code>computed</code> field as <code>&#123;myname: () =&gt; string&#125;</code> to <code>newVue</code> function, compiler will try to map the type to <code>Accessors&lt;T&gt;</code>, which results in <code>Computed</code> being <code>&#123;myname: string&#125;</code>.</p>
<p>And <code>Computed</code> is mixed into <code>this</code>, so we can access <code>myname</code> as <code>string</code> from <code>this</code>.</p>
<p>We skipped here <a target="_blank" rel="noopener" href="https://vuejs.org/v2/guide/computed.html#Computed-Setter">computed setter style</a> declaration for a more lucid demonstration. Supporting setter in <code>computed</code> is similar.</p>
<h2 id="Prop-Types-Trick"><a href="#Prop-Types-Trick" class="headerlink" title="Prop Types Trick"></a>Prop Types Trick</h2><p><code>props</code> has a subtle difference from <code>computed</code>: we define a <code>prop</code> by giving a constructor of that value type.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">PropDef</span>&lt;T&gt; = &#123; <span class="title function_">new</span>(...<span class="attr">args</span>: <span class="built_in">any</span>[]): T &#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Props</span>&lt;T&gt; = &#123; [K <span class="keyword">in</span> keyof T]: <span class="title class_">PropDef</span>&lt;T[K]&gt; &#125;</span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">ComponentOption</span>&lt;<span class="title class_">Prop</span>&gt; &#123;</span><br><span class="line">  <span class="attr">props</span>: <span class="title class_">Props</span>&lt;<span class="title class_">Prop</span>&gt;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">ThisTypedOption</span>&lt;<span class="title class_">Prop</span>&gt; =</span><br><span class="line">  <span class="title class_">ComponentOption</span>&lt;<span class="title class_">Prop</span>&gt; &amp; <span class="title class_">ThisType</span>&lt;<span class="title class_">Prop</span> &amp; <span class="title class_">Vue</span>&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> newVue&lt;<span class="title class_">Prop</span>&gt;(<span class="attr">option</span>: <span class="title class_">ThisTypedOption</span>&lt;<span class="title class_">Prop</span>&gt;): <span class="title class_">Prop</span> &amp; <span class="title class_">Vue</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">User</span> &#123;&#125;</span><br><span class="line"><span class="title function_">newVue</span>(&#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">user</span>: <span class="title class_">User</span>,</span><br><span class="line">    <span class="attr">name</span>: <span class="title class_">String</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>One would naturally expect <code>newVue</code> will infer <code>Prop</code> as <code>&#123; user: User, name: string &#125;</code>. Sadly, it is not.</p>
<p>The problem lies in <code>PropDef</code>, which uses constructor type <code>new(): T</code>. Custom constructor is fine. For example <code>User</code>‚Äòs  constructor returns <code>User</code>. But primitive value‚Äôs constructor doesn‚Äôt work because <code>String</code> has the signature <code>new(): String</code>.</p>
<p>Alas! The return value is <code>String</code>, rather than <code>string</code>. Their difference is listed in the <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/declaration-files/do-s-and-don-ts.html">first rule</a> of <em>TypeScript Do‚Äôs and Don‚Äôts</em>. A <code>string</code> type is what we use and <code>String</code> refers to non-primitive boxed objects that are almost never used.</p>
<p>We can use another signature to type primitive constructor and <a target="_blank" rel="noopener" href="https://www.typescriptlang.org/docs/handbook/advanced-types.html#union-types">union</a> custom constructor together. Note every primitive constructor has a call signature, that is, <code>String(value)</code> will return a primitive <code>string</code> value rather than a wrapper object.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">PropDef</span>&lt;T&gt; = &#123; (): T &#125; | &#123; <span class="title function_">new</span>(...<span class="attr">args</span>: <span class="built_in">any</span>[]): T &#125;</span><br></pre></td></tr></table></figure>

<p>It should work, shouldn‚Äôt it? Sadly again, NO.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> propTest&lt;T&gt;(<span class="attr">t</span>: <span class="title class_">PropDef</span>&lt;T&gt;): T</span><br><span class="line"><span class="title function_">propTest</span>(<span class="title class_">String</span>) <span class="comment">// return String, not string!</span></span><br></pre></td></tr></table></figure>

<p>Because <code>String</code> satisfy both call and constructor signature in <code>PropDef</code>, compiler will prefer returning <code>String</code>.</p>
<p>How can we nudge compiler to prefer primitive type? <a target="_blank" rel="noopener" href="https://github.com/HerringtonDarkholme/av-ts/issues/62">Here</a> is an undocumented trick.<br>The main idea is to exploit <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/blob/8e47c18636da814117071a2640ccf87c5f16fcfd/src/compiler/types.ts#L3563-L3583">type inference priority</a>. If a type parameter is single naked, that is, not in <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/pull/3622#issuecomment-116888221">intersection type</a> nor in <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/pull/1035">union type</a>, compiler will prefer to infer from that single naked position over intersection&#x2F;union position. So we can add an intersection to constructor signature and then compiler will first infer call signature. Exactly what we want! To make the signature more self explanatory, we can use the <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/pull/12501"><code>object</code> type</a> to flag constructor type should not return primitive type.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">PropDef</span>&lt;T&gt; = &#123; (): T &#125; | &#123; <span class="title function_">new</span>(...<span class="attr">args</span>: <span class="built_in">any</span>[]): T &amp; <span class="built_in">object</span> &#125;</span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> propTest&lt;T&gt;(<span class="attr">t</span>: <span class="title class_">PropDef</span>&lt;T&gt;): T</span><br><span class="line"><span class="title function_">propTest</span>(<span class="title class_">String</span>) <span class="comment">// return string, yay!</span></span><br></pre></td></tr></table></figure>

<p>Now we can happily infer <code>props</code> without manual annotation!</p>
<h2 id="Compatibility"><a href="#Compatibility" class="headerlink" title="Compatibility"></a>Compatibility</h2><p>For better inference, our new type has many more type parameters than original <code>ComponentOption&lt;V&gt;</code> which only has one parameter. Nevertheless, it will be a catastrophic breaking change if we ship the new type without proper fallback. <a target="_blank" rel="noopener" href="https://blog.mariusschulz.com/2017/06/02/typescript-2-3-generic-parameter-defaults">Generic defaults</a> introduced in TS2.3 gives us a chance to bring about a more smooth upgrade.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">interface</span> <span class="title class_">ComponentOption</span>&lt;V <span class="keyword">extends</span> <span class="title class_">Vue</span>, <span class="title class_">Method</span>=<span class="built_in">any</span>, <span class="title class_">Data</span>=<span class="built_in">any</span>, <span class="title class_">Prop</span>=<span class="built_in">any</span>, <span class="title class_">Computed</span>=<span class="built_in">any</span>&gt; &#123;</span><br><span class="line">  <span class="comment">// ....</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">MyVue</span> <span class="keyword">extends</span> <span class="title class_">Vue</span> &#123;</span><br><span class="line"> <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// users can use ComponentOption without changing their code</span></span><br><span class="line"><span class="comment">// parameter with default can be skipped</span></span><br><span class="line"><span class="keyword">var</span> <span class="attr">option</span>: <span class="title class_">ComponentOption</span>&lt;<span class="title class_">MyVue</span>&gt; = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Happy ending!</p>
<h2 id="Limitation"><a href="#Limitation" class="headerlink" title="Limitation"></a>Limitation</h2><p>The ‚ÄúNo silver bullet‚Äù rule also applies to typing. <strong>The more advanced types we use, the more complex error messages will be generated.</strong> Hope this blog post will help you to understand the new typing better and help you to debug your own application.</p>
<p>There are also some type system limitations in Vue typing. Let‚Äôs see some examples.</p>
<ul>
<li>functions in <code>computed</code> need return type annotation</li>
</ul>
<p>Return type annotation is required if <code>computed</code> method uses <code>this</code>. It turns out that using mapped type and ThisType at the same time without explicit annotation will cause cyclic inference error in current compiler.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span><br><span class="line">  <span class="attr">computed</span>: &#123;</span><br><span class="line">    <span class="title function_">foo</span>(<span class="params"></span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">123</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="title function_">bar</span>(): <span class="built_in">number</span> &#123; <span class="comment">// required</span></span><br><span class="line">      <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="property">foo</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>TypeScript has already opened an <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/issues/18805">issue</a> tracking this.</p>
<ul>
<li>Prop types‚Äô union declaration requires manual type cast</li>
</ul>
<p>Vue accepts an array of constructors in prop‚Äôs definition as union type. However, <code>PropDef</code> cannot unify primitive constructors and custom constructors which have two heterogeneous signatures.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="title class_">Vue</span>.<span class="title function_">component</span>(<span class="string">&#x27;union-prop&#x27;</span>, &#123;</span><br><span class="line">  <span class="attr">props</span>: &#123;</span><br><span class="line">    <span class="attr">primitive</span>: [<span class="title class_">String</span>, <span class="title class_">Number</span>], <span class="comment">// both primitive, ok</span></span><br><span class="line">    <span class="attr">custom</span>: [<span class="title class_">Cat</span>, <span class="title class_">User</span>],         <span class="comment">// both custom, ok</span></span><br><span class="line">    <span class="attr">mixed</span>: [<span class="title class_">User</span>, <span class="title class_">Number</span>] <span class="keyword">as</span> &#123;<span class="title function_">new</span>(): <span class="title class_">User</span> | <span class="title class_">Number</span>&#125;[] <span class="comment">// requires annotation</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>In general, you should avoid mixing primitive type and object type.</p>
<h2 id="Final-words"><a href="#Final-words" class="headerlink" title="Final words"></a>Final words</h2><p>TypeScript has been constantly evolving since its birth. And finally its expressiveness enable us to type Vue‚Äôs cannonical API!</p>
<p>Thank you, TypeScript team, for bring us these awesome features!<br>Thank you, Vue team, for embracing new advance in type system!</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-flow-sensitive" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2017/02/04/flow-sensitive/">Grok control flow based analysis in TypeScript.</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2017-02-04T08:00:00.000Z" itemprop="datePublished">February 4, 2017, 12:00 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <h2 id="TL-DR"><a href="#TL-DR" class="headerlink" title="TL;DR:"></a>TL;DR:</h2><ol>
<li>Compiler does not understand control flow in closure &#x2F; callback function.</li>
<li>In flow based type analysis, copmiler will be either optimistic or pessimistic. TypeScript is optimistic.</li>
<li>You can usually workaround (3) by using <code>const</code> or <code>readonly</code></li>
</ol>
<p>This is a long due introduction for TypeScript‚Äôs flow sensitive typing (also known as control flow based type analysis) since its <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/wiki/What%27s-new-in-TypeScript#control-flow-based-type-analysis">2.0 release</a>. It is so unfortunate that no official documentation is in TypeScript‚Äôs website for it (while both <a target="_blank" rel="noopener" href="https://flowtype.org/docs/dynamic-type-tests.html#">flow</a> and <a target="_blank" rel="noopener" href="https://kotlinlang.org/docs/reference/typecasts.html#smart-casts">kotlin</a> have!). But if you dig the issue list earnestly enough, you will always find some <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/issues/9998">hidden gems</a> there!</p>
<p>To put it short, a variable‚Äôs type in a <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/Flow-sensitive_typing">flow sensitive type system</a> can change according to the control flow like <code>if</code> or <code>while</code>. For example, you can dynamically check the truthiness of  a nullable variable and if it isn‚Äôt null, compiler will automatically cast the variable type to non-null. Sweet?</p>
<p>What can be bitter here? TypeScript is an imperative language like JavaScript. The side-effectful nature prevents compiler from inferring control flow when function call kicks in. Let‚Äôs see an example.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">number</span> | <span class="literal">null</span> = <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">makeSideEffect</span>()</span><br><span class="line"></span><br><span class="line">a <span class="comment">// is a still a number?</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">makeSideEffect</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// omitted...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Without knowing what <code>makeSideEffect</code> is, we cannot guarantee variable <code>a</code> is still <code>number</code>. Side effect can be as innocuous and innocent as <code>console.log(&#39;the number of life&#39;, 42)</code>, or as evil as a billion dollar mistake like <code>a = null</code>, or even a control-flow entangler: <code>throw new Error(&#39;code unreachale&#39;)</code>.</p>
<p>One might ask compiler to infer what <code>makeSideEffect</code> does since we can provide the source of the function.<br>However this is not practically feasible because of <a target="_blank" rel="noopener" href="https://basarat.gitbooks.io/typescript/content/docs/types/ambient/intro.html">ambient function</a> and (possibly polymorphic) recursion. Compiler will be trapped in infinite loops if we instruct it to infer arbitrary deep functions, as <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/Halting_problem">halting problem</a> per se.</p>
<p>So a realistic compiler must guess what a function does by a consistent strategy. Naturally we have two alternatives:</p>
<ol>
<li>Assume every function does <strong>not</strong> have relevant side effect: e.g. assignment like <code>a = null</code>. We call this <strong>optimistic</strong>.</li>
<li>Assume every function <strong>does</strong> have side effect. We call this strategy <strong>pessimistic</strong>.</li>
</ol>
<p>Spoiler: TypeScript uses optimistic strategy.</p>
<p>We will walk through these two strategies and see how they work in practice.<br>But before that let‚Äôs see some common gotchas in flow sensitive typing.</p>
<h2 id="Closure-x2F-Callback"><a href="#Closure-x2F-Callback" class="headerlink" title="Closure &#x2F; Callback"></a>Closure &#x2F; Callback</h2><p>Flow sensitive typing does not play well with callback functions or closures. This is explicitly mentioned in <a target="_blank" rel="noopener" href="https://kotlinlang.org/docs/reference/typecasts.html#smart-casts">Kotlin‚Äôs document</a>.</p>
<blockquote>
<p>var local variables - if the variable is not modified between the check and the usage and is not captured in a lambda that modifies it;</p>
</blockquote>
<p>Consider the following example.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="attr">a</span>: <span class="built_in">string</span> | <span class="built_in">number</span> = <span class="number">42</span> <span class="comment">// smart cast to number</span></span><br><span class="line"><span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="keyword">typeof</span> a) <span class="comment">// what should be print?</span></span><br><span class="line">&#125;, <span class="number">100</span>)</span><br><span class="line">a = <span class="string">&#x27;string&#x27;</span></span><br></pre></td></tr></table></figure>

<p>As a developer, you can easily figure out that <code>string</code> will be output to console because <code>setTimeout</code> will call its function argument asynchronously, after assigning <code>string</code> to <code>a</code>. Unfortunately, this knowledge is not accessible to compiler. No keyword will tell compiler whether callback function will be called <em>immediately</em>, nor static analysis will tell the behavior of a function: <code>setTimeout</code> and <code>forEach</code> is the same in the view of compiler.</p>
<p>So the following example will not compile.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="attr">a</span>: <span class="built_in">string</span> | <span class="built_in">number</span> = <span class="number">42</span> <span class="comment">// smart cast to number</span></span><br><span class="line">someArray.<span class="title function_">forEach</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  a.<span class="title function_">toFixed</span>() <span class="comment">// error, string | number does not have method `toFixed`</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>Note: compiler will still inline control flow analysis for <a target="_blank" rel="noopener" href="https://developer.mozilla.org/en-US/docs/Glossary/IIFE">IIFE(Immediately Invoked Function Expression)</a>.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> <span class="attr">x</span>: <span class="built_in">string</span> | <span class="built_in">number</span> = <span class="string">&quot;OK&quot;</span>;</span><br><span class="line">(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  x = <span class="number">10</span>;</span><br><span class="line">&#125;)();</span><br><span class="line"><span class="keyword">if</span> (x === <span class="number">10</span>) &#123; <span class="comment">// OK, assignment in IIFE</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>In the future, we might have a keyword like <a target="_blank" rel="noopener" href="https://github.com/Microsoft/TypeScript/issues/11498"><code>immediate</code></a> to help compiler reasoning more about control flow. But that‚Äôs a different story.</p>
<p>Now let‚Äôs review the strategies for function call.</p>
<h2 id="Optimistic-Flow-Sensitive-Typing"><a href="#Optimistic-Flow-Sensitive-Typing" class="headerlink" title="Optimistic Flow Sensitive Typing"></a>Optimistic Flow Sensitive Typing</h2><p>Optimistic flow typing assume a function without side-effect that changes a variable‚Äôs type. TypeScript chooses this strategy in its implementation.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="attr">a</span>: <span class="built_in">number</span> | <span class="literal">null</span></span><br><span class="line">a = <span class="number">42</span> <span class="comment">// assign, now a is narrowed to type `number`</span></span><br><span class="line"><span class="title function_">sideEffect</span>() <span class="comment">// assume nothing happens here</span></span><br><span class="line">a.<span class="title function_">toFixed</span>() <span class="comment">// a still has `number` type</span></span><br></pre></td></tr></table></figure>

<p>This assumption usually works well if code observes immutable rule. On the other hand, a stateful program will be tolled with the tax of explicit casting. One typical example is scanner in a compiler. (Both Angular template compiler and TypeScript itself are victims).</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// suppose we are tokenizing an HTML like language</span></span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Token</span> &#123; <span class="title class_">LeftBracket</span>, <span class="title class_">WhiteSpace</span>, <span class="title class_">Letter</span> ... &#125;</span><br><span class="line"><span class="keyword">let</span> token = <span class="title class_">Token</span>.<span class="property">WhiteSpace</span>;</span><br><span class="line"><span class="keyword">function</span> <span class="title function_">nextToken</span>(<span class="params"></span>) &#123;</span><br><span class="line">    token = <span class="title function_">readInput</span>(); <span class="comment">// return a Token</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">scan</span>(<span class="params"></span>) &#123;</span><br><span class="line">  <span class="comment">// token here is WhiteSpace</span></span><br><span class="line">  <span class="keyword">while</span> (token === <span class="title class_">Token</span>.<span class="property">WhiteSpace</span>) &#123;</span><br><span class="line">    <span class="comment">// skip white space, a common scenario</span></span><br><span class="line">    <span class="title function_">nextToken</span>()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (token === <span class="title class_">Token</span>.<span class="property">LeftBracket</span>) &#123; <span class="comment">// error here</span></span><br><span class="line">    <span class="comment">// compiler thinks token is still WhiteSpace, optimistically but wrongly</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Such bad behavior also occurs on fields.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// A function takes a string and try to parse</span></span><br><span class="line"><span class="comment">// if success, modify the result parameter to pass result to caller</span></span><br><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> <span class="title function_">tryParse</span>(<span class="params">x: <span class="built_in">string</span>, result: &#123; success: <span class="built_in">boolean</span>; value: <span class="built_in">number</span>; &#125;</span>): <span class="built_in">void</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">myFunc</span>(<span class="params">x: <span class="built_in">string</span></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> result = &#123; <span class="attr">success</span>: <span class="literal">false</span>, <span class="attr">value</span>: <span class="number">0</span> &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="title function_">trySomething</span>(x, result);</span><br><span class="line">    <span class="keyword">if</span> (result.<span class="property">success</span> === <span class="literal">true</span>) &#123; <span class="comment">// error!</span></span><br><span class="line">        <span class="keyword">return</span> result.<span class="property">value</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>An alternative here is returning a new result object so we need no inline mutation. But in some performance sensitive code path might we want parse a string without new object allocation, which reduces garbage collection pressure. After all, mutation is legal in JavaScript code, but TypeScript fails to capture it.</p>
<p>Optimistic flow analysis sometimes is also unsound: a compiler verified program will cause runtime error. We can easily construct a function which reassigns a variable to an object of different type and uses it as of the original type, and thus a runtime error!</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> &#123; <span class="attr">a</span>: <span class="built_in">string</span>&#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">B</span> &#123; <span class="attr">b</span>: <span class="built_in">string</span>&#125;</span><br><span class="line"><span class="keyword">let</span> <span class="attr">ab</span>: A | B = <span class="keyword">new</span> A</span><br><span class="line"></span><br><span class="line"><span class="title function_">doEvil</span>()</span><br><span class="line">ab.<span class="property">b</span>.<span class="title function_">toString</span>() <span class="comment">// booooooom</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">doEvil</span>(<span class="params"></span>) &#123;</span><br><span class="line">  ab = <span class="keyword">new</span> B</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The above examples might leave to you a impression that compiler does much bad when doing optimistic control flow inference. In practice, however, a well architected program with disciplined control of side effect will not suffer much from compiler‚Äôs naive optimistism. <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/Presumption_of_innocence">Presumption of immutability innocence</a> will save you a lot type casting or variable rebinding found in pessimistic flow sensitive typing.</p>
<h2 id="Pessimistic-Flow-Sensitive-Typing"><a href="#Pessimistic-Flow-Sensitive-Typing" class="headerlink" title="Pessimistic Flow Sensitive Typing"></a>Pessimistic Flow Sensitive Typing</h2><p>A pessimistic flow analysis places <a target="_blank" rel="noopener" href="https://www.wikiwand.com/en/Burden_of_proof">burden of typing proof</a> on programmers.<br>Every function call will invalidate previous control flow based narrowing. (<em>Pessimistic</em> possibly has a negative connotation, <em>conservative</em> may be a better word here). Thus programmers have to re-prove variable types is matching with previous control flow analysis.</p>
<p>Examples in this section are crafted to be runnable under both TS and flow-type checker.<br>Note, only flow-type checker will produce error because flow is more pessimistic&#x2F;strict than TypeScript.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> <span class="title function_">log</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="built_in">void</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> <span class="attr">a</span>: <span class="built_in">number</span> | <span class="built_in">string</span> = <span class="number">42</span></span><br><span class="line"></span><br><span class="line"><span class="title function_">log</span>(a) <span class="comment">// invalidation!</span></span><br><span class="line"></span><br><span class="line">a.<span class="title function_">toFixed</span>() <span class="comment">// error, a&#x27;s type is reverted to `number | string`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// To work around it, you have to recheck the type of `a`</span></span><br><span class="line"><span class="keyword">typeof</span> a === <span class="string">&#x27;number&#x27;</span> &amp;&amp; a.<span class="title function_">toFixed</span>() <span class="comment">// works</span></span><br></pre></td></tr></table></figure>

<p>Alas, pessimistism also breaks fields. Example taken from <a target="_blank" rel="noopener" href="http://stackoverflow.com/questions/38531182/weird-method-cannot-be-called-on-possibly-null-undefined-value">stackoverflow</a>.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">declare</span> <span class="keyword">function</span> <span class="title function_">assert</span>(<span class="params">obj: <span class="built_in">any</span></span>): <span class="built_in">void</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TreeNode</span>&lt;V, E&gt; &#123;</span><br><span class="line">    <span class="attr">value</span>: V</span><br><span class="line">    <span class="attr">children</span>: <span class="title class_">Map</span>&lt;E, <span class="title class_">TreeNode</span>&lt;V,E&gt;&gt; | <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="title function_">constructor</span>(<span class="params">value: V</span>) &#123;</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">value</span> = value</span><br><span class="line">        <span class="variable language_">this</span>.<span class="property">children</span> = <span class="literal">null</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">accessChildren</span>(<span class="params">tree: TreeNode&lt;<span class="built_in">number</span>, <span class="built_in">string</span>&gt;</span>): <span class="built_in">void</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (tree.<span class="property">children</span> != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="title function_">assert</span>(<span class="literal">true</span>) <span class="comment">// negate type narrowing</span></span><br><span class="line">        tree.<span class="property">children</span>.<span class="title function_">forEach</span>(<span class="function">(<span class="params">v,k</span>) =&gt;</span> &#123;&#125;) <span class="comment">// error!</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>These false alarms root in the same problem as in optimistic strategy: compiler&#x2F;checker has no knowledge about a function‚Äôs side effect. To work with a pessimistic compiler, one has to assert&#x2F;check repeatedly so to guarantee no runtime error will occur. Indeed, this is a trade-off between runtime safety and code bloat.</p>
<h2 id="Workaround"><a href="#Workaround" class="headerlink" title="Workaround"></a>Workaround</h2><p>Sadly, no known panacea for flow sensitive typing. We can mitigate the problem by introducing more immutability.</p>
<h3 id="using-const"><a href="#using-const" class="headerlink" title="using const"></a>using <code>const</code></h3><p>Because a <code>const</code> identifier will never change its type.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> <span class="attr">a</span>: <span class="built_in">string</span> | <span class="built_in">number</span> = <span class="title function_">someAPICall</span>() <span class="comment">// smart cast to number</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> a === <span class="string">&#x27;string&#x27;</span>) &#123;</span><br><span class="line">  <span class="built_in">setTimeout</span>(<span class="function">() =&gt;</span> &#123;</span><br><span class="line">    a.<span class="title function_">substr</span>(<span class="number">0</span>) <span class="comment">// success, `const` identifier will not lose its narrrowed type</span></span><br><span class="line">  &#125;, <span class="number">100</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>And using <code>const</code> will provide you runtime safety or bypass pessimistic checker.</p>
<figure class="highlight ts"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">function</span> <span class="title function_">fn</span>(<span class="params">x: <span class="built_in">string</span> | <span class="literal">null</span></span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> y = x</span><br><span class="line">  <span class="keyword">function</span> <span class="title function_">assert</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="comment">// ... whatever</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (y !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="variable language_">console</span>.<span class="title function_">log</span>(y.<span class="title function_">substr</span>(<span class="number">0</span>)); <span class="comment">// no error, no crash</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The same should apply to <code>readonly</code>, but current TypeScript does not seem to support it.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Flow sensitive typing is an advanced type system feature. Working with control flow analysis smoothly requires programmers to control mutation effectively.</p>
<p>Keeping mutation control in your mind. Flow sensitive typing will not in your way but make a pathway to a safer code base!</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-how-to-write-copy-paste-friendly-code" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/11/05/how-to-write-copy-paste-friendly-code/">How to write copy-paste friendly code -- An introductory parody</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-11-05T07:00:00.000Z" itemprop="datePublished">November 5, 2016, 12:00 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>With the growing population of SOA (<a target="_blank" rel="noopener" href="https://www.reddit.com/r/shittyprogramming/comments/4jstef/how_long_does_it_takes_to_master_stack_overflow/">StackOverflow</a> <a target="_blank" rel="noopener" href="https://twitter.com/divineomega/status/695744177557106688">Oriented</a> <a target="_blank" rel="noopener" href="https://github.com/drathier/stack-overflow-import">Architecture</a>), keeping your code copy-paste friendly is becoming more and more important in demonstrating, developing and question answering.</p>
<p>You want your answer to be available instantly, free of fussy debugging. So copy-paste friendliness is a key property of your code robust enough to be ubiquitously runnable and, eventually, help you gain more reputation.</p>
<p>Adopting copy-paste style is amazing. Copy-paste boosts your productivity by freeing you from rumination on architecture complexity. Your boss will be happy with all the <a target="_blank" rel="noopener" href="http://www.itestra.de/fileadmin/Redaktion/Documents/07_itestra_measuring_productivity_using_lines_of_code.pdf">SLOC</a> you commit. Your colleagues will respect your absolute ownership of the magnificent, enigmatic, labyrinthine code artifact built by the blob gleaned from everywhere.</p>
<h1 id="1-Always-prefer-‚Äú-x3D-x3D-‚Äù-to-strict-equality"><a href="#1-Always-prefer-‚Äú-x3D-x3D-‚Äù-to-strict-equality" class="headerlink" title="1. Always prefer ‚Äú&#x3D;&#x3D;‚Äù to strict equality."></a>1. Always prefer ‚Äú&#x3D;&#x3D;‚Äù to strict equality.</h1><p>Implicit conversion grants you additional robustness. Your code will never complain about ill input. Copy-paste without worry. Yeah</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x = <span class="string">&#x27;10&#x27;</span></span><br><span class="line"><span class="keyword">if</span> (x == <span class="number">10</span>) x += <span class="number">5</span></span><br><span class="line">y = x / <span class="number">5</span> <span class="comment">// wow, it works!</span></span><br></pre></td></tr></table></figure>

<p>And you can enjoy this artistic <a target="_blank" rel="noopener" href="https://dorey.github.io/JavaScript-Equality-Table/">equality table</a> when debugging. Cool.</p>
<img src="/images/comparison.png" class="">

<h2 id="2-Always-prefer-positive-condition"><a href="#2-Always-prefer-positive-condition" class="headerlink" title="2. Always prefer positive condition."></a>2. Always prefer positive condition.</h2><p>Never return early on invalid case. You can copy-paste it any where in your control flow. Yeah.</p>
<p>If <code>return</code> is added, you have to remove the unnecessary control flow abrupting keyword when you need to copy paste these code into a deeply nested code block, which is quite common in CPS(copy-paste-style) programming.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">function</span> <span class="title function_">someFunction</span>(<span class="params">someCondition</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (someCondition) &#123;</span><br><span class="line">    <span class="comment">// Do whatever you want</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="3-Always-prefer-tautological-check"><a href="#3-Always-prefer-tautological-check" class="headerlink" title="3. Always prefer tautological check."></a>3. Always prefer tautological check.</h2><p>Repetition here is for genericity. Every conditional path can be copy-pasted free of reading. They are very safe compile time constructs that preclude the very possibility of runtime <code>undefined</code> panic.</p>
<p><code>else</code> on individual line is a bonus. You can copy-and paste code without looking at <code>else</code> keyword! What a profit!</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (a &amp;&amp; a.<span class="property">b</span> &amp;&amp; a.<span class="property">b</span>.<span class="property">c</span> == <span class="number">1</span>) &#123;</span><br><span class="line">  <span class="comment">// never worried about a.b.c is not undefined</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> (a &amp;&amp; a.<span class="property">b</span> &amp;&amp; a.<span class="property">b</span>.<span class="property">c</span> == <span class="number">2</span>) &#123;</span><br><span class="line">  <span class="comment">// repition is one aesthetic rule</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="keyword">if</span> (a &amp;&amp; a.<span class="property">b</span> &amp;&amp; a.<span class="property">b</span>.<span class="property">c</span> == <span class="number">3</span>) &#123;</span><br><span class="line">  <span class="comment">// very safe even programmer inadvertedly paste it to elsewhere</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h2 id="4-Always-prefer-fully-qualified-name"><a href="#4-Always-prefer-fully-qualified-name" class="headerlink" title="4. Always prefer fully qualified name"></a>4. Always prefer fully qualified name</h2><p>Never cache common subexpression. Declaring new variable name will force you read code and find declaration before copy-pasting.</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">topVariable.<span class="property">someProperty</span>.<span class="property">nestedProp</span>.<span class="property">anotherProp</span> = <span class="number">123</span></span><br><span class="line"><span class="variable language_">console</span>.<span class="title function_">log</span>(topVariable.<span class="property">someProperty</span>.<span class="property">nestedProp</span>.<span class="property">anotherProp</span>)</span><br><span class="line">topVariable.<span class="property">someProperty</span>.<span class="property">nestedProp</span>.<span class="property">anotherProp</span> += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h2 id="5-Always-prefer-inlining-statements-in-function"><a href="#5-Always-prefer-inlining-statements-in-function" class="headerlink" title="5. Always prefer inlining statements in function"></a>5. Always prefer inlining statements in function</h2><p>Never factor out functions. Helpers require nonlocal function name lookup when copy-pasting. Dev experience terminator.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Oh, GG. I forgot GitHub Gists!</p>

      
    </div>
    
    
    
  </div>
</article>



  
    <article id="post-how-to-choose-vue-library" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="name">
      <a href="/2016/11/01/how-to-choose-vue-library/">Compare TypeScript libraries for Vue -- a review</a>
      
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-11-01T07:00:00.000Z" itemprop="datePublished">November 1, 2016, 12:00 AM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <p>Vue has a lot of TypeScript  binding libraries. A lot of.</p>
<p>They look similar, with subtle difference. How to choose one?</p>
<p>Here I compare three libraries.</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://libraries.io/npm/vue-typescript-component">vue-typescript-component</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/vuets/vuets">vuets</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/HerringtonDarkholme/av-ts/">av-ts</a></li>
</ul>
<p>They are representative, and the analysis probably also applies to the <a target="_blank" rel="noopener" href="https://github.com/vuejs/vue-class-component">official library</a>.</p>
<blockquote>
<p>Disclaimer: I‚Äôm the author of av-ts. So this article is probably biased. But I tried my best to give an objective review.</p>
</blockquote>
<h3 id="0-Overview"><a href="#0-Overview" class="headerlink" title="0. Overview"></a>0. Overview</h3><p>Vue-typescript-component and av-ts are decorator based libraries. Vue-typescript-component is more like the popular typescript <a target="_blank" rel="noopener" href="https://github.com/itsFrank/vue-typescript">library</a>, but supports Vue2.0. av-ts is my own library, crated after I read many alternatives.<br>vuets is quite different. It resembles the original object literal style API from vue.js.<br>Before I start the review, I want to state a rule of thumb before.</p>
<blockquote>
<p>The more flexiblity a library boasts, the harder for a type checker to verify it.</p>
</blockquote>
<p>It is quite common in programming world. For example, JavaScript is very flexible and dynamic, but it is usually hard to determine whether a property access is legal. Java is a static language, <code>javac</code> can help you check many pernicious typos in code, but Java cannot easily do reflective programming.</p>
<p>Vue has a very flexible and elegant API, but it comes <a href="http://herringtondarkholme.github.io/2016/08/21/vue-ts/">at the cost of type safety</a>. That‚Äôs why all these Vue TypeScript libraries exist. How to balance between expressiveness and type safety is the main concern of such a library.</p>
<h3 id="1-Compatibility"><a href="#1-Compatibility" class="headerlink" title="1. Compatibility"></a>1. Compatibility</h3><p>All the three libraries, vue-typescript-component, vuets and av-ts, have good support for Vue2 and TS2. So there is not much to compare here. (vuets has vue1.0 support while the other two do not)</p>
<h3 id="2-Extensibility"><a href="#2-Extensibility" class="headerlink" title="2. Extensibility"></a>2. Extensibility</h3><p>I think this is the best part of av-ts. av-ts provides a <code>Component.register</code> for custom decorator. For example, if you want to use vuex in your project but also want to preserve type safety, you can create your own decorator. This is exactly what I do in <a target="_blank" rel="noopener" href="https://github.com/HerringtonDarkholme/kilimanjaro">kilimanjaro</a>, a typed vuex fork.<br>vue-ts-copmonent does not provide extensibility at all. vue-ts has the same extensibility as original vue because it uses object literal style (that is, the most extensible one among the three). However, vuets also support class component like syntax. Mixing two style is somewhat confusing.</p>
<h3 id="3-Idiom"><a href="#3-Idiom" class="headerlink" title="3. Idiom"></a>3. Idiom</h3><p>av-ts and vue-ts-component are both idiomatic TypeScript code. class&#x2F;property&#x2F;component just feel like plain-old-typescript. vue-ts chooses object literal style API. While it looks the most similar to original vue, it is not as idiomatic as the other two in TypeScript land. Also, object literal style requires many manual typing annotation, which feels foreign to both JavaScript and TypeScript.</p>
<h3 id="4-Conciseness"><a href="#4-Conciseness" class="headerlink" title="4.Conciseness"></a>4.Conciseness</h3><p>vue-ts is the most verbose as mentioned above. Object literal style API is almost impossible to have good type inference for contemporary compilers. You can read more about it <a href="http://herringtondarkholme.github.io/2016/08/21/vue-ts/">here</a>. Basically I don‚Äôt think vue-ts is an ideal approach.<br>av-ts and vue-ts-component are concise. Most methods&#x2F;properties require only annotating once. av-ts requires more decorators for special methods like render and lifecycle, while it has a more concise and type safe property syntax. So I think this is a tie.</p>
<h3 id="5-Type-Safety"><a href="#5-Type-Safety" class="headerlink" title="5. Type Safety"></a>5. Type Safety</h3><p>av-ts and vue-ts-component can inject Vue‚Äôs native types by <code>extends Vue</code>. Neat. vuets users have to re-annotate all the method again, <a href="http://herringtondarkholme.github.io/2016/08/21/vue-ts/">alas</a>. av-ts has more type safety when defining special methods like <code>render</code>, <code>lifecycle</code> and <code>transition</code>. This is powerer by new decorators introduced. Again, these decorators are created by <code>Component.register</code> and the implementation is not hard-coded into one file.</p>
<h3 id="6-Expressiveness"><a href="#6-Expressiveness" class="headerlink" title="6. Expressiveness"></a>6. Expressiveness</h3><p>vuets is as expressive as original vue, at the cost of more annotation. vue-ts-component can express most basic API in vue, but there is something it cannot. av-ts can use <a target="_blank" rel="noopener" href="https://github.com/HerringtonDarkholme/av-ts#mixin">mixin</a> and can <a target="_blank" rel="noopener" href="https://github.com/HerringtonDarkholme/av-ts#data">use props in data method</a>. I have thought over these scenarios before hand.</p>
<h3 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h3><p>av-ts may not be the best component library for vue, but I believe it strikes the sweet point between conciseness, type safety and expressiveness. I‚Äôm happy to see more TS+Vue users try it out, and give me feedback so it can become better.</p>

      
    </div>
    
    
    
  </div>
</article>



  


  <nav id="page-nav" class="page-nav">
    
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/">Next ¬ª</a>
  </nav>



    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
