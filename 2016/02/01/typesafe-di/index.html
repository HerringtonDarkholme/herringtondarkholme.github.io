<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>TypeSafe DI in TypeScript | Abitrarily Idiosyncratic Randomness</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/css/highlight.css">

  
  <meta name="description" content="Yet Another Type Level Arithmetics  DI is getting more popularity in JavaScript. Though, those solution is far way beyond JSR-330 compatible libraries in terms of type safety and performance. This">
<meta property="og:type" content="article">
<meta property="og:title" content="TypeSafe DI in TypeScript">
<meta property="og:url" content="https://herringtondarkholme.github.io/2016/02/01/typesafe-di/index.html">
<meta property="og:site_name" content="Abitrarily Idiosyncratic Randomness">
<meta property="og:description" content="Yet Another Type Level Arithmetics  DI is getting more popularity in JavaScript. Though, those solution is far way beyond JSR-330 compatible libraries in terms of type safety and performance. This">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://herringtondarkholme.github.io/images/miku805.jpg">
<meta property="article:published_time" content="2016-02-02T03:26:14.000Z">
<meta property="article:modified_time" content="2023-05-01T23:53:03.878Z">
<meta property="article:author" content="Herrington Darkholme">
<meta property="article:tag" content="TypeScript">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://herringtondarkholme.github.io/images/miku805.jpg"><meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="wrapper">
    <header id="header">
  <h1 id="title">
    <a href="/">Abitrarily Idiosyncratic Randomness</a>
  </h1>
  <nav>
    
    
      
      <a class="nav-link" href="/">Home</a>
    
      
        <span class="nav-spacer">×</span>
      
      <a class="nav-link" href="/archives">Archives</a>
    
    
  </nav>
</header>

    <div id="content">
      <article id="post-typesafe-di" class="article article-type-post" itemprop="blogPost" itemscope>
  <div class="article-inner">
    
      <header class="article-header">
        
  
    <h2 class="article-title" itemprop="headline name">
      TypeSafe DI in TypeScript
    </h2>
  


        <div class="article-meta">
          <time class="article-date" datetime="2016-02-02T03:26:14.000Z" itemprop="datePublished">February 1, 2016, 7:26 PM</time>

          
        </div>
      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
      
        <img src="/images/miku805.jpg" class="">

<blockquote>
<p>Yet Another Type Level Arithmetics</p>
</blockquote>
<p>DI is getting more popularity in JavaScript. Though, those solution is far way beyond JSR-330 compatible libraries in terms of type safety and performance.</p>
<p>This snippet strives to dig more type-safety from TS’ type system. However, it can hardly achieve equivalent type safety like Java’s counterpart, e.g., Dagger, Guice.</p>
<h2 id="Solution"><a href="#Solution" class="headerlink" title="Solution"></a>Solution</h2><p><a target="_blank" rel="noopener" href="https://gist.github.com/HerringtonDarkholme/f11152e6e29145040fa4">This DI</a> snippet can, ideally, ensure every binding is resolved in compile time, which is a hard task for other DI solution. The main idea is an <code>Injector</code> can statically know its current binding, and judge whether dependencies of a new added binding can be already resolved by itself. Since dependency graph is a DAG, there exists a topological sorting order that every binding’s dependency can be resolved solely by those of preceding bindings . So once the injector is created and bindings are attached to it, we can assert that the dependencies can be resolved.</p>
<p>Say, there is a minimal example to illustrate this:</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Clerk</span> &#123;&#125;</span><br><span class="line"><span class="meta">@Inject</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Shop</span> &#123;<span class="title function_">constructor</span>(<span class="params">c: Clerk</span>)&#125;</span><br><span class="line"><span class="keyword">var</span> inj = <span class="title class_">Injector</span>.<span class="title function_">create</span>()</span><br><span class="line">  .<span class="title function_">bind</span>(<span class="title class_">Shop</span>).<span class="title function_">toClass</span>(<span class="title class_">Shop</span>) <span class="comment">// compile error here, injector cannot resolve Clerk</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> inj = <span class="title class_">Injector</span>.<span class="title function_">create</span>()</span><br><span class="line">  .<span class="title function_">bind</span>(<span class="title class_">Clerk</span>).<span class="title function_">toClass</span>(<span class="title class_">Clerk</span>)</span><br><span class="line">  .<span class="title function_">bind</span>(<span class="title class_">Shop</span>).<span class="title function_">toClass</span>(<span class="title class_">Shop</span>) <span class="comment">// compiles. Clerk resolved before Shop</span></span><br></pre></td></tr></table></figure>

<p>To implement this, Injector has a shadow type <code>Base</code> that indicates resolved bindings. When new binding is added to injector, compiler will verify the new coming constructor&#x2F;function will only depend on classes the injector has already resolved. Concretely, every argument in newly added constructor must be a subtype of <code>Base</code>.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> <span class="title class_">Ctor</span> = <span class="keyword">new</span> (...<span class="attr">args</span>: <span class="title class_">Base</span>[]): T</span><br><span class="line"></span><br><span class="line">injector&lt;<span class="title class_">Base</span>&gt;</span><br><span class="line">  .<span class="title function_">bind</span>(<span class="title class_">NewClass</span>)</span><br><span class="line">  .<span class="title function_">toClass</span>(<span class="title class_">NewClass</span> <span class="keyword">as</span> <span class="title class_">Ctor</span>)</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Make sure here `toClass` is defined like</span></span><br><span class="line"><span class="comment">type toClass = (Ctor) =&gt; Injector&lt;Base | T&gt;</span></span><br><span class="line"><span class="comment">the union type indicates resolved type, and `T extends Base|T` holds valid</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p><code>Base</code> is a large union type storing all binding types, so every resolved type is a subtype of <code>Base</code>. And <code>bind</code> will return a <code>binder</code> that has <code>toClass / toFactory</code> method which further returns an injector whose resolved binding is a union of the previous binding type and the newly added binding type. Hence, after <code>bind ... toClass</code>, the injector has a new class appended to its resolved type list.</p>
<p>The implementation and test can be found at <a target="_blank" rel="noopener" href="https://gist.github.com/HerringtonDarkholme/f11152e6e29145040fa4">Github Gist</a>.</p>
<h2 id="Problem"><a href="#Problem" class="headerlink" title="Problem"></a>Problem</h2><p>But TS’ type system does not allow a full-fledged DI in this way.</p>
<ol>
<li><p>First, runtime types are erased. One must annotate dependency for function in <code>toFactory</code> method. <code>toClass</code> is better because TS supports <code>emitDecoratorMetadata</code>. (maybe resolved in TS2.0). TS’ specific metadata implementation is also problematic. For cyclic dependent classes, at least one class’ annotation is <code>undefined</code>(ES3&#x2F;5), or the script is crashed before it can run (ES6). Because metadata is attached to class declaration, in cyclic case there must be one class is used before it’s declared.</p>
</li>
<li><p>TypeScript has a double-edged sutructural type system. To fully exploit DI’s type check, user has to add a <code>private</code> <code>brand</code> field to every injectable class. This is not a good UI, though.</p>
</li>
<li><p>But even metadata is not enough. Runtime type data is first-order (in type-system’s view), that is, every type is represented by its constructor, no generic information is emitted. To work around this, token is introduced.</p>
</li>
</ol>
<p>Token alleviates runtime type-system’s weakness, and enables binding multiple implementations to one single type. It also introduces more problem this DI wants to resolve in the first place. To work around point 1, we attached runtime types to constructor. Binding token will make type system think a type has resolved, but a following binding may not resolve it in runtime because it depends on constructor to find resolution.</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">injector</span><br><span class="line">  .<span class="title function_">bind</span>(clerkToken).<span class="title function_">toClass</span>(<span class="title class_">Clerk</span>)</span><br><span class="line">  .<span class="title function_">bind</span>(<span class="title class_">Shop</span>).<span class="title function_">toClass</span>(<span class="title class_">Shop</span>) <span class="comment">// compiles. but runtime error</span></span><br><span class="line"><span class="comment">// toClass will analyze Shop&#x27;s signature and extract the Clerk constructor</span></span><br><span class="line"><span class="comment">// it can be found in type-level because Token&lt;Clerk&gt; enable injector to resolve Clerk, but at runtime injector can only resolve clerkToken, not Clerk</span></span><br></pre></td></tr></table></figure>

<p>Also, tokens with same types cannot avoid this.</p>
<p>The workaround is, well, abusing string literal type. So every token is different at type-level. This requires users to type more types, and casts string literal from string type to string literal type. (TS’s generic inference does not have something like <code>T extends StringLiteral</code> so that <code>T</code> is inferred as string literal type)</p>
<p>Also, the <code>toClass</code> and <code>toFactory</code> signature should differentiate what can be resolved by constructor and by token.  This is technically possible, just override these signature to support distinguishing between token and constructor. But the number of resulting overriding is exponential to the number of argument. 2 ^ n, where n is the number of arguments.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>To fully support type-safe DI and higher performance, a compiler extension or a code generator is needed. Java’s DI relies on annotations and code generation.</p>
<p>Maybe Babel can do this right now. But TypeScript still needs a long way to go for a customizable emitter.</p>
<h2 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h2><figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">&#x27;reflect-metadata&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> _ = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> <span class="title class_">ClassN</span>&lt;N, T&gt; = &#123; <span class="keyword">new</span> (...<span class="attr">a</span>: N[]): T &#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">FN8</span>&lt;A, B, C, D, E, F, G, H, R&gt; = <span class="function">(<span class="params">a?: A, b?: B, c?: C, d?: D, e?: E, f?: F, g?: G, h?: H</span>) =&gt;</span> R</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">CLS8</span>&lt;A, B, C, D, E, F, G, H, R&gt; = &#123; <span class="keyword">new</span> (a?: A, b?: B, c?: C, d?: D, e?: E, f?: F, g?: G, h?: H): R&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Token</span>&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> _tokenBrand</span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">public</span> name: <span class="built_in">string</span></span>) &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">type</span> <span class="title class_">Bindable</span>&lt;T&gt; = <span class="title class_">Token</span>&lt;T&gt; | <span class="title class_">ClassN</span>&lt;_, T&gt;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="variable constant_">PARAMTYPE</span> = <span class="string">&#x27;design:paramtypes&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">function</span> getSignature&lt;T&gt;(<span class="attr">cls</span>: <span class="title class_">ClassN</span>&lt;T, _&gt;): <span class="title class_">Array</span>&lt;<span class="title class_">Bindable</span>&lt;T&gt;&gt; &#123; <span class="keyword">return</span> <span class="title class_">Reflect</span>.<span class="title function_">getOwnMetadata</span>(<span class="variable constant_">PARAMTYPE</span>, cls).<span class="title function_">slice</span>() || [] &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">enum</span> <span class="title class_">BindType</span> &#123; <span class="variable constant_">CLASS</span>, <span class="variable constant_">VALUE</span>, <span class="variable constant_">FACTORY</span> &#125;</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Binder</span>&lt;T, <span class="title class_">Base</span>&gt; &#123;</span><br><span class="line">  <span class="attr">dependencies</span>: <span class="title class_">Bindable</span>&lt;<span class="title class_">Base</span>&gt;[] = []</span><br><span class="line">  <span class="attr">cacheable</span>: <span class="built_in">boolean</span> = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_type</span>: <span class="title class_">BindType</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_cls</span>: <span class="title class_">ClassN</span>&lt;<span class="built_in">any</span>, T&gt; = <span class="literal">null</span></span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_val</span>: T</span><br><span class="line">  <span class="keyword">private</span> <span class="attr">_fn</span>: <span class="title class_">Function</span></span><br><span class="line"></span><br><span class="line">  <span class="title function_">constructor</span>(<span class="params"><span class="keyword">private</span> _injector: Injector&lt;Base&gt;</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="title function_">_releaseInjector</span>(<span class="params"></span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> injector = <span class="variable language_">this</span>.<span class="property">_injector</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_injector</span> = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">return</span> injector</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toClass&lt;A <span class="keyword">extends</span> <span class="title class_">Base</span>, B <span class="keyword">extends</span> <span class="title class_">Base</span>, C <span class="keyword">extends</span> <span class="title class_">Base</span>, D <span class="keyword">extends</span> <span class="title class_">Base</span>, E <span class="keyword">extends</span> <span class="title class_">Base</span>, F <span class="keyword">extends</span> <span class="title class_">Base</span>, G <span class="keyword">extends</span> <span class="title class_">Base</span>, H <span class="keyword">extends</span> <span class="title class_">Base</span>&gt;(<span class="attr">fn</span>: <span class="title class_">CLS8</span>&lt;A, B, C,  D, E, F, G, H, T&gt;, a?: <span class="title class_">Bindable</span>&lt;A&gt;, b?: <span class="title class_">Bindable</span>&lt;B&gt;, c?: <span class="title class_">Bindable</span>&lt;C&gt;, d?: <span class="title class_">Bindable</span>&lt;D&gt;, e?: <span class="title class_">Bindable</span>&lt;E&gt;, f?: <span class="title class_">Bindable</span>&lt;F&gt;, g?: <span class="title class_">Bindable</span>&lt;G&gt;, h?: <span class="title class_">Bindable</span>&lt;H&gt;): <span class="title class_">Injector</span>&lt;<span class="title class_">Base</span> | T&gt;</span><br><span class="line">  <span class="title function_">toClass</span>(<span class="attr">cls</span>: <span class="title class_">ClassN</span>&lt;<span class="title class_">Base</span>, T&gt;, ...<span class="attr">deps</span>: <span class="title class_">Bindable</span>&lt;<span class="title class_">Base</span>&gt;[]): <span class="title class_">Injector</span>&lt;<span class="title class_">Base</span> | T&gt; &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_type</span> = <span class="title class_">BindType</span>.<span class="property">CLASS</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_cls</span> = cls</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dependencies</span> = <span class="title function_">getSignature</span>(cls)</span><br><span class="line">    deps.<span class="title function_">forEach</span>(<span class="function">(<span class="params">d, i</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (d) <span class="variable language_">this</span>.<span class="property">dependencies</span>[i] = d</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_releaseInjector</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">toValue</span>(<span class="attr">val</span>: T): <span class="title class_">Injector</span>&lt;<span class="title class_">Base</span> | T&gt; &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_type</span> = <span class="title class_">BindType</span>.<span class="property">VALUE</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_val</span> = val</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">cacheable</span> = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_releaseInjector</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toFactory&lt;A <span class="keyword">extends</span> <span class="title class_">Base</span>, B <span class="keyword">extends</span> <span class="title class_">Base</span>, C <span class="keyword">extends</span> <span class="title class_">Base</span>, D <span class="keyword">extends</span> <span class="title class_">Base</span>, E <span class="keyword">extends</span> <span class="title class_">Base</span>, F <span class="keyword">extends</span> <span class="title class_">Base</span>, G <span class="keyword">extends</span> <span class="title class_">Base</span>, H <span class="keyword">extends</span> <span class="title class_">Base</span>&gt;(<span class="attr">fn</span>: <span class="title class_">FN8</span>&lt;A, B, C,  D, E, F, G, H, T&gt;, a?: <span class="title class_">Bindable</span>&lt;A&gt;, b?: <span class="title class_">Bindable</span>&lt;B&gt;, c?: <span class="title class_">Bindable</span>&lt;C&gt;, d?: <span class="title class_">Bindable</span>&lt;D&gt;, e?: <span class="title class_">Bindable</span>&lt;E&gt;, f?: <span class="title class_">Bindable</span>&lt;F&gt;, g?: <span class="title class_">Bindable</span>&lt;G&gt;, h?: <span class="title class_">Bindable</span>&lt;H&gt;): <span class="title class_">Injector</span>&lt;<span class="title class_">Base</span> | T&gt;</span><br><span class="line">  <span class="title function_">toFactory</span>(<span class="attr">fn</span>: <span class="function">(<span class="params">...a: Base[]</span>) =&gt;</span> T, ...<span class="attr">deps</span>: <span class="title class_">Bindable</span>&lt;<span class="title class_">Base</span>&gt;[]): <span class="title class_">Injector</span>&lt;<span class="title class_">Base</span> | T&gt; &#123;</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_type</span> = <span class="title class_">BindType</span>.<span class="property">FACTORY</span></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_fn</span> = fn</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">dependencies</span> = deps</span><br><span class="line">    <span class="keyword">return</span> <span class="variable language_">this</span>.<span class="title function_">_releaseInjector</span>()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="title function_">resolve</span>(<span class="attr">deps</span>: <span class="built_in">any</span>[]): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable language_">this</span>.<span class="property">_type</span>) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">BindType</span>.<span class="property">CLASS</span>:</span><br><span class="line">        <span class="keyword">let</span> cls = <span class="variable language_">this</span>.<span class="property">_cls</span></span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="keyword">new</span> <span class="title function_">cls</span>(...deps))</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">BindType</span>.<span class="property">VALUE</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="property">_val</span>)</span><br><span class="line">      <span class="keyword">case</span> <span class="title class_">BindType</span>.<span class="property">FACTORY</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="title class_">Promise</span>.<span class="title function_">resolve</span>(<span class="variable language_">this</span>.<span class="title function_">_fn</span>(...deps))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">class</span> <span class="title class_">Injector</span>&lt;<span class="title class_">Base</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> _resolving = <span class="keyword">new</span> <span class="title class_">Set</span>&lt;<span class="title class_">Bindable</span>&lt;_&gt;&gt;()</span><br><span class="line">  <span class="keyword">private</span> _typeBinderMap = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="title class_">Bindable</span>&lt;_&gt;, <span class="title class_">Binder</span>&lt;_, <span class="title class_">Base</span>&gt;&gt;()</span><br><span class="line">  <span class="keyword">private</span> _cache = <span class="keyword">new</span> <span class="title class_">Map</span>&lt;<span class="title class_">Bindable</span>&lt;_&gt;, <span class="title class_">Promise</span>&lt;<span class="built_in">any</span>&gt;&gt;()</span><br><span class="line"></span><br><span class="line">  get&lt;T <span class="keyword">extends</span> <span class="title class_">Base</span>&gt;(<span class="attr">cls</span>: <span class="title class_">Bindable</span>&lt;T&gt;): <span class="title class_">Promise</span>&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> binder = <span class="variable language_">this</span>.<span class="property">_typeBinderMap</span>.<span class="title function_">get</span>(cls)</span><br><span class="line">    <span class="keyword">if</span> (!binder) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NoBinding</span>(cls[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> cache = binder.<span class="property">cacheable</span> ? <span class="variable language_">this</span>.<span class="property">_cache</span>.<span class="title function_">get</span>(cls) : <span class="literal">null</span></span><br><span class="line">    <span class="keyword">if</span> (cache) &#123;</span><br><span class="line">      <span class="keyword">return</span> cache</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="variable language_">this</span>.<span class="property">_resolving</span>.<span class="title function_">has</span>(cls)) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">CyclicDependency</span>(cls[<span class="string">&#x27;name&#x27;</span>])</span><br><span class="line"></span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_resolving</span>.<span class="title function_">add</span>(cls)</span><br><span class="line">    <span class="keyword">let</span> depPromise = binder.<span class="property">dependencies</span>.<span class="title function_">map</span>(<span class="function"><span class="params">dep</span> =&gt;</span> <span class="variable language_">this</span>.<span class="title function_">get</span>(dep))</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_resolving</span>.<span class="title function_">delete</span>(cls)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> ret = <span class="title class_">Promise</span>.<span class="title function_">all</span>(depPromise).<span class="title function_">then</span>(<span class="function"><span class="params">args</span> =&gt;</span> binder.<span class="title function_">resolve</span>(args))</span><br><span class="line">    <span class="keyword">if</span> (binder.<span class="property">cacheable</span>) <span class="variable language_">this</span>.<span class="property">_cache</span>.<span class="title function_">set</span>(cls, ret)</span><br><span class="line">    <span class="keyword">return</span> ret</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  bind&lt;T&gt;(<span class="attr">cls</span>: <span class="title class_">Bindable</span>&lt;T&gt;): <span class="title class_">Binder</span>&lt;T, <span class="title class_">Base</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> binder = <span class="keyword">new</span> <span class="title class_">Binder</span>&lt;T, <span class="title class_">Base</span>&gt;(<span class="variable language_">this</span>)</span><br><span class="line">    <span class="variable language_">this</span>.<span class="property">_typeBinderMap</span>.<span class="title function_">set</span>(cls, binder)</span><br><span class="line">    <span class="keyword">return</span> binder</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="title function_">create</span>(): <span class="title class_">Injector</span>&lt;<span class="title class_">Injector</span>&lt;_&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> inj = <span class="keyword">new</span> <span class="title class_">Injector</span>&lt;<span class="title class_">Injector</span>&lt;_&gt;&gt;()</span><br><span class="line">    inj.<span class="title function_">bind</span>(<span class="title class_">Injector</span>).<span class="title function_">toValue</span>(inj)</span><br><span class="line">    <span class="keyword">return</span> inj</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

      
    </div>
    
    
    <div class="article-category">
      
      
      
        <b>Tags:</b>
        <a class="article-tag-none-link" href="/tags/TypeScript/" rel="tag">TypeScript</a>
      
    </div>
    
    
  </div>
</article>

  
<nav id="article-nav" class="article-nav">
  
    <a href="/2016/02/26/dein/" id="article-nav-newer" class="article-nav-link-wrap newer">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Trying out dein.vim -- a dark powered plugin manager
        
      </div>
    </a>
  
  
    <a href="/2015/12/06/rplugin-notfound/" id="article-nav-older" class="article-nav-link-wrap older">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">
        
          Trouble Shooting NeoVim&#39;s rplugin not found
        
      </div>
    </a>
  
</nav>






    </div>
  </div>
  




<div id="settings-container">
  <div id="dark-mode">dark</div>
  <div id="sans-font">sans</div>
</div>
<script type="text/javascript">
let d=document,r=d.documentElement.style,f=r.setProperty.bind(r),l=localStorage,s=l.getItem('s')||(window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches),n=l.getItem('n'),m=d.getElementById("dark-mode"),b=()=>{f('--bg-color','#fafafa');f('--code-bg-color','#f4f4f4');f('--text-color','#212121');f('--secondary-color','#808080');f('--tertiary-color','#b0b0b0');f('--link-color','#b5c8cf');f('--link-hover-color','#618794');f('--link-bg-color','#dae4e7');f('--selection-color','#dae4e7');m.innerHTML="dark"},c=()=>{f('--bg-color','#212121');f('--code-bg-color','#292929');f('--text-color','#fff');f('--secondary-color','#c0c0c0');f('--tertiary-color','#6e6e6e');f('--link-color','#4d6b75');f('--link-hover-color','#96b1bb');f('--link-bg-color','#5d828e');f('--selection-color','#acc1c9');m.innerHTML="light"},o=d.getElementById("sans-font"),e=()=>{f('--body-stack','"Lora", "Georgia", "Times New Roman", serif');o.innerHTML="sans"},g=()=>{f('--body-stack','"Lato", "Lucida Grande", "Lucida Sans Unicode", "Lucida Sans", "Verdana", sans-serif');o.innerHTML="serif"};m.onclick=()=>{if(s==2){s=1;l.setItem('s',s);c()}else{s=2;l.setItem('s',s);b()}};o.onclick=()=>{if(n==2){n=1;l.setItem('n',n);g()}else{n=2;l.setItem('n',n);e()}};if(!s){s=2;l.setItem('s',2)};if(s==1){c()};if(!n){n=2;l.setItem('n',2)};if(n==1){g()};
</script>




</body>
</html>
